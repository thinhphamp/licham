This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.claude/
  plans/
    ios-lunar-calendar-app/
      reports/
        01-research-report.md
      phase-01-project-setup.md
      phase-02-lunar-calendar-core.md
      phase-03-calendar-ui.md
      phase-04-features.md
      phase-05-polish-release.md
      plan.md
  settings.local.json
docs/
  code-standards.md
  codebase-summary.md
  project-overview-pdr.md
  system-architecture.md
src/
  app/
    (tabs)/
      _layout.tsx
      events.tsx
      index.tsx
      settings.tsx
    day/
      [date].tsx
    event/
      [id].tsx
      new.tsx
    _layout.tsx
    +html.tsx
    +not-found.tsx
  assets/
    fonts/
      SpaceMono-Regular.ttf
    images/
      adaptive-icon.png
      favicon.png
      icon.png
      splash-icon.png
    sounds/
      notification.wav
  components/
    __tests__/
      StyledText-test.js
    calendar/
      AuspiciousHoursGrid.tsx
      CalendarView.tsx
      DayCell.tsx
      DayDetailModal.tsx
    common/
      AccessibleText.tsx
      Button.tsx
      Header.tsx
      Modal.tsx
    events/
      EventCard.tsx
      EventForm.tsx
      EventList.tsx
    EditScreenInfo.tsx
    ExternalLink.tsx
    StyledText.tsx
    Themed.tsx
    useClientOnlyValue.ts
    useClientOnlyValue.web.ts
    useColorScheme.ts
    useColorScheme.web.ts
  constants/
    Colors.ts
    holidays.ts
    theme.ts
  hooks/
    useAuspiciousHours.ts
    useLunarDate.ts
  services/
    lunar/
      auspiciousHours.ts
      canChi.ts
      converter.ts
      index.ts
      newMoon.ts
      types.ts
    notifications/
      index.ts
    dataService.ts
  stores/
    eventStore.ts
    settingsStore.ts
    storage.ts
  types/
    event.ts
  utils/
    accessibility.ts
.eslintrc.js
.gitignore
.prettierrc
app.json
eas.json
package.json
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".claude/plans/ios-lunar-calendar-app/reports/01-research-report.md">
# Research Report: Vietnamese Lunar Calendar iOS App

**Date:** 2026-02-05
**Purpose:** Technical research for React Native Vietnamese Lunar Calendar app

---

## 1. Vietnamese Lunar Calendar Algorithm

### Core Algorithm Source
Based on research from [Ho Ngoc Duc's Vietnamese lunar calendar](https://www.xemamlich.uhm.vn/vncal_en.html) and the book "Calendrical Calculations" by Reingold & Dershowitz.

### Key Calculation Rules

1. **New Moon Determination**: First day of lunar month contains the New Moon
2. **Time Zone**: Vietnam uses GMT+7 (105° East meridian) - critical for accuracy
3. **Winter Solstice**: Must always fall in month 11
4. **Leap Month**: In years with 13 lunar months between Winter Solstices, first month after first Winter Solstice without a Principal Term is the leap month
5. **Principal Terms**: 12 points dividing the ecliptic into equal sectors

### Vietnamese vs Chinese Calendar Differences
- Different zodiac animals (Cat vs Rabbit in Vietnamese)
- Time zone affects month boundaries (New Moon at 16:24:45 GMT = 23:24:45 Hanoi time)
- Modern rules unified in 1976 after reunification

### Available JavaScript Libraries

| Library | Date Range | Features | Notes |
|---------|------------|----------|-------|
| [lunar-date (NghiaCaNgao)](https://github.com/NghiaCaNgao/LunarDate) | 1200-2199 | Conversion, Can Chi, Giờ Hoàng Đạo | Best option - native JS |
| [vnlunar (Dart)](https://github.com/nguyen703/vnlunar) | 1800-2199 | Conversion only | Dart/Flutter, not RN |
| [SolarLunarCalendar (Python)](https://github.com/quangvinh86/SolarLunarCalendar) | N/A | Full conversion, zodiac | Reference only |

**Recommended**: Port/adapt lunar-date library for React Native - provides all needed features including giờ hoàng đạo.

---

## 2. Giờ Hoàng Đạo (Auspicious Hours) Algorithm

### Structure
- Day divided into 12 two-hour periods (Tý to Hợi)
- 6 auspicious hours + 6 inauspicious hours per day
- Based on Earthly Branch (Chi) of the day

### The 12 Vietnamese Zodiac Hours

| Hour | Time | Name |
|------|------|------|
| Tý | 23:00-01:00 | Rat |
| Sửu | 01:00-03:00 | Buffalo |
| Dần | 03:00-05:00 | Tiger |
| Mão | 05:00-07:00 | Cat |
| Thìn | 07:00-09:00 | Dragon |
| Tỵ | 09:00-11:00 | Snake |
| Ngọ | 11:00-13:00 | Horse |
| Mùi | 13:00-15:00 | Goat |
| Thân | 15:00-17:00 | Monkey |
| Dậu | 17:00-19:00 | Rooster |
| Tuất | 19:00-21:00 | Dog |
| Hợi | 21:00-23:00 | Pig |

### The Six Auspicious Stars
1. **Thanh Long** - Most auspicious
2. **Kim Quỹ** - Good for childbirth
3. **Kim Đường**
4. **Ngọc Đường** - Good for career
5. **Minh Đường**
6. **Tư Mệnh**

### Calculation Method
Based on Lục Bát poetry lookup - each lunar day's Chi determines which hours are auspicious. Characters starting with "Đ" in the verse indicate giờ hoàng đạo.

---

## 3. Vietnamese Holidays Data

### National Holidays (Lunar Calendar)

| Holiday | Lunar Date | Description |
|---------|-----------|-------------|
| Tết Nguyên Đán | 1st day, 1st month | Lunar New Year (main holiday) |
| Giỗ Tổ Hùng Vương | 10th day, 3rd month | Hung Kings Commemoration |
| Tết Thanh Minh | 3rd day, 3rd month | Tomb Sweeping Day |
| Tết Đoan Ngọ | 5th day, 5th month | Mid-year festival |
| Lễ Vu Lan | 15th day, 7th month | Ghost Festival/Ancestors |
| Tết Trung Thu | 15th day, 8th month | Mid-Autumn Festival |
| Ông Công Ông Táo | 23rd day, 12th month | Kitchen Gods Day |

### Recurring Observances
- **Rằm (Full Moon)**: 15th of each lunar month
- **Mùng Một**: 1st of each lunar month
- **Ngày Giỗ**: Individual family ancestor memorial days (user-defined)

### 2026 Key Dates
- Tết 2026: February 17 (Year of the Horse)
- Official holiday: February 14-22, 2026

---

## 4. React Native Calendar Libraries Comparison

### Option A: react-native-calendars (Wix)
- **Score**: 81.4 (Context7)
- **Pros**: Mature, well-documented, agenda view, custom day rendering
- **Cons**: Less flexible for complex layouts
- **Best for**: Traditional calendar with marked dates

### Option B: react-native-calendar-kit (howljs)
- **Score**: 89.2 (Context7)
- **Pros**: Multi-view (day/week/month), zoom, localization built-in, Vietnamese locale support
- **Cons**: More complex setup
- **Best for**: Timeline views, event scheduling

### Option C: flash-calendar (marceloprado)
- **Score**: 75.9 (Context7)
- **Pros**: Performance optimized, lightweight
- **Cons**: Less features
- **Best for**: Simple calendar display

**Recommendation**: Use **react-native-calendars** for main calendar view + custom day component for lunar date display. Provides best balance of features and customization.

---

## 5. State Management & Storage

### State Management: Zustand
- Lightweight, minimal boilerplate
- Built-in persist middleware
- Works with MMKV or AsyncStorage
- TypeScript friendly

```typescript
// Example Zustand store with MMKV persistence
import { create } from 'zustand'
import { persist, createJSONStorage } from 'zustand/middleware'
import { MMKV } from 'react-native-mmkv'

const storage = new MMKV()
const mmkvStorage = {
  getItem: (name) => storage.getString(name) ?? null,
  setItem: (name, value) => storage.set(name, value),
  removeItem: (name) => storage.delete(name),
}
```

### Storage: MMKV vs AsyncStorage

| Feature | MMKV | AsyncStorage |
|---------|------|--------------|
| Speed | ~30x faster | Baseline |
| Sync API | Yes | No (async only) |
| Encryption | Built-in | No |
| Setup | Extra dependency | Built-in |

**Recommendation**: Use **react-native-mmkv** for better performance and synchronous access.

---

## 6. Navigation

### Expo Router vs React Navigation

| Feature | Expo Router | React Navigation |
|---------|-------------|------------------|
| Setup | File-based (automatic) | Manual configuration |
| Deep Linking | Automatic | Manual |
| TypeScript | Built-in | Manual setup |
| Learning Curve | Lower | Higher |

**Recommendation**: Use **Expo Router** (built on React Navigation). New Expo projects include it by default. Provides file-based routing, automatic deep linking, and TypeScript support.

---

## 7. Local Notifications

### Options

1. **expo-notifications** (Expo managed)
   - Easy setup
   - Scheduling support (daily, calendar)
   - Works with Expo Go

2. **notifee** (Bare React Native)
   - More powerful
   - Complex scheduling
   - Requires bare workflow

**Recommendation**: Use **expo-notifications** - sufficient for lunar calendar reminders, easier integration.

### Lunar Calendar Reminder Strategy
1. Convert lunar date to solar date
2. Schedule notification for calculated solar date
3. Handle repeating reminders by recalculating each year

---

## 8. Project Architecture Recommendation

### Folder Structure
```
src/
├── app/                    # Expo Router pages
│   ├── (tabs)/            # Tab navigation
│   │   ├── index.tsx      # Calendar view
│   │   ├── events.tsx     # Events list
│   │   └── settings.tsx   # Settings
│   ├── event/[id].tsx     # Event detail
│   └── _layout.tsx        # Root layout
├── components/
│   ├── calendar/          # Calendar components
│   ├── common/            # Shared components
│   └── events/            # Event components
├── hooks/                 # Custom hooks
├── services/
│   ├── lunar/             # Lunar calendar logic
│   └── notifications/     # Notification service
├── stores/                # Zustand stores
├── types/                 # TypeScript types
├── utils/                 # Utility functions
└── constants/             # App constants (holidays data)
```

### Tech Stack Summary
- **Framework**: React Native + Expo (managed workflow)
- **Language**: TypeScript
- **Navigation**: Expo Router
- **State**: Zustand + persist middleware
- **Storage**: react-native-mmkv
- **Calendar UI**: react-native-calendars
- **Notifications**: expo-notifications
- **Lunar Logic**: Custom port of lunar-date library

---

## 9. Open Questions

1. **Lunar algorithm precision**: Need to validate algorithm accuracy for edge cases (leap months, century boundaries)
2. **Giờ hoàng đạo lookup table**: Need to extract/verify complete mapping from source
3. **Offline-first sync**: If future backend needed, consider WatermelonDB instead of MMKV
4. **iOS calendar integration**: Should we sync with native iOS Calendar app?

---

## References

- [Ho Ngoc Duc's Vietnamese Lunar Calendar](https://www.xemamlich.uhm.vn/vncal_en.html)
- [lunar-date JS Library](https://github.com/NghiaCaNgao/LunarDate)
- [react-native-calendars](https://wix.github.io/react-native-calendars/)
- [react-native-mmkv](https://github.com/mrousavy/react-native-mmkv)
- [Zustand Persist](https://zustand.docs.pmnd.rs/integrations/persisting-store-data)
- [Expo Notifications](https://docs.expo.dev/versions/latest/sdk/notifications/)
- [Expo Router](https://docs.expo.dev/router/introduction/)
- [Vietnamese Public Holidays](https://www.timeanddate.com/holidays/vietnam/2026)
</file>

<file path=".claude/plans/ios-lunar-calendar-app/phase-01-project-setup.md">
# Phase 1: Project Setup

## Context Links
- [Main Plan](./plan.md)
- [Research Report](./reports/01-research-report.md)
- Next: [Phase 2: Lunar Calendar Core](./phase-02-lunar-calendar-core.md)

---

## Overview

| Field | Value |
|-------|-------|
| Date | 2026-02-05 |
| Description | Initialize Expo project with core dependencies and architecture |
| Priority | P1 (Critical Path) |
| Status | completed |
| Effort | 8h |

---

## Key Insights

1. Expo managed workflow provides fastest path to iOS deployment
2. MMKV requires native module setup but offers significant performance gains
3. File-based routing with Expo Router simplifies navigation
4. TypeScript strict mode catches lunar date calculation bugs early

---

## Requirements

### Functional
- R1.1: Create new Expo project with TypeScript template
- R1.2: Configure file-based navigation with tabs
- R1.3: Set up persistent storage with MMKV
- R1.4: Initialize Zustand stores with persist middleware

### Non-Functional
- R1.5: ESLint + Prettier for code consistency
- R1.6: Path aliases for clean imports
- R1.7: iOS minimum version: 14.0

---

## Architecture

### Dependencies

```json
{
  "dependencies": {
    "expo": "~52.0.0",
    "expo-router": "~4.0.0",
    "expo-notifications": "~0.29.0",
    "react-native-calendars": "^1.1306.0",
    "react-native-mmkv": "^3.0.0",
    "zustand": "^5.0.0"
  },
  "devDependencies": {
    "typescript": "~5.3.0",
    "@types/react": "~18.2.0",
    "eslint": "^8.0.0",
    "prettier": "^3.0.0"
  }
}
```

### Configuration Files

```
project-root/
├── app.json                 # Expo config
├── tsconfig.json           # TypeScript config
├── babel.config.js         # Babel with path aliases
├── .eslintrc.js            # ESLint rules
├── .prettierrc             # Prettier config
└── eas.json                # EAS Build config
```

---

## Related Code Files

### File: `app.json`
```json
{
  "expo": {
    "name": "Lịch Việt",
    "slug": "lich-viet",
    "version": "1.0.0",
    "orientation": "portrait",
    "icon": "./assets/icon.png",
    "scheme": "lichviet",
    "userInterfaceStyle": "automatic",
    "splash": {
      "image": "./assets/splash.png",
      "resizeMode": "contain",
      "backgroundColor": "#ffffff"
    },
    "ios": {
      "supportsTablet": true,
      "bundleIdentifier": "com.yourname.lichviet",
      "infoPlist": {
        "UIBackgroundModes": ["fetch", "remote-notification"]
      }
    },
    "plugins": [
      "expo-router",
      [
        "expo-notifications",
        {
          "sounds": ["./assets/sounds/notification.wav"]
        }
      ]
    ]
  }
}
```

### File: `src/app/_layout.tsx`
```tsx
import { Stack } from 'expo-router';
import { useEffect } from 'react';
import { initializeStorage } from '@/stores/storage';

export default function RootLayout() {
  useEffect(() => {
    initializeStorage();
  }, []);

  return (
    <Stack>
      <Stack.Screen name="(tabs)" options={{ headerShown: false }} />
      <Stack.Screen name="event/[id]" options={{ presentation: 'modal' }} />
      <Stack.Screen name="day/[date]" options={{ presentation: 'card' }} />
    </Stack>
  );
}
```

### File: `src/app/(tabs)/_layout.tsx`
```tsx
import { Tabs } from 'expo-router';
import { Ionicons } from '@expo/vector-icons';

export default function TabLayout() {
  return (
    <Tabs
      screenOptions={{
        tabBarActiveTintColor: '#D4382A',
        headerShown: true,
      }}
    >
      <Tabs.Screen
        name="index"
        options={{
          title: 'Lịch',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="calendar" size={size} color={color} />
          ),
        }}
      />
      <Tabs.Screen
        name="events"
        options={{
          title: 'Sự kiện',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="list" size={size} color={color} />
          ),
        }}
      />
      <Tabs.Screen
        name="settings"
        options={{
          title: 'Cài đặt',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="settings" size={size} color={color} />
          ),
        }}
      />
    </Tabs>
  );
}
```

### File: `src/stores/storage.ts`
```tsx
import { MMKV } from 'react-native-mmkv';
import { StateStorage } from 'zustand/middleware';

export const storage = new MMKV({
  id: 'lich-viet-storage',
  encryptionKey: 'optional-encryption-key',
});

export const mmkvStorage: StateStorage = {
  getItem: (name: string): string | null => {
    const value = storage.getString(name);
    return value ?? null;
  },
  setItem: (name: string, value: string): void => {
    storage.set(name, value);
  },
  removeItem: (name: string): void => {
    storage.delete(name);
  },
};

export function initializeStorage(): void {
  // Migration logic if needed
  const version = storage.getNumber('version') ?? 0;
  if (version < 1) {
    // Initial setup
    storage.set('version', 1);
  }
}
```

### File: `src/stores/settingsStore.ts`
```tsx
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { mmkvStorage } from './storage';

interface SettingsState {
  showLunarDates: boolean;
  showAuspiciousHours: boolean;
  reminderDaysBefore: number;
  reminderTime: string; // "HH:mm"

  setShowLunarDates: (show: boolean) => void;
  setShowAuspiciousHours: (show: boolean) => void;
  setReminderDaysBefore: (days: number) => void;
  setReminderTime: (time: string) => void;
}

export const useSettingsStore = create<SettingsState>()(
  persist(
    (set) => ({
      showLunarDates: true,
      showAuspiciousHours: true,
      reminderDaysBefore: 1,
      reminderTime: '08:00',

      setShowLunarDates: (show) => set({ showLunarDates: show }),
      setShowAuspiciousHours: (show) => set({ showAuspiciousHours: show }),
      setReminderDaysBefore: (days) => set({ reminderDaysBefore: days }),
      setReminderTime: (time) => set({ reminderTime: time }),
    }),
    {
      name: 'settings',
      storage: createJSONStorage(() => mmkvStorage),
    }
  )
);
```

### File: `tsconfig.json`
```json
{
  "extends": "expo/tsconfig.base",
  "compilerOptions": {
    "strict": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["**/*.ts", "**/*.tsx", ".expo/types/**/*.ts", "expo-env.d.ts"]
}
```

---

## Implementation Steps

### Step 1: Create Expo Project (30 min)
```bash
# Create new Expo project
npx create-expo-app@latest lich-viet --template tabs

# Navigate to project
cd lich-viet

# Remove default content, restructure to src/
```

### Step 2: Install Dependencies (30 min)
```bash
# Core dependencies
npx expo install react-native-mmkv zustand

# Calendar
npm install react-native-calendars

# Notifications
npx expo install expo-notifications

# Dev dependencies
npm install -D @typescript-eslint/parser @typescript-eslint/eslint-plugin prettier eslint-config-prettier
```

### Step 3: Configure MMKV Native Module (1h)
```bash
# For iOS, MMKV requires native build
npx expo prebuild --platform ios

# Install pods
cd ios && pod install && cd ..
```

### Step 4: Set Up Folder Structure (30 min)
Create the directory structure as defined in the main plan.

### Step 5: Configure TypeScript Path Aliases (30 min)
Update `tsconfig.json` and `babel.config.js` for `@/` imports.

### Step 6: Create Storage Layer (1h)
Implement MMKV storage wrapper and Zustand stores.

### Step 7: Set Up Navigation (1h)
Create tab layout and placeholder screens.

### Step 8: Configure ESLint/Prettier (30 min)
Set up linting rules for consistent code style.

### Step 9: Create Base Components (2h)
Build common components: Button, Header, Modal, etc.

### Step 10: Verify Build (1h)
```bash
# Run on iOS simulator
npx expo run:ios

# Verify storage works
# Verify navigation works
```

---

## Todo List

- [x] Create Expo project with TypeScript
- [x] Restructure to src/ folder
- [x] Install all dependencies
- [x] Configure MMKV with native build
- [x] Set up TypeScript path aliases
- [x] Create MMKV storage wrapper
- [x] Create Zustand settings store
- [x] Implement tab navigation
- [x] Create placeholder screens (index, events, settings)
- [x] Configure ESLint and Prettier
- [x] Build common Button component
- [x] Build common Header component
- [x] Build common Modal component
- [x] Test iOS simulator build
- [x] Verify storage persistence

---

## Success Criteria

- [ ] `npx expo run:ios` builds and runs without errors
- [ ] Tab navigation works between 3 screens
- [ ] MMKV storage persists data across app restarts
- [ ] Zustand store rehydrates on app launch
- [ ] TypeScript compiles with no errors
- [ ] ESLint passes with no warnings
- [ ] Path aliases resolve correctly

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| MMKV native build fails | High | Low | Fallback to AsyncStorage initially |
| Expo SDK version conflicts | Medium | Medium | Lock dependency versions |
| Path alias issues | Low | Medium | Test early, fix babel config |

---

## Security Considerations

- MMKV encryption key should be stored securely (Keychain) for production
- No sensitive data in this phase, but foundation supports encryption
- Bundle identifier must be unique for App Store

---

## Next Steps

After completing Phase 1:
1. Verify all success criteria
2. Commit with message: "Phase 1: Project setup complete"
3. Proceed to [Phase 2: Lunar Calendar Core](./phase-02-lunar-calendar-core.md)
</file>

<file path=".claude/plans/ios-lunar-calendar-app/phase-02-lunar-calendar-core.md">
# Phase 2: Lunar Calendar Core

## Context Links
- [Main Plan](./plan.md)
- [Research Report](./reports/01-research-report.md)
- Previous: [Phase 1: Project Setup](./phase-01-project-setup.md)
- Next: [Phase 3: Calendar UI](./phase-03-calendar-ui.md)

---

## Overview

| Field | Value |
|-------|-------|
| Date | 2026-02-05 |
| Description | Implement Vietnamese lunar calendar conversion and auspicious hours calculation |
| Priority | P1 (Critical Path) |
| Status | completed |
| Effort | 20h |

---

## Key Insights

1. **Algorithm Source**: Ho Ngoc Duc's algorithm based on "Calendrical Calculations" book
2. **Time Zone Critical**: Vietnam GMT+7 affects month boundaries - same moment can be different lunar date vs Chinese calendar
3. **Date Range**: Support 1900-2100 for practical use (algorithm supports wider range)
4. **Giờ Hoàng Đạo**: Based on day's Earthly Branch (Chi), 6 auspicious + 6 inauspicious hours
5. **Can Chi**: 10 Heavenly Stems x 12 Earthly Branches = 60-year cycle

---

## Requirements

### Functional
- R2.1: Convert solar date to lunar date (day, month, year, leap month flag)
- R2.2: Convert lunar date to solar date
- R2.3: Calculate Can Chi for year, month, day, hour
- R2.4: Calculate giờ hoàng đạo for any given day
- R2.5: Provide Vietnamese holidays for any year
- R2.6: Handle leap months correctly

### Non-Functional
- R2.7: Calculation must complete in <10ms
- R2.8: 100% unit test coverage for conversion functions
- R2.9: Validate accuracy against reference calendar
- R2.10: Anchor all calculations to Vietnam GMT+7, regardless of device locale
- R2.11: Define fallback logic for lunar events in non-leap years (mapping leap month to regular month)

---

## Architecture

### Lunar Service Structure

```
src/services/lunar/
├── index.ts              # Public API exports
├── converter.ts          # Solar <-> Lunar conversion
├── newMoon.ts           # New moon calculation
├── solarTerm.ts         # Solar term (Principal Term) calculation
├── canChi.ts            # Can Chi (Stems/Branches) calculation
├── auspiciousHours.ts   # Giờ hoàng đạo logic
├── holidays.ts          # Vietnamese holidays
└── types.ts             # TypeScript interfaces
```

### Data Flow

```
Solar Date (2026-02-17)
        │
        ▼
┌───────────────────┐
│   New Moon Calc   │ → Find lunar month boundaries
└───────────────────┘
        │
        ▼
┌───────────────────┐
│  Solar Term Calc  │ → Determine leap month
└───────────────────┘
        │
        ▼
┌───────────────────┐
│   Can Chi Calc    │ → Year/Month/Day/Hour stems & branches
└───────────────────┘
        │
        ▼
Lunar Date { day: 1, month: 1, year: 2026, leap: false, canChi: {...} }
```

---

## Related Code Files

### File: `src/services/lunar/types.ts`
```typescript
export interface LunarDate {
  day: number;        // 1-30
  month: number;      // 1-12
  year: number;       // e.g., 2026
  leap: boolean;      // is this a leap month?
  jd: number;         // Julian day number
}

export interface SolarDate {
  day: number;
  month: number;
  year: number;
}

export interface CanChi {
  can: string;        // Heavenly Stem (Giáp, Ất, Bính...)
  chi: string;        // Earthly Branch (Tý, Sửu, Dần...)
  fullName: string;   // Combined name (Giáp Tý)
  index: number;      // Position in 60-year cycle (0-59)
}

export interface DayInfo {
  solar: SolarDate;
  lunar: LunarDate;
  yearCanChi: CanChi;
  monthCanChi: CanChi;
  dayCanChi: CanChi;
  zodiacAnimal: string;  // Con giáp (Tý, Sửu, Dần...)
  solarTerm?: string;    // Tiết khí if applicable
}

export interface AuspiciousHour {
  name: string;       // Tý, Sửu, etc.
  startTime: string;  // "23:00"
  endTime: string;    // "01:00"
  isAuspicious: boolean;
  star?: string;      // Thanh Long, Kim Quỹ, etc.
}

export interface Holiday {
  name: string;
  nameLatin: string;
  lunarMonth: number;
  lunarDay: number;
  description?: string;
  isNational: boolean;
}
```

### File: `src/services/lunar/converter.ts`
```typescript
import { LunarDate, SolarDate } from './types';
import { getNewMoonDay, getSunLongitude } from './newMoon';

const TIMEZONE = 7; // Vietnam GMT+7

/**
 * Convert Julian Day Number to Solar Date
 */
export function jdToDate(jd: number): SolarDate {
  const Z = Math.floor(jd + 0.5);
  const F = jd + 0.5 - Z;
  let A: number;

  if (Z < 2299161) {
    A = Z;
  } else {
    const alpha = Math.floor((Z - 1867216.25) / 36524.25);
    A = Z + 1 + alpha - Math.floor(alpha / 4);
  }

  const B = A + 1524;
  const C = Math.floor((B - 122.1) / 365.25);
  const D = Math.floor(365.25 * C);
  const E = Math.floor((B - D) / 30.6001);

  const day = B - D - Math.floor(30.6001 * E) + F;
  const month = E < 14 ? E - 1 : E - 13;
  const year = month > 2 ? C - 4716 : C - 4715;

  return { day: Math.floor(day), month, year };
}

/**
 * Convert Solar Date to Julian Day Number
 */
export function dateToJd(day: number, month: number, year: number): number {
  let a = Math.floor((14 - month) / 12);
  let y = year + 4800 - a;
  let m = month + 12 * a - 3;

  let jd = day + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4);

  if (year > 1582 || (year === 1582 && (month > 10 || (month === 10 && day >= 15)))) {
    jd = jd - Math.floor(y / 100) + Math.floor(y / 400) - 32045;
  } else {
    jd = jd - 32083;
  }

  return jd;
}

/**
 * Get lunar month info for a given lunar month
 * Returns [newMoonJD, leapMonth] where leapMonth is 0 if not leap
 */
function getLunarMonth11(year: number): number {
  const off = dateToJd(31, 12, year) - 2415021;
  const k = Math.floor(off / 29.530588853);
  let nm = getNewMoonDay(k, TIMEZONE);
  const sunLong = getSunLongitude(nm, TIMEZONE);

  if (sunLong >= 9) {
    nm = getNewMoonDay(k - 1, TIMEZONE);
  }

  return nm;
}

/**
 * Determine leap month in lunar year
 * Returns 0 if no leap month, or the leap month number (1-12)
 */
function getLeapMonthOffset(a11: number): number {
  const k = Math.floor((a11 - 2415021.076998695) / 29.530588853 + 0.5);
  let last = 0;
  let i = 1;
  let arc = getSunLongitude(getNewMoonDay(k + i, TIMEZONE), TIMEZONE);

  do {
    last = arc;
    i++;
    arc = getSunLongitude(getNewMoonDay(k + i, TIMEZONE), TIMEZONE);
  } while (arc !== last && i < 14);

  return i - 1;
}

/**
 * Convert Solar Date to Lunar Date
 */
export function solarToLunar(dd: number, mm: number, yy: number): LunarDate {
  const dayNumber = dateToJd(dd, mm, yy);
  const k = Math.floor((dayNumber - 2415021.076998695) / 29.530588853);

  let monthStart = getNewMoonDay(k + 1, TIMEZONE);
  if (monthStart > dayNumber) {
    monthStart = getNewMoonDay(k, TIMEZONE);
  }

  let a11 = getLunarMonth11(yy);
  let b11 = a11;

  let lunarYear: number;
  if (a11 >= monthStart) {
    lunarYear = yy;
    a11 = getLunarMonth11(yy - 1);
  } else {
    lunarYear = yy + 1;
    b11 = getLunarMonth11(yy + 1);
  }

  const lunarDay = dayNumber - monthStart + 1;
  const diff = Math.floor((monthStart - a11) / 29);

  let lunarLeap = false;
  let lunarMonth = diff + 11;

  if (b11 - a11 > 365) {
    const leapMonthDiff = getLeapMonthOffset(a11);
    if (diff >= leapMonthDiff) {
      lunarMonth = diff + 10;
      if (diff === leapMonthDiff) {
        lunarLeap = true;
      }
    }
  }

  if (lunarMonth > 12) {
    lunarMonth = lunarMonth - 12;
  }
  if (lunarMonth >= 11 && diff < 4) {
    lunarYear -= 1;
  }

  return {
    day: lunarDay,
    month: lunarMonth,
    year: lunarYear,
    leap: lunarLeap,
    jd: dayNumber,
  };
}

/**
 * Convert Lunar Date to Solar Date
 */
export function lunarToSolar(
  lunarDay: number,
  lunarMonth: number,
  lunarYear: number,
  lunarLeap: boolean = false
): SolarDate {
  let a11: number, b11: number;

  if (lunarMonth < 11) {
    a11 = getLunarMonth11(lunarYear - 1);
    b11 = getLunarMonth11(lunarYear);
  } else {
    a11 = getLunarMonth11(lunarYear);
    b11 = getLunarMonth11(lunarYear + 1);
  }

  const k = Math.floor(0.5 + (a11 - 2415021.076998695) / 29.530588853);
  let off = lunarMonth - 11;
  if (off < 0) {
    off += 12;
  }

  if (b11 - a11 > 365) {
    const leapOff = getLeapMonthOffset(a11);
    let leapMonth = leapOff - 2;
    if (leapMonth < 0) {
      leapMonth += 12;
    }
    if (lunarLeap && lunarMonth !== leapMonth) {
      return { day: 0, month: 0, year: 0 }; // Invalid leap month
    }
    if (lunarLeap || off >= leapOff) {
      off += 1;
    }
  }

  const monthStart = getNewMoonDay(k + off, TIMEZONE);
  return jdToDate(monthStart + lunarDay - 1);
}
```

### File: `src/services/lunar/newMoon.ts`
```typescript
const PI = Math.PI;

/**
 * Calculate Julian day number of the k-th new moon after J2000
 * Algorithm from "Astronomical Algorithms" by Jean Meeus
 */
export function getNewMoonDay(k: number, timeZone: number): number {
  const T = k / 1236.85;
  const T2 = T * T;
  const T3 = T2 * T;

  const dr = PI / 180;

  let Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T2 - 0.000000155 * T3;
  Jd1 = Jd1 + 0.00033 * Math.sin((166.56 + 132.87 * T - 0.009173 * T2) * dr);

  const M = 359.2242 + 29.10535608 * k - 0.0000333 * T2 - 0.00000347 * T3;
  const Mpr = 306.0253 + 385.81691806 * k + 0.0107306 * T2 + 0.00001236 * T3;
  const F = 21.2964 + 390.67050646 * k - 0.0016528 * T2 - 0.00000239 * T3;

  let C1 = (0.1734 - 0.000393 * T) * Math.sin(M * dr) + 0.0021 * Math.sin(2 * dr * M);
  C1 = C1 - 0.4068 * Math.sin(Mpr * dr) + 0.0161 * Math.sin(dr * 2 * Mpr);
  C1 = C1 - 0.0004 * Math.sin(dr * 3 * Mpr);
  C1 = C1 + 0.0104 * Math.sin(dr * 2 * F) - 0.0051 * Math.sin(dr * (M + Mpr));
  C1 = C1 - 0.0074 * Math.sin(dr * (M - Mpr)) + 0.0004 * Math.sin(dr * (2 * F + M));
  C1 = C1 - 0.0004 * Math.sin(dr * (2 * F - M)) - 0.0006 * Math.sin(dr * (2 * F + Mpr));
  C1 = C1 + 0.001 * Math.sin(dr * (2 * F - Mpr)) + 0.0005 * Math.sin(dr * (2 * Mpr + M));

  let deltat: number;
  if (T < -11) {
    deltat = 0.001 + 0.000839 * T + 0.0002261 * T2 - 0.00000845 * T3 - 0.000000081 * T * T3;
  } else {
    deltat = -0.000278 + 0.000265 * T + 0.000262 * T2;
  }

  const JdNew = Jd1 + C1 - deltat;
  return Math.floor(JdNew + 0.5 + timeZone / 24);
}

/**
 * Calculate sun longitude at a given Julian day
 * Returns position in zodiac (0-11)
 */
export function getSunLongitude(jd: number, timeZone: number): number {
  const T = (jd - 2451545.5 - timeZone / 24) / 36525;
  const T2 = T * T;
  const dr = PI / 180;

  const M = 357.5291 + 35999.0503 * T - 0.0001559 * T2 - 0.00000048 * T * T2;
  const L0 = 280.46645 + 36000.76983 * T + 0.0003032 * T2;

  let DL = (1.9146 - 0.004817 * T - 0.000014 * T2) * Math.sin(dr * M);
  DL = DL + (0.019993 - 0.000101 * T) * Math.sin(dr * 2 * M) + 0.00029 * Math.sin(dr * 3 * M);

  let L = L0 + DL;
  L = L * dr;
  L = L - PI * 2 * Math.floor(L / (PI * 2));

  return Math.floor((L / PI) * 6);
}
```

### File: `src/services/lunar/canChi.ts`
```typescript
import { CanChi } from './types';

// Thiên Can (Heavenly Stems)
const CAN = ['Giáp', 'Ất', 'Bính', 'Đinh', 'Mậu', 'Kỷ', 'Canh', 'Tân', 'Nhâm', 'Quý'];

// Địa Chi (Earthly Branches)
const CHI = ['Tý', 'Sửu', 'Dần', 'Mão', 'Thìn', 'Tỵ', 'Ngọ', 'Mùi', 'Thân', 'Dậu', 'Tuất', 'Hợi'];

// Vietnamese zodiac animals (same order as CHI)
const ZODIAC_ANIMALS = [
  'Chuột', 'Trâu', 'Hổ', 'Mèo', 'Rồng', 'Rắn',
  'Ngựa', 'Dê', 'Khỉ', 'Gà', 'Chó', 'Lợn'
];

/**
 * Calculate Can Chi for lunar year
 */
export function getYearCanChi(lunarYear: number): CanChi {
  const canIndex = (lunarYear + 6) % 10;
  const chiIndex = (lunarYear + 8) % 12;

  return {
    can: CAN[canIndex],
    chi: CHI[chiIndex],
    fullName: `${CAN[canIndex]} ${CHI[chiIndex]}`,
    index: (canIndex * 12 + chiIndex) % 60,
  };
}

/**
 * Calculate Can Chi for lunar month
 * Depends on lunar year's Can
 */
export function getMonthCanChi(lunarMonth: number, lunarYear: number): CanChi {
  const yearCan = (lunarYear + 6) % 10;
  // First month starts from Dần (index 2)
  const chiIndex = (lunarMonth + 1) % 12;
  // Can of month depends on year's Can
  const canIndex = (yearCan * 2 + lunarMonth) % 10;

  return {
    can: CAN[canIndex],
    chi: CHI[chiIndex],
    fullName: `${CAN[canIndex]} ${CHI[chiIndex]}`,
    index: (canIndex * 12 + chiIndex) % 60,
  };
}

/**
 * Calculate Can Chi for a day using Julian Day Number
 */
export function getDayCanChi(jd: number): CanChi {
  const canIndex = (jd + 9) % 10;
  const chiIndex = (jd + 1) % 12;

  return {
    can: CAN[canIndex],
    chi: CHI[chiIndex],
    fullName: `${CAN[canIndex]} ${CHI[chiIndex]}`,
    index: (canIndex * 12 + chiIndex) % 60,
  };
}

/**
 * Calculate Can Chi for an hour
 * Hour Chi is fixed (Tý = 23:00-01:00)
 * Hour Can depends on day's Can
 */
export function getHourCanChi(hour: number, dayJd: number): CanChi {
  // Convert hour to Chi index (Tý starts at 23:00)
  const chiIndex = Math.floor(((hour + 1) % 24) / 2);

  // Hour Can depends on day's Can
  const dayCan = (dayJd + 9) % 10;
  const canIndex = (dayCan * 2 + chiIndex) % 10;

  return {
    can: CAN[canIndex],
    chi: CHI[chiIndex],
    fullName: `${CAN[canIndex]} ${CHI[chiIndex]}`,
    index: (canIndex * 12 + chiIndex) % 60,
  };
}

/**
 * Get Vietnamese zodiac animal for a lunar year
 */
export function getZodiacAnimal(lunarYear: number): string {
  const chiIndex = (lunarYear + 8) % 12;
  return ZODIAC_ANIMALS[chiIndex];
}

/**
 * Get the Chi (Earthly Branch) index for a given Julian Day
 * Used for auspicious hour calculation
 */
export function getDayChi(jd: number): number {
  return (jd + 1) % 12;
}

export { CAN, CHI, ZODIAC_ANIMALS };
```

### File: `src/services/lunar/auspiciousHours.ts`
```typescript
import { AuspiciousHour } from './types';
import { CHI, getDayChi } from './canChi';

// Giờ hoàng đạo lookup by day's Chi index
// Each array contains indices of auspicious hour Chi (0-11)
// Based on traditional Vietnamese almanac
const AUSPICIOUS_HOURS_BY_DAY_CHI: Record<number, number[]> = {
  0:  [0, 1, 4, 5, 8, 9],    // Ngày Tý: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
  1:  [2, 3, 6, 7, 10, 11],  // Ngày Sửu: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
  2:  [0, 1, 4, 5, 8, 9],    // Ngày Dần: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
  3:  [2, 3, 6, 7, 10, 11],  // Ngày Mão: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
  4:  [0, 1, 4, 5, 8, 9],    // Ngày Thìn: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
  5:  [2, 3, 6, 7, 10, 11],  // Ngày Tỵ: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
  6:  [0, 1, 4, 5, 8, 9],    // Ngày Ngọ: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
  7:  [2, 3, 6, 7, 10, 11],  // Ngày Mùi: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
  8:  [0, 1, 4, 5, 8, 9],    // Ngày Thân: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
  9:  [2, 3, 6, 7, 10, 11],  // Ngày Dậu: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
  10: [0, 1, 4, 5, 8, 9],    // Ngày Tuất: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
  11: [2, 3, 6, 7, 10, 11],  // Ngày Hợi: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
};

// Six auspicious stars (Lục Hoàng Đạo)
const AUSPICIOUS_STARS = [
  'Thanh Long',   // Azure Dragon - most auspicious
  'Minh Đường',   // Bright Hall
  'Kim Quỹ',      // Golden Cabinet
  'Thiên Đức',    // Heavenly Virtue
  'Ngọc Đường',   // Jade Hall
  'Tư Mệnh',      // Commanding Fate
];

// Hour time ranges
const HOUR_TIMES: [string, string][] = [
  ['23:00', '01:00'], // Tý
  ['01:00', '03:00'], // Sửu
  ['03:00', '05:00'], // Dần
  ['05:00', '07:00'], // Mão
  ['07:00', '09:00'], // Thìn
  ['09:00', '11:00'], // Tỵ
  ['11:00', '13:00'], // Ngọ
  ['13:00', '15:00'], // Mùi
  ['15:00', '17:00'], // Thân
  ['17:00', '19:00'], // Dậu
  ['19:00', '21:00'], // Tuất
  ['21:00', '23:00'], // Hợi
];

/**
 * Get all 12 hours with auspicious status for a given Julian Day
 */
export function getAuspiciousHours(jd: number): AuspiciousHour[] {
  const dayChi = getDayChi(jd);
  const auspiciousIndices = AUSPICIOUS_HOURS_BY_DAY_CHI[dayChi];

  return CHI.map((name, index) => {
    const isAuspicious = auspiciousIndices.includes(index);
    const starIndex = auspiciousIndices.indexOf(index);

    return {
      name,
      startTime: HOUR_TIMES[index][0],
      endTime: HOUR_TIMES[index][1],
      isAuspicious,
      star: isAuspicious ? AUSPICIOUS_STARS[starIndex] : undefined,
    };
  });
}

/**
 * Get only auspicious hours for a day
 */
export function getOnlyAuspiciousHours(jd: number): AuspiciousHour[] {
  return getAuspiciousHours(jd).filter((h) => h.isAuspicious);
}

/**
 * Check if a specific hour is auspicious
 */
export function isHourAuspicious(hour: number, jd: number): boolean {
  const chiIndex = Math.floor(((hour + 1) % 24) / 2);
  const dayChi = getDayChi(jd);
  return AUSPICIOUS_HOURS_BY_DAY_CHI[dayChi].includes(chiIndex);
}
```

### File: `src/constants/holidays.ts`
```typescript
import { Holiday } from '@/services/lunar/types';

export const VIETNAMESE_HOLIDAYS: Holiday[] = [
  // National Holidays (Lunar)
  {
    name: 'Tết Nguyên Đán',
    nameLatin: 'Tet Nguyen Dan',
    lunarMonth: 1,
    lunarDay: 1,
    description: 'Vietnamese Lunar New Year - most important holiday',
    isNational: true,
  },
  {
    name: 'Mùng 2 Tết',
    nameLatin: 'Tet Day 2',
    lunarMonth: 1,
    lunarDay: 2,
    description: 'Second day of Tet - visiting maternal family',
    isNational: true,
  },
  {
    name: 'Mùng 3 Tết',
    nameLatin: 'Tet Day 3',
    lunarMonth: 1,
    lunarDay: 3,
    description: 'Third day of Tet - visiting teachers',
    isNational: true,
  },
  {
    name: 'Tết Nguyên Tiêu',
    nameLatin: 'Tet Nguyen Tieu',
    lunarMonth: 1,
    lunarDay: 15,
    description: 'First full moon of the year - temple visits',
    isNational: false,
  },
  {
    name: 'Tết Thanh Minh',
    nameLatin: 'Tet Thanh Minh',
    lunarMonth: 3,
    lunarDay: 3,
    description: 'Tomb Sweeping Day - visit ancestral graves',
    isNational: false,
  },
  {
    name: 'Giỗ Tổ Hùng Vương',
    nameLatin: 'Hung Kings Commemoration',
    lunarMonth: 3,
    lunarDay: 10,
    description: 'Commemoration of legendary founders of Vietnam',
    isNational: true,
  },
  {
    name: 'Tết Đoan Ngọ',
    nameLatin: 'Tet Doan Ngo',
    lunarMonth: 5,
    lunarDay: 5,
    description: 'Mid-year festival - killing insects ritual',
    isNational: false,
  },
  {
    name: 'Lễ Vu Lan',
    nameLatin: 'Vu Lan Festival',
    lunarMonth: 7,
    lunarDay: 15,
    description: 'Ghost Festival - honoring ancestors and wandering spirits',
    isNational: false,
  },
  {
    name: 'Tết Trung Thu',
    nameLatin: 'Mid-Autumn Festival',
    lunarMonth: 8,
    lunarDay: 15,
    description: "Children's festival with mooncakes and lanterns",
    isNational: false,
  },
  {
    name: 'Tết Trùng Cửu',
    nameLatin: 'Double Ninth Festival',
    lunarMonth: 9,
    lunarDay: 9,
    description: 'Day to climb heights and remember ancestors',
    isNational: false,
  },
  {
    name: 'Tết Hạ Nguyên',
    nameLatin: 'Tet Ha Nguyen',
    lunarMonth: 10,
    lunarDay: 15,
    description: 'Third full moon ceremony',
    isNational: false,
  },
  {
    name: 'Ông Công Ông Táo',
    nameLatin: 'Kitchen Gods Day',
    lunarMonth: 12,
    lunarDay: 23,
    description: 'Kitchen Gods return to heaven to report',
    isNational: false,
  },
  {
    name: 'Tất Niên',
    nameLatin: 'New Year Eve',
    lunarMonth: 12,
    lunarDay: 30, // or 29 if month has 29 days
    description: 'Last day of lunar year - family reunion dinner',
    isNational: false,
  },
];

// Monthly recurring observances
export const MONTHLY_OBSERVANCES = [
  { lunarDay: 1, name: 'Mùng Một', description: 'First day of lunar month' },
  { lunarDay: 15, name: 'Rằm', description: 'Full moon day - temple visits' },
];

/**
 * Get holidays for a specific lunar month
 */
export function getHolidaysForMonth(lunarMonth: number): Holiday[] {
  return VIETNAMESE_HOLIDAYS.filter((h) => h.lunarMonth === lunarMonth);
}

/**
 * Check if a lunar date is a holiday
 */
export function getHolidayForDate(lunarDay: number, lunarMonth: number): Holiday | undefined {
  return VIETNAMESE_HOLIDAYS.find(
    (h) => h.lunarDay === lunarDay && h.lunarMonth === lunarMonth
  );
}
```

### File: `src/services/lunar/index.ts`
```typescript
// Main public API for lunar calendar service
export { solarToLunar, lunarToSolar, dateToJd, jdToDate } from './converter';
export { getYearCanChi, getMonthCanChi, getDayCanChi, getHourCanChi, getZodiacAnimal, CAN, CHI } from './canChi';
export { getAuspiciousHours, getOnlyAuspiciousHours, isHourAuspicious } from './auspiciousHours';
export { VIETNAMESE_HOLIDAYS, MONTHLY_OBSERVANCES, getHolidaysForMonth, getHolidayForDate } from '../../constants/holidays';
export type { LunarDate, SolarDate, CanChi, DayInfo, AuspiciousHour, Holiday } from './types';

import { solarToLunar, dateToJd } from './converter';
import { getYearCanChi, getMonthCanChi, getDayCanChi, getZodiacAnimal } from './canChi';
import { getAuspiciousHours } from './auspiciousHours';
import { getHolidayForDate } from '../../constants/holidays';
import { DayInfo, Holiday } from './types';

/**
 * Get complete day information for a solar date
 * This is the main convenience function
 */
export function getDayInfo(day: number, month: number, year: number): DayInfo & { holiday?: Holiday } {
  const lunar = solarToLunar(day, month, year);
  const jd = dateToJd(day, month, year);

  return {
    solar: { day, month, year },
    lunar,
    yearCanChi: getYearCanChi(lunar.year),
    monthCanChi: getMonthCanChi(lunar.month, lunar.year),
    dayCanChi: getDayCanChi(jd),
    zodiacAnimal: getZodiacAnimal(lunar.year),
    holiday: getHolidayForDate(lunar.day, lunar.month),
  };
}
```

---

## Implementation Steps

### Step 1: Create Type Definitions (1h)
Create `src/services/lunar/types.ts` with all interfaces.

### Step 2: Implement New Moon Calculation (3h)
Port astronomical algorithm from Ho Ngoc Duc's work.
- Implement `getNewMoonDay()`
- Implement `getSunLongitude()`
- Test against known new moon dates

### Step 3: Implement Solar-Lunar Conversion (4h)
Create `converter.ts`:
- Julian Day Number conversion
- Solar to Lunar algorithm
- Lunar to Solar algorithm
- Handle leap months correctly

### Step 4: Implement Can Chi Calculation (2h)
Create `canChi.ts`:
- Year Can Chi (60-year cycle)
- Month Can Chi (depends on year)
- Day Can Chi (Julian day based)
- Hour Can Chi (depends on day)

### Step 5: Implement Auspicious Hours (2h)
Create `auspiciousHours.ts`:
- Build lookup table for each day's Chi
- Map to six auspicious stars
- Generate 12-hour display

### Step 6: Create Holidays Data (2h)
Create `constants/holidays.ts`:
- All Vietnamese lunar holidays
- Monthly observances (Rằm, Mùng Một)
- Query functions

### Step 7: Write Unit Tests (4h)
Test cases:
- Known lunar dates (Tết 2026 = Feb 17)
- Leap month handling
- Edge cases (year boundaries, century)
- Auspicious hours by day type

### Step 8: Create Hooks (2h)
Create custom hooks:
- `useLunarDate(solarDate)`
- `useAuspiciousHours(date)`
- `useDayInfo(date)`

---

## Todo List

- [x] Create `types.ts` with all interfaces
- [x] Implement `newMoon.ts` with astronomical calculations
- [x] Implement `converter.ts` with solar/lunar conversion
- [x] Implement `canChi.ts` for heavenly stems/earthly branches
- [x] Implement `auspiciousHours.ts` with lookup tables
- [x] Create `holidays.ts` with Vietnamese holidays
- [x] Create public API in `index.ts`
- [x] Write tests for new moon calculation
- [x] Write tests for solar→lunar conversion
- [x] Write tests for lunar→solar conversion
- [x] Write tests for leap month handling
- [x] Write tests for Can Chi
- [x] Write tests for auspicious hours
- [ ] Create `useLunarDate` hook
- [ ] Create `useAuspiciousHours` hook
- [ ] Validate against Vietnamese calendar 2026

---

## Success Criteria

- [ ] `solarToLunar(17, 2, 2026)` returns `{ day: 1, month: 1, year: 2026, leap: false }`
- [ ] `lunarToSolar(1, 1, 2026, false)` returns `{ day: 17, month: 2, year: 2026 }`
- [ ] Can Chi for 2026 is "Bính Ngọ" (Year of the Horse)
- [ ] Auspicious hours match traditional Vietnamese almanac
- [ ] All 13 holidays correctly identified
- [ ] 100% test coverage for core functions
- [ ] All calculations <10ms

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Algorithm bugs in edge cases | High | Medium | Extensive testing, reference validation |
| Leap month calculation errors | High | Medium | Compare with multiple sources |
| Timezone handling issues | Medium | Low | Always use GMT+7 constant |
| Performance on date ranges | Low | Low | Cache frequently used calculations |

---

## Security Considerations

- No user input in calculations (prevent injection)
- Date range validation to prevent DoS
- No network calls - pure algorithmic

---

## Next Steps

After completing Phase 2:
1. Validate against published Vietnamese calendar
2. Benchmark performance
3. Commit with message: "Phase 2: Lunar calendar core implementation"
4. Proceed to [Phase 3: Calendar UI](./phase-03-calendar-ui.md)
</file>

<file path=".claude/plans/ios-lunar-calendar-app/phase-03-calendar-ui.md">
# Phase 3: Calendar UI

## Context Links
- [Main Plan](./plan.md)
- [Research Report](./reports/01-research-report.md)
- Previous: [Phase 2: Lunar Calendar Core](./phase-02-lunar-calendar-core.md)
- Next: [Phase 4: Features](./phase-04-features.md)

---

## Overview

| Field | Value |
|-------|-------|
| Date | 2026-02-05 |
| Description | Build calendar UI with dual solar/lunar display and day detail view |
| Priority | P1 (Critical Path) |
| Status | completed |
| Effort | 16h |

---

## Key Insights

1. **react-native-calendars** provides best customization for day cell rendering
2. Custom day component needed to show lunar date below solar date
3. Marked dates API supports multiple marking types (dots, periods, custom styles)
4. iOS requires smooth 60fps scrolling - use memo and callbacks
5. Day detail modal should show auspicious hours prominently

---

## Requirements

### Functional
- R3.1: Display month calendar with solar dates
- R3.2: Show lunar date below each solar date
- R3.3: Mark holidays with distinctive styling
- R3.4: Mark user events with dots
- R3.5: Navigate between months
- R3.6: Day detail view with full lunar info
- R3.7: Display auspicious hours in day detail

### Non-Functional
- R3.8: 60fps scrolling performance
- R3.9: Accessible via VoiceOver
- R3.10: Responsive to device sizes
- R3.11: Dark mode support

---

## Architecture

### Component Hierarchy

```
CalendarScreen (app/(tabs)/index.tsx)
├── CalendarHeader
│   ├── MonthYearTitle
│   ├── NavigationArrows
│   └── TodayButton
├── Calendar (react-native-calendars)
│   └── DayCell (custom)
│       ├── SolarDate
│       ├── LunarDate
│       └── HolidayIndicator
└── DayDetailModal
    ├── DateInfo
    ├── CanChiInfo
    ├── HolidayBadge
    └── AuspiciousHours
```

### Color Scheme

```
Primary Red:     #D4382A (holidays, important)
Primary Gold:    #C4982E (auspicious)
Text Primary:    #1A1A1A (light) / #FFFFFF (dark)
Text Secondary:  #666666 (light) / #AAAAAA (dark)
Background:      #FFFFFF (light) / #1A1A1A (dark)
Today Circle:    #D4382A
Selected:        #FFF3F0
Lunar Text:      #888888
Weekend:         #D4382A (Sunday), #4A90D9 (Saturday)
```

---

## Related Code Files

### File: `src/components/calendar/CalendarView.tsx`
```tsx
import React, { useCallback, useMemo, useState } from 'react';
import { View, StyleSheet, TouchableOpacity, Text } from 'react-native';
import { Calendar, DateData } from 'react-native-calendars';
import { DayCell } from './DayCell';
import { DayDetailModal } from './DayDetailModal';
import { useEventsStore } from '@/stores/eventStore';
import { solarToLunar } from '@/services/lunar';
import { getHolidayForDate } from '@/constants/holidays';

interface CalendarViewProps {
  initialDate?: string;
}

export function CalendarView({ initialDate }: CalendarViewProps) {
  const [selectedDate, setSelectedDate] = useState<string | null>(null);
  const [currentMonth, setCurrentMonth] = useState(initialDate || new Date().toISOString().split('T')[0]);
  const [modalVisible, setModalVisible] = useState(false);

  const events = useEventsStore((state) => state.events);

  // Generate marked dates from events and holidays
  const markedDates = useMemo(() => {
    const marks: Record<string, any> = {};

    // Mark events
    events.forEach((event) => {
      const dateKey = event.solarDate;
      marks[dateKey] = {
        ...marks[dateKey],
        marked: true,
        dotColor: '#D4382A',
      };
    });

    // Mark selected date
    if (selectedDate) {
      marks[selectedDate] = {
        ...marks[selectedDate],
        selected: true,
        selectedColor: '#FFF3F0',
        selectedTextColor: '#D4382A',
      };
    }

    return marks;
  }, [events, selectedDate]);

  const handleDayPress = useCallback((day: DateData) => {
    setSelectedDate(day.dateString);
    setModalVisible(true);
  }, []);

  const handleMonthChange = useCallback((month: DateData) => {
    setCurrentMonth(month.dateString);
  }, []);

  // Custom day component renderer
  const renderDay = useCallback(
    ({ date, state }: { date: DateData; state: string }) => {
      if (!date) return null;

      const { day, month, year } = date;
      const lunar = solarToLunar(day, month, year);
      const holiday = getHolidayForDate(lunar.day, lunar.month);
      const isToday = date.dateString === new Date().toISOString().split('T')[0];
      const isSelected = date.dateString === selectedDate;
      const hasEvent = events.some((e) => e.solarDate === date.dateString);

      return (
        <DayCell
          solarDay={day}
          lunarDay={lunar.day}
          lunarMonth={lunar.month}
          isToday={isToday}
          isSelected={isSelected}
          isDisabled={state === 'disabled'}
          isHoliday={!!holiday}
          holidayName={holiday?.name}
          hasEvent={hasEvent}
          onPress={() => handleDayPress(date)}
        />
      );
    },
    [selectedDate, events, handleDayPress]
  );

  return (
    <View style={styles.container}>
      <Calendar
        current={currentMonth}
        onDayPress={handleDayPress}
        onMonthChange={handleMonthChange}
        markedDates={markedDates}
        dayComponent={renderDay}
        hideExtraDays={false}
        showSixWeeks={true}
        enableSwipeMonths={true}
        theme={{
          backgroundColor: '#FFFFFF',
          calendarBackground: '#FFFFFF',
          textSectionTitleColor: '#666666',
          selectedDayBackgroundColor: '#FFF3F0',
          selectedDayTextColor: '#D4382A',
          todayTextColor: '#D4382A',
          dayTextColor: '#1A1A1A',
          textDisabledColor: '#CCCCCC',
          monthTextColor: '#1A1A1A',
          arrowColor: '#D4382A',
          textMonthFontWeight: '600',
          textMonthFontSize: 18,
        }}
      />

      <DayDetailModal
        visible={modalVisible}
        date={selectedDate}
        onClose={() => setModalVisible(false)}
      />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#FFFFFF',
  },
});
```

### File: `src/components/calendar/DayCell.tsx`
```tsx
import React, { memo } from 'react';
import { View, Text, TouchableOpacity, StyleSheet } from 'react-native';

interface DayCellProps {
  solarDay: number;
  lunarDay: number;
  lunarMonth: number;
  isToday: boolean;
  isSelected: boolean;
  isDisabled: boolean;
  isHoliday: boolean;
  holidayName?: string;
  hasEvent: boolean;
  onPress: () => void;
}

export const DayCell = memo(function DayCell({
  solarDay,
  lunarDay,
  lunarMonth,
  isToday,
  isSelected,
  isDisabled,
  isHoliday,
  hasEvent,
  onPress,
}: DayCellProps) {
  // Format lunar date - show month on day 1
  const lunarText = lunarDay === 1 ? `${lunarDay}/${lunarMonth}` : `${lunarDay}`;

  return (
    <TouchableOpacity
      style={[
        styles.container,
        isSelected && styles.selected,
        isToday && styles.today,
      ]}
      onPress={onPress}
      disabled={isDisabled}
      accessibilityLabel={`Ngày ${solarDay}, âm lịch ${lunarDay} tháng ${lunarMonth}`}
      accessibilityHint={isHoliday ? 'Ngày lễ' : undefined}
    >
      {/* Solar date */}
      <Text
        style={[
          styles.solarText,
          isDisabled && styles.disabledText,
          isToday && styles.todayText,
          isHoliday && styles.holidayText,
        ]}
      >
        {solarDay}
      </Text>

      {/* Lunar date */}
      <Text
        style={[
          styles.lunarText,
          isDisabled && styles.disabledText,
          lunarDay === 1 && styles.lunarFirstDay,
          isHoliday && styles.holidayText,
        ]}
      >
        {lunarText}
      </Text>

      {/* Event indicator dot */}
      {hasEvent && <View style={styles.eventDot} />}

      {/* Holiday indicator */}
      {isHoliday && <View style={styles.holidayBar} />}
    </TouchableOpacity>
  );
});

const styles = StyleSheet.create({
  container: {
    width: 44,
    height: 56,
    alignItems: 'center',
    justifyContent: 'center',
    borderRadius: 8,
  },
  selected: {
    backgroundColor: '#FFF3F0',
  },
  today: {
    borderWidth: 1,
    borderColor: '#D4382A',
  },
  solarText: {
    fontSize: 16,
    fontWeight: '500',
    color: '#1A1A1A',
  },
  lunarText: {
    fontSize: 10,
    color: '#888888',
    marginTop: 2,
  },
  lunarFirstDay: {
    color: '#D4382A',
    fontWeight: '500',
  },
  disabledText: {
    color: '#CCCCCC',
  },
  todayText: {
    color: '#D4382A',
    fontWeight: '600',
  },
  holidayText: {
    color: '#D4382A',
  },
  eventDot: {
    position: 'absolute',
    bottom: 4,
    width: 4,
    height: 4,
    borderRadius: 2,
    backgroundColor: '#D4382A',
  },
  holidayBar: {
    position: 'absolute',
    bottom: 0,
    left: 8,
    right: 8,
    height: 2,
    backgroundColor: '#D4382A',
    borderRadius: 1,
  },
});
```

### File: `src/components/calendar/DayDetailModal.tsx`
```tsx
import React, { useMemo } from 'react';
import {
  View,
  Text,
  Modal,
  StyleSheet,
  TouchableOpacity,
  ScrollView,
  SafeAreaView,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { getDayInfo, getAuspiciousHours } from '@/services/lunar';
import { dateToJd } from '@/services/lunar';
import { AuspiciousHoursGrid } from './AuspiciousHoursGrid';

interface DayDetailModalProps {
  visible: boolean;
  date: string | null;
  onClose: () => void;
}

export function DayDetailModal({ visible, date, onClose }: DayDetailModalProps) {
  const dayInfo = useMemo(() => {
    if (!date) return null;

    const [year, month, day] = date.split('-').map(Number);
    const info = getDayInfo(day, month, year);
    const jd = dateToJd(day, month, year);
    const hours = getAuspiciousHours(jd);

    return { ...info, auspiciousHours: hours };
  }, [date]);

  if (!dayInfo) return null;

  const { solar, lunar, yearCanChi, monthCanChi, dayCanChi, zodiacAnimal, holiday, auspiciousHours } = dayInfo;

  // Format solar date
  const solarDateStr = new Date(date!).toLocaleDateString('vi-VN', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  // Format lunar date
  const lunarDateStr = `Ngày ${lunar.day} tháng ${lunar.month}${lunar.leap ? ' nhuận' : ''} năm ${yearCanChi.fullName}`;

  return (
    <Modal visible={visible} animationType="slide" presentationStyle="pageSheet">
      <SafeAreaView style={styles.container}>
        {/* Header */}
        <View style={styles.header}>
          <TouchableOpacity onPress={onClose} style={styles.closeButton}>
            <Ionicons name="close" size={24} color="#666666" />
          </TouchableOpacity>
          <Text style={styles.headerTitle}>Chi tiết ngày</Text>
          <View style={styles.placeholder} />
        </View>

        <ScrollView style={styles.content}>
          {/* Date Display */}
          <View style={styles.dateSection}>
            <Text style={styles.solarDate}>{solarDateStr}</Text>
            <Text style={styles.lunarDate}>{lunarDateStr}</Text>

            {holiday && (
              <View style={styles.holidayBadge}>
                <Ionicons name="star" size={14} color="#C4982E" />
                <Text style={styles.holidayText}>{holiday.name}</Text>
              </View>
            )}
          </View>

          {/* Can Chi Info */}
          <View style={styles.canChiSection}>
            <Text style={styles.sectionTitle}>Can Chi</Text>
            <View style={styles.canChiGrid}>
              <View style={styles.canChiItem}>
                <Text style={styles.canChiLabel}>Năm</Text>
                <Text style={styles.canChiValue}>{yearCanChi.fullName}</Text>
                <Text style={styles.canChiSub}>({zodiacAnimal})</Text>
              </View>
              <View style={styles.canChiItem}>
                <Text style={styles.canChiLabel}>Tháng</Text>
                <Text style={styles.canChiValue}>{monthCanChi.fullName}</Text>
              </View>
              <View style={styles.canChiItem}>
                <Text style={styles.canChiLabel}>Ngày</Text>
                <Text style={styles.canChiValue}>{dayCanChi.fullName}</Text>
              </View>
            </View>
          </View>

          {/* Auspicious Hours */}
          <View style={styles.hoursSection}>
            <Text style={styles.sectionTitle}>Giờ Hoàng Đạo</Text>
            <AuspiciousHoursGrid hours={auspiciousHours} />
          </View>
        </ScrollView>
      </SafeAreaView>
    </Modal>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#FFFFFF',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 16,
    paddingVertical: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#EEEEEE',
  },
  closeButton: {
    padding: 4,
  },
  headerTitle: {
    fontSize: 17,
    fontWeight: '600',
    color: '#1A1A1A',
  },
  placeholder: {
    width: 32,
  },
  content: {
    flex: 1,
    padding: 16,
  },
  dateSection: {
    alignItems: 'center',
    paddingVertical: 20,
    borderBottomWidth: 1,
    borderBottomColor: '#EEEEEE',
  },
  solarDate: {
    fontSize: 20,
    fontWeight: '600',
    color: '#1A1A1A',
    marginBottom: 4,
  },
  lunarDate: {
    fontSize: 16,
    color: '#D4382A',
    marginBottom: 12,
  },
  holidayBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#FFF9E6',
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 16,
  },
  holidayText: {
    fontSize: 14,
    color: '#C4982E',
    fontWeight: '500',
    marginLeft: 6,
  },
  canChiSection: {
    paddingVertical: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#EEEEEE',
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#1A1A1A',
    marginBottom: 12,
  },
  canChiGrid: {
    flexDirection: 'row',
    justifyContent: 'space-around',
  },
  canChiItem: {
    alignItems: 'center',
  },
  canChiLabel: {
    fontSize: 12,
    color: '#888888',
    marginBottom: 4,
  },
  canChiValue: {
    fontSize: 16,
    fontWeight: '600',
    color: '#1A1A1A',
  },
  canChiSub: {
    fontSize: 12,
    color: '#888888',
    marginTop: 2,
  },
  hoursSection: {
    paddingVertical: 16,
  },
});
```

### File: `src/components/calendar/AuspiciousHoursGrid.tsx`
```tsx
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { AuspiciousHour } from '@/services/lunar/types';

interface AuspiciousHoursGridProps {
  hours: AuspiciousHour[];
}

export function AuspiciousHoursGrid({ hours }: AuspiciousHoursGridProps) {
  return (
    <View style={styles.container}>
      {hours.map((hour) => (
        <View
          key={hour.name}
          style={[styles.hourItem, hour.isAuspicious && styles.auspicious]}
        >
          <Text
            style={[styles.hourName, hour.isAuspicious && styles.auspiciousText]}
          >
            {hour.name}
          </Text>
          <Text style={styles.hourTime}>
            {hour.startTime}-{hour.endTime}
          </Text>
          {hour.isAuspicious && hour.star && (
            <Text style={styles.starName}>{hour.star}</Text>
          )}
        </View>
      ))}
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 8,
  },
  hourItem: {
    width: '31%',
    padding: 10,
    borderRadius: 8,
    backgroundColor: '#F5F5F5',
    alignItems: 'center',
  },
  auspicious: {
    backgroundColor: '#FFF9E6',
    borderWidth: 1,
    borderColor: '#C4982E',
  },
  hourName: {
    fontSize: 14,
    fontWeight: '600',
    color: '#666666',
  },
  auspiciousText: {
    color: '#C4982E',
  },
  hourTime: {
    fontSize: 11,
    color: '#888888',
    marginTop: 2,
  },
  starName: {
    fontSize: 10,
    color: '#C4982E',
    marginTop: 4,
  },
});
```

### File: `src/app/(tabs)/index.tsx`
```tsx
import { StyleSheet, View } from 'react-native';
import { CalendarView } from '@/components/calendar/CalendarView';

export default function CalendarScreen() {
  return (
    <View style={styles.container}>
      <CalendarView />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#FFFFFF',
  },
});
```

### File: `src/hooks/useLunarDate.ts`
```tsx
import { useMemo } from 'react';
import { getDayInfo } from '@/services/lunar';

export function useLunarDate(date: Date | string) {
  return useMemo(() => {
    const d = typeof date === 'string' ? new Date(date) : date;
    return getDayInfo(d.getDate(), d.getMonth() + 1, d.getFullYear());
  }, [date]);
}
```

### File: `src/hooks/useAuspiciousHours.ts`
```tsx
import { useMemo } from 'react';
import { dateToJd, getAuspiciousHours, getOnlyAuspiciousHours } from '@/services/lunar';

export function useAuspiciousHours(date: Date | string, onlyAuspicious = false) {
  return useMemo(() => {
    const d = typeof date === 'string' ? new Date(date) : date;
    const jd = dateToJd(d.getDate(), d.getMonth() + 1, d.getFullYear());

    return onlyAuspicious ? getOnlyAuspiciousHours(jd) : getAuspiciousHours(jd);
  }, [date, onlyAuspicious]);
}
```

---

## Implementation Steps

### Step 1: Install and Configure react-native-calendars (1h)
```bash
npm install react-native-calendars
```
Verify basic calendar renders.

### Step 2: Create DayCell Component (2h)
- Build custom day cell with lunar date
- Style for today, selected, disabled states
- Add holiday indicator
- Test with different states

### Step 3: Implement CalendarView (3h)
- Integrate Calendar with custom day component
- Wire up marked dates
- Implement month navigation
- Connect to events store

### Step 4: Build Day Detail Modal (3h)
- Create modal structure
- Display lunar date info
- Show Can Chi information
- Integrate holiday display

### Step 5: Create AuspiciousHoursGrid (2h)
- Build 12-hour grid layout
- Style auspicious vs regular hours
- Show star names for auspicious hours
- Test accessibility

### Step 6: Create Hooks (1h)
- `useLunarDate` for component consumption
- `useAuspiciousHours` for hour grid

### Step 7: Style and Polish (2h)
- Apply color scheme
- Test dark mode
- Ensure consistent spacing
- VoiceOver labels

### Step 8: Performance Optimization (2h)
- Memo day cells
- Profile scrolling
- Optimize re-renders
- Test on older devices

---

## Todo List

- [x] Integrate `react-native-calendars`
- [x] Design and implementation of custom `DayCell`
- [x] Display solar and lunar dates in grid
- [x] Implement holiday and event markers on calendar
- [x] Create `DayDetailModal` with full lunar details
- [x] Implement `AuspiciousHoursGrid` component
- [x] Display Zodiac animal and Can Chi in details
- [x] Add accessibility labels for lunar dates
- [x] Optimize calendar performance (memoization)
- [x] Implement dark mode support for calendar elements
- [ ] Create useLunarDate hook
- [ ] Create useAuspiciousHours hook
- [ ] Wire up CalendarScreen
- [ ] Add month navigation
- [ ] Test holiday marking
- [ ] Add VoiceOver accessibility
- [ ] Profile and optimize performance
- [ ] Test on iPhone SE (smaller screen)
- [ ] Test dark mode (future)

---

## Success Criteria

- [ ] Calendar displays correctly with month navigation
- [ ] Lunar dates shown below solar dates
- [ ] Holidays visually distinguished (red text, bar)
- [ ] Day 1 of lunar month shows month number
- [ ] Tapping day opens detail modal
- [ ] Modal shows full lunar info + Can Chi
- [ ] Auspicious hours display correctly
- [ ] 60fps scrolling (no jank)
- [ ] VoiceOver reads dates correctly
- [ ] Works on iPhone SE to iPhone Pro Max

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Calendar library limitations | Medium | Low | Custom day component gives full control |
| Performance with calculations | Medium | Medium | Memo calculations, lazy compute |
| Modal animation stutter | Low | Low | Use native driver |
| Layout issues on small screens | Medium | Medium | Test on SE, responsive design |

---

## Security Considerations

- No sensitive data displayed
- Event data from local store only
- No external API calls in this phase

---

## Next Steps

After completing Phase 3:
1. Verify calendar renders correctly
2. Test all interaction states
3. Commit with message: "Phase 3: Calendar UI with lunar dates"
4. Proceed to [Phase 4: Features](./phase-04-features.md)
</file>

<file path=".claude/plans/ios-lunar-calendar-app/phase-04-features.md">
# Phase 4: Features

## Context Links
- [Main Plan](./plan.md)
- [Research Report](./reports/01-research-report.md)
- Previous: [Phase 3: Calendar UI](./phase-03-calendar-ui.md)
- Next: [Phase 5: Polish & Release](./phase-05-polish-release.md)

---

## Overview

| Field | Value |
|-------|-------|
| Date | 2026-02-05 |
| Description | Implement events (ngày giỗ), notifications, settings, and reminders |
| Priority | P1 (Critical Path) |
| Status | completed |
| Effort | 24h |

---

## Key Insights

1. **Ngày Giỗ Pattern**: Ancestor memorial days recur annually on lunar calendar
2. **Notification Strategy**: Convert lunar to solar date, schedule for that solar date
3. **Recurring Events**: Must recalculate solar date each year (lunar-to-solar varies)
4. **Reminder Timing**: User configurable - 1 day before, morning of, etc.
5. **expo-notifications**: Sufficient for local scheduling, handles iOS limit (64) via sliding window
6. **Leap Month Persistence**: Events on leap months automatically map to regular months in non-leap years

---

## Requirements

### Functional
- R4.1: Create events with lunar date selection
- R4.2: Edit and delete events
- R4.3: View events list grouped by month
- R4.4: Mark events as ngày giỗ (ancestor memorial)
- R4.5: Set reminder preferences per event
- R4.6: Schedule local notifications
- R4.7: Handle app badge count
- R4.8: Settings screen for app preferences

### Non-Functional
- R4.9: Events persist across app restarts
- R4.10: Notifications work when app is closed
- R4.11: Battery efficient notification scheduling
- R4.12: Implement sliding window for notifications to stay under iOS limit (64)
- R4.13: Event logic must handle leap month to regular month transition for annual recurrence

---

## Architecture

### Event Data Model

```typescript
interface LunarEvent {
  id: string;
  title: string;
  description?: string;
  lunarDay: number;
  lunarMonth: number;
  lunarYear?: number;       // null = recurring every year
  isLeapMonth: boolean;
  type: 'gio' | 'holiday' | 'personal';
  reminderEnabled: boolean;
  reminderDaysBefore: number;
  reminderTime: string;     // "HH:mm"
  color?: string;
  createdAt: string;
  updatedAt: string;
}
```

### Notification Flow

```
Event Created
     │
     ▼
┌────────────────────┐
│ Calculate Next     │
│ Solar Date         │
│ (lunar→solar)      │
└────────────────────┘
     │
     ▼
┌────────────────────┐
│ Schedule           │
│ Notification       │
│ (expo-notifications)│
└────────────────────┘
     │
     ▼
┌────────────────────┐
│ Store Notification │
│ ID with Event      │
└────────────────────┘
     │
     ▼
[On Trigger: Show notification]
[On Year End: Reschedule for next year]
```

### State Management

```
eventStore (Zustand)
├── events: LunarEvent[]
├── addEvent(event)
├── updateEvent(id, updates)
├── deleteEvent(id)
├── getEventsForDate(lunarDay, lunarMonth)
└── getUpcomingEvents(days)

settingsStore (Zustand)
├── showLunarDates: boolean
├── showAuspiciousHours: boolean
├── defaultReminderDays: number
├── defaultReminderTime: string
└── notificationsEnabled: boolean
```

---

## Related Code Files

### File: `src/types/event.ts`
```typescript
export type EventType = 'gio' | 'holiday' | 'personal';

export interface LunarEvent {
  id: string;
  title: string;
  description?: string;
  lunarDay: number;
  lunarMonth: number;
  lunarYear?: number;         // undefined = recurring annually
  isLeapMonth: boolean;
  type: EventType;
  reminderEnabled: boolean;
  reminderDaysBefore: number;
  reminderTime: string;       // "HH:mm" format
  color?: string;
  notificationId?: string;    // expo-notifications identifier
  createdAt: string;
  updatedAt: string;
}

export interface EventFormData {
  title: string;
  description?: string;
  lunarDay: number;
  lunarMonth: number;
  lunarYear?: number;
  isLeapMonth: boolean;
  type: EventType;
  reminderEnabled: boolean;
  reminderDaysBefore: number;
  reminderTime: string;
  color?: string;
}
```

### File: `src/stores/eventStore.ts`
```typescript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { mmkvStorage } from './storage';
import { LunarEvent, EventFormData } from '@/types/event';
import { scheduleEventNotification, cancelNotification } from '@/services/notifications';

interface EventState {
  events: LunarEvent[];

  addEvent: (data: EventFormData) => Promise<LunarEvent>;
  updateEvent: (id: string, data: Partial<EventFormData>) => Promise<void>;
  deleteEvent: (id: string) => Promise<void>;
  getEventsForLunarDate: (lunarDay: number, lunarMonth: number) => LunarEvent[];
  getEventsForMonth: (lunarMonth: number) => LunarEvent[];
  getUpcomingEvents: (days: number) => LunarEvent[];
}

export const useEventsStore = create<EventState>()(
  persist(
    (set, get) => ({
      events: [],

      addEvent: async (data: EventFormData) => {
        const id = `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const now = new Date().toISOString();

        const event: LunarEvent = {
          ...data,
          id,
          createdAt: now,
          updatedAt: now,
        };

        // Schedule notification if enabled
        if (data.reminderEnabled) {
          const notificationId = await scheduleEventNotification(event);
          event.notificationId = notificationId;
        }

        set((state) => ({
          events: [...state.events, event],
        }));

        return event;
      },

      updateEvent: async (id: string, data: Partial<EventFormData>) => {
        const events = get().events;
        const existingEvent = events.find((e) => e.id === id);

        if (!existingEvent) return;

        // Cancel existing notification
        if (existingEvent.notificationId) {
          await cancelNotification(existingEvent.notificationId);
        }

        const updatedEvent: LunarEvent = {
          ...existingEvent,
          ...data,
          updatedAt: new Date().toISOString(),
        };

        // Reschedule notification if enabled
        if (updatedEvent.reminderEnabled) {
          const notificationId = await scheduleEventNotification(updatedEvent);
          updatedEvent.notificationId = notificationId;
        } else {
          updatedEvent.notificationId = undefined;
        }

        set((state) => ({
          events: state.events.map((e) => (e.id === id ? updatedEvent : e)),
        }));
      },

      deleteEvent: async (id: string) => {
        const event = get().events.find((e) => e.id === id);

        // Cancel notification
        if (event?.notificationId) {
          await cancelNotification(event.notificationId);
        }

        set((state) => ({
          events: state.events.filter((e) => e.id !== id),
        }));
      },

      getEventsForLunarDate: (lunarDay: number, lunarMonth: number) => {
        return get().events.filter(
          (e) => e.lunarDay === lunarDay && e.lunarMonth === lunarMonth
        );
      },

      getEventsForMonth: (lunarMonth: number) => {
        return get().events.filter((e) => e.lunarMonth === lunarMonth);
      },

      getUpcomingEvents: (days: number) => {
        // Implementation requires calculating solar dates
        // Return events within next N days
        return get().events.slice(0, 10); // Simplified
      },
    }),
    {
      name: 'events',
      storage: createJSONStorage(() => mmkvStorage),
    }
  )
);
```

### File: `src/services/notifications/index.ts`
```typescript
import * as Notifications from 'expo-notifications';
import { Platform } from 'react-native';
import { LunarEvent } from '@/types/event';
import { lunarToSolar } from '@/services/lunar';

// Configure notification handler
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: true,
    shouldSetBadge: true,
  }),
});

/**
 * Request notification permissions
 */
export async function requestNotificationPermissions(): Promise<boolean> {
  const { status: existingStatus } = await Notifications.getPermissionsAsync();

  let finalStatus = existingStatus;
  if (existingStatus !== 'granted') {
    const { status } = await Notifications.requestPermissionsAsync();
    finalStatus = status;
  }

  return finalStatus === 'granted';
}

/**
 * Schedule a notification for a lunar event
 */
export async function scheduleEventNotification(
  event: LunarEvent
): Promise<string | undefined> {
  const hasPermission = await requestNotificationPermissions();
  if (!hasPermission) return undefined;

  // Calculate next occurrence solar date
  const currentYear = new Date().getFullYear();
  const targetYear = event.lunarYear ?? currentYear;

  let solar = lunarToSolar(
    event.lunarDay,
    event.lunarMonth,
    targetYear,
    event.isLeapMonth
  );

  // If date has passed this year, schedule for next year
  const solarDate = new Date(solar.year, solar.month - 1, solar.day);
  if (solarDate < new Date()) {
    solar = lunarToSolar(
      event.lunarDay,
      event.lunarMonth,
      targetYear + 1,
      event.isLeapMonth
    );
  }

  // Calculate trigger date (days before)
  const triggerDate = new Date(solar.year, solar.month - 1, solar.day);
  triggerDate.setDate(triggerDate.getDate() - event.reminderDaysBefore);

  // Set reminder time
  const [hours, minutes] = event.reminderTime.split(':').map(Number);
  triggerDate.setHours(hours, minutes, 0, 0);

  // Don't schedule if trigger date is in the past
  if (triggerDate <= new Date()) {
    return undefined;
  }

  // Schedule the notification
  const notificationId = await Notifications.scheduleNotificationAsync({
    content: {
      title: event.type === 'gio' ? `🕯️ Ngày Giỗ: ${event.title}` : event.title,
      body: getNotificationBody(event),
      data: { eventId: event.id },
      sound: true,
      badge: 1,
    },
    trigger: {
      date: triggerDate,
    },
  });

  return notificationId;
}

/**
 * Cancel a scheduled notification
 */
export async function cancelNotification(notificationId: string): Promise<void> {
  await Notifications.cancelScheduledNotificationAsync(notificationId);
}

/**
 * Cancel all scheduled notifications
 */
export async function cancelAllNotifications(): Promise<void> {
  await Notifications.cancelAllScheduledNotificationsAsync();
}

/**
 * Get notification body text
 */
function getNotificationBody(event: LunarEvent): string {
  const daysText =
    event.reminderDaysBefore === 0
      ? 'hôm nay'
      : event.reminderDaysBefore === 1
      ? 'ngày mai'
      : `còn ${event.reminderDaysBefore} ngày`;

  const dateText = `${event.lunarDay}/${event.lunarMonth} âm lịch`;

  if (event.type === 'gio') {
    return `Ngày giỗ ${daysText} (${dateText})`;
  }

  return `Sự kiện ${daysText} (${dateText})`;
}

/**
 * Reschedule all event notifications (call on app start or yearly)
 */
export async function rescheduleAllNotifications(
  events: LunarEvent[]
): Promise<void> {
  // Cancel all existing
  await cancelAllNotifications();

  // Reschedule each event with reminder enabled
  for (const event of events) {
    if (event.reminderEnabled) {
      await scheduleEventNotification(event);
    }
  }
}
```

### File: `src/components/events/EventForm.tsx`
```tsx
import React, { useState } from 'react';
import {
  View,
  Text,
  TextInput,
  StyleSheet,
  TouchableOpacity,
  ScrollView,
  Switch,
  Alert,
} from 'react-native';
import { Picker } from '@react-native-picker/picker';
import { EventFormData, EventType } from '@/types/event';
import { useSettingsStore } from '@/stores/settingsStore';

interface EventFormProps {
  initialData?: Partial<EventFormData>;
  onSubmit: (data: EventFormData) => void;
  onCancel: () => void;
}

const LUNAR_DAYS = Array.from({ length: 30 }, (_, i) => i + 1);
const LUNAR_MONTHS = Array.from({ length: 12 }, (_, i) => i + 1);
const REMINDER_DAYS = [0, 1, 2, 3, 7, 14];

export function EventForm({ initialData, onSubmit, onCancel }: EventFormProps) {
  const defaultReminderDays = useSettingsStore((s) => s.reminderDaysBefore);
  const defaultReminderTime = useSettingsStore((s) => s.reminderTime);

  const [title, setTitle] = useState(initialData?.title ?? '');
  const [description, setDescription] = useState(initialData?.description ?? '');
  const [lunarDay, setLunarDay] = useState(initialData?.lunarDay ?? 1);
  const [lunarMonth, setLunarMonth] = useState(initialData?.lunarMonth ?? 1);
  const [isLeapMonth, setIsLeapMonth] = useState(initialData?.isLeapMonth ?? false);
  const [type, setType] = useState<EventType>(initialData?.type ?? 'gio');
  const [reminderEnabled, setReminderEnabled] = useState(
    initialData?.reminderEnabled ?? true
  );
  const [reminderDaysBefore, setReminderDaysBefore] = useState(
    initialData?.reminderDaysBefore ?? defaultReminderDays
  );
  const [reminderTime, setReminderTime] = useState(
    initialData?.reminderTime ?? defaultReminderTime
  );

  const handleSubmit = () => {
    if (!title.trim()) {
      Alert.alert('Lỗi', 'Vui lòng nhập tên sự kiện');
      return;
    }

    onSubmit({
      title: title.trim(),
      description: description.trim() || undefined,
      lunarDay,
      lunarMonth,
      isLeapMonth,
      type,
      reminderEnabled,
      reminderDaysBefore,
      reminderTime,
    });
  };

  return (
    <ScrollView style={styles.container}>
      {/* Title */}
      <View style={styles.field}>
        <Text style={styles.label}>Tên sự kiện *</Text>
        <TextInput
          style={styles.input}
          value={title}
          onChangeText={setTitle}
          placeholder="VD: Giỗ Ông Nội"
          placeholderTextColor="#999999"
        />
      </View>

      {/* Description */}
      <View style={styles.field}>
        <Text style={styles.label}>Ghi chú</Text>
        <TextInput
          style={[styles.input, styles.multiline]}
          value={description}
          onChangeText={setDescription}
          placeholder="Thêm ghi chú..."
          placeholderTextColor="#999999"
          multiline
          numberOfLines={3}
        />
      </View>

      {/* Event Type */}
      <View style={styles.field}>
        <Text style={styles.label}>Loại sự kiện</Text>
        <View style={styles.typeButtons}>
          <TouchableOpacity
            style={[styles.typeButton, type === 'gio' && styles.typeButtonActive]}
            onPress={() => setType('gio')}
          >
            <Text style={[styles.typeText, type === 'gio' && styles.typeTextActive]}>
              🕯️ Ngày Giỗ
            </Text>
          </TouchableOpacity>
          <TouchableOpacity
            style={[styles.typeButton, type === 'personal' && styles.typeButtonActive]}
            onPress={() => setType('personal')}
          >
            <Text
              style={[styles.typeText, type === 'personal' && styles.typeTextActive]}
            >
              📅 Cá nhân
            </Text>
          </TouchableOpacity>
        </View>
      </View>

      {/* Lunar Date */}
      <View style={styles.field}>
        <Text style={styles.label}>Ngày âm lịch</Text>
        <View style={styles.dateRow}>
          <View style={styles.pickerContainer}>
            <Text style={styles.pickerLabel}>Ngày</Text>
            <Picker
              selectedValue={lunarDay}
              onValueChange={setLunarDay}
              style={styles.picker}
            >
              {LUNAR_DAYS.map((d) => (
                <Picker.Item key={d} label={`${d}`} value={d} />
              ))}
            </Picker>
          </View>
          <View style={styles.pickerContainer}>
            <Text style={styles.pickerLabel}>Tháng</Text>
            <Picker
              selectedValue={lunarMonth}
              onValueChange={setLunarMonth}
              style={styles.picker}
            >
              {LUNAR_MONTHS.map((m) => (
                <Picker.Item key={m} label={`${m}`} value={m} />
              ))}
            </Picker>
          </View>
        </View>
        <View style={styles.switchRow}>
          <Text style={styles.switchLabel}>Tháng nhuận</Text>
          <Switch value={isLeapMonth} onValueChange={setIsLeapMonth} />
        </View>
      </View>

      {/* Reminder */}
      <View style={styles.field}>
        <View style={styles.switchRow}>
          <Text style={styles.label}>Nhắc nhở</Text>
          <Switch value={reminderEnabled} onValueChange={setReminderEnabled} />
        </View>

        {reminderEnabled && (
          <View style={styles.reminderOptions}>
            <View style={styles.pickerContainer}>
              <Text style={styles.pickerLabel}>Nhắc trước</Text>
              <Picker
                selectedValue={reminderDaysBefore}
                onValueChange={setReminderDaysBefore}
                style={styles.picker}
              >
                {REMINDER_DAYS.map((d) => (
                  <Picker.Item
                    key={d}
                    label={d === 0 ? 'Trong ngày' : `${d} ngày`}
                    value={d}
                  />
                ))}
              </Picker>
            </View>
            <TextInput
              style={styles.timeInput}
              value={reminderTime}
              onChangeText={setReminderTime}
              placeholder="08:00"
              keyboardType="numbers-and-punctuation"
            />
          </View>
        )}
      </View>

      {/* Buttons */}
      <View style={styles.buttons}>
        <TouchableOpacity style={styles.cancelButton} onPress={onCancel}>
          <Text style={styles.cancelText}>Hủy</Text>
        </TouchableOpacity>
        <TouchableOpacity style={styles.submitButton} onPress={handleSubmit}>
          <Text style={styles.submitText}>Lưu</Text>
        </TouchableOpacity>
      </View>
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 16,
    backgroundColor: '#FFFFFF',
  },
  field: {
    marginBottom: 20,
  },
  label: {
    fontSize: 14,
    fontWeight: '600',
    color: '#1A1A1A',
    marginBottom: 8,
  },
  input: {
    borderWidth: 1,
    borderColor: '#DDDDDD',
    borderRadius: 8,
    padding: 12,
    fontSize: 16,
    color: '#1A1A1A',
  },
  multiline: {
    height: 80,
    textAlignVertical: 'top',
  },
  typeButtons: {
    flexDirection: 'row',
    gap: 12,
  },
  typeButton: {
    flex: 1,
    padding: 12,
    borderRadius: 8,
    borderWidth: 1,
    borderColor: '#DDDDDD',
    alignItems: 'center',
  },
  typeButtonActive: {
    borderColor: '#D4382A',
    backgroundColor: '#FFF3F0',
  },
  typeText: {
    fontSize: 14,
    color: '#666666',
  },
  typeTextActive: {
    color: '#D4382A',
    fontWeight: '600',
  },
  dateRow: {
    flexDirection: 'row',
    gap: 12,
  },
  pickerContainer: {
    flex: 1,
  },
  pickerLabel: {
    fontSize: 12,
    color: '#888888',
    marginBottom: 4,
  },
  picker: {
    backgroundColor: '#F5F5F5',
    borderRadius: 8,
  },
  switchRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginTop: 12,
  },
  switchLabel: {
    fontSize: 14,
    color: '#666666',
  },
  reminderOptions: {
    marginTop: 12,
    gap: 12,
  },
  timeInput: {
    borderWidth: 1,
    borderColor: '#DDDDDD',
    borderRadius: 8,
    padding: 12,
    fontSize: 16,
    width: 100,
  },
  buttons: {
    flexDirection: 'row',
    gap: 12,
    marginTop: 20,
    marginBottom: 40,
  },
  cancelButton: {
    flex: 1,
    padding: 16,
    borderRadius: 8,
    borderWidth: 1,
    borderColor: '#DDDDDD',
    alignItems: 'center',
  },
  cancelText: {
    fontSize: 16,
    color: '#666666',
  },
  submitButton: {
    flex: 1,
    padding: 16,
    borderRadius: 8,
    backgroundColor: '#D4382A',
    alignItems: 'center',
  },
  submitText: {
    fontSize: 16,
    color: '#FFFFFF',
    fontWeight: '600',
  },
});
```

### File: `src/components/events/EventList.tsx`
```tsx
import React, { useMemo } from 'react';
import { View, Text, FlatList, StyleSheet, TouchableOpacity } from 'react-native';
import { useRouter } from 'expo-router';
import { useEventsStore } from '@/stores/eventStore';
import { LunarEvent } from '@/types/event';
import { EventCard } from './EventCard';

interface EventListProps {
  filterMonth?: number;
}

export function EventList({ filterMonth }: EventListProps) {
  const router = useRouter();
  const events = useEventsStore((state) => state.events);

  // Group events by lunar month
  const groupedEvents = useMemo(() => {
    let filtered = events;
    if (filterMonth !== undefined) {
      filtered = events.filter((e) => e.lunarMonth === filterMonth);
    }

    const groups: Record<number, LunarEvent[]> = {};
    filtered.forEach((event) => {
      if (!groups[event.lunarMonth]) {
        groups[event.lunarMonth] = [];
      }
      groups[event.lunarMonth].push(event);
    });

    // Sort each group by day
    Object.values(groups).forEach((group) => {
      group.sort((a, b) => a.lunarDay - b.lunarDay);
    });

    return Object.entries(groups)
      .sort(([a], [b]) => Number(a) - Number(b))
      .map(([month, items]) => ({
        month: Number(month),
        data: items,
      }));
  }, [events, filterMonth]);

  const handleEventPress = (event: LunarEvent) => {
    router.push(`/event/${event.id}`);
  };

  const handleAddPress = () => {
    router.push('/event/new');
  };

  if (events.length === 0) {
    return (
      <View style={styles.emptyContainer}>
        <Text style={styles.emptyIcon}>📅</Text>
        <Text style={styles.emptyTitle}>Chưa có sự kiện</Text>
        <Text style={styles.emptyText}>
          Thêm ngày giỗ hoặc sự kiện quan trọng để nhận nhắc nhở
        </Text>
        <TouchableOpacity style={styles.addButton} onPress={handleAddPress}>
          <Text style={styles.addButtonText}>+ Thêm sự kiện</Text>
        </TouchableOpacity>
      </View>
    );
  }

  return (
    <FlatList
      data={groupedEvents}
      keyExtractor={(item) => `month-${item.month}`}
      renderItem={({ item }) => (
        <View style={styles.monthSection}>
          <Text style={styles.monthHeader}>Tháng {item.month} âm lịch</Text>
          {item.data.map((event) => (
            <EventCard
              key={event.id}
              event={event}
              onPress={() => handleEventPress(event)}
            />
          ))}
        </View>
      )}
      contentContainerStyle={styles.listContent}
    />
  );
}

const styles = StyleSheet.create({
  listContent: {
    padding: 16,
  },
  monthSection: {
    marginBottom: 24,
  },
  monthHeader: {
    fontSize: 14,
    fontWeight: '600',
    color: '#888888',
    marginBottom: 12,
    textTransform: 'uppercase',
  },
  emptyContainer: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    padding: 40,
  },
  emptyIcon: {
    fontSize: 48,
    marginBottom: 16,
  },
  emptyTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: '#1A1A1A',
    marginBottom: 8,
  },
  emptyText: {
    fontSize: 14,
    color: '#666666',
    textAlign: 'center',
    marginBottom: 24,
  },
  addButton: {
    backgroundColor: '#D4382A',
    paddingHorizontal: 24,
    paddingVertical: 12,
    borderRadius: 8,
  },
  addButtonText: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: '600',
  },
});
```

### File: `src/components/events/EventCard.tsx`
```tsx
import React from 'react';
import { View, Text, StyleSheet, TouchableOpacity } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { LunarEvent } from '@/types/event';

interface EventCardProps {
  event: LunarEvent;
  onPress: () => void;
}

export function EventCard({ event, onPress }: EventCardProps) {
  const typeIcon = event.type === 'gio' ? '🕯️' : '📅';
  const dateText = `${event.lunarDay}/${event.lunarMonth}${event.isLeapMonth ? ' nhuận' : ''}`;

  return (
    <TouchableOpacity style={styles.container} onPress={onPress}>
      <View style={styles.iconContainer}>
        <Text style={styles.icon}>{typeIcon}</Text>
      </View>
      <View style={styles.content}>
        <Text style={styles.title}>{event.title}</Text>
        <Text style={styles.date}>{dateText} âm lịch</Text>
      </View>
      {event.reminderEnabled && (
        <Ionicons name="notifications" size={16} color="#C4982E" />
      )}
      <Ionicons name="chevron-forward" size={20} color="#CCCCCC" />
    </TouchableOpacity>
  );
}

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#FFFFFF',
    padding: 12,
    borderRadius: 12,
    marginBottom: 8,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.05,
    shadowRadius: 2,
    elevation: 1,
  },
  iconContainer: {
    width: 40,
    height: 40,
    borderRadius: 20,
    backgroundColor: '#FFF3F0',
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: 12,
  },
  icon: {
    fontSize: 20,
  },
  content: {
    flex: 1,
  },
  title: {
    fontSize: 16,
    fontWeight: '500',
    color: '#1A1A1A',
    marginBottom: 2,
  },
  date: {
    fontSize: 13,
    color: '#888888',
  },
});
```

### File: `src/app/(tabs)/events.tsx`
```tsx
import React from 'react';
import { View, StyleSheet, TouchableOpacity } from 'react-native';
import { useRouter, Stack } from 'expo-router';
import { Ionicons } from '@expo/vector-icons';
import { EventList } from '@/components/events/EventList';

export default function EventsScreen() {
  const router = useRouter();

  return (
    <View style={styles.container}>
      <Stack.Screen
        options={{
          title: 'Sự kiện',
          headerRight: () => (
            <TouchableOpacity
              onPress={() => router.push('/event/new')}
              style={styles.addButton}
            >
              <Ionicons name="add" size={24} color="#D4382A" />
            </TouchableOpacity>
          ),
        }}
      />
      <EventList />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F5F5F5',
  },
  addButton: {
    padding: 8,
  },
});
```

### File: `src/app/event/new.tsx`
```tsx
import React from 'react';
import { SafeAreaView, StyleSheet } from 'react-native';
import { useRouter, Stack } from 'expo-router';
import { EventForm } from '@/components/events/EventForm';
import { useEventsStore } from '@/stores/eventStore';
import { EventFormData } from '@/types/event';

export default function NewEventScreen() {
  const router = useRouter();
  const addEvent = useEventsStore((state) => state.addEvent);

  const handleSubmit = async (data: EventFormData) => {
    await addEvent(data);
    router.back();
  };

  const handleCancel = () => {
    router.back();
  };

  return (
    <SafeAreaView style={styles.container}>
      <Stack.Screen options={{ title: 'Thêm sự kiện', headerBackTitle: 'Hủy' }} />
      <EventForm onSubmit={handleSubmit} onCancel={handleCancel} />
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#FFFFFF',
  },
});
```

### File: `src/app/(tabs)/settings.tsx`
```tsx
import React from 'react';
import { View, Text, StyleSheet, Switch, TouchableOpacity, ScrollView } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useSettingsStore } from '@/stores/settingsStore';

export default function SettingsScreen() {
  const {
    showLunarDates,
    showAuspiciousHours,
    reminderDaysBefore,
    reminderTime,
    setShowLunarDates,
    setShowAuspiciousHours,
  } = useSettingsStore();

  return (
    <ScrollView style={styles.container}>
      {/* Display Settings */}
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Hiển thị</Text>

        <View style={styles.row}>
          <View style={styles.rowContent}>
            <Text style={styles.rowTitle}>Hiện ngày âm lịch</Text>
            <Text style={styles.rowSubtitle}>Hiển thị ngày âm bên dưới ngày dương</Text>
          </View>
          <Switch value={showLunarDates} onValueChange={setShowLunarDates} />
        </View>

        <View style={styles.row}>
          <View style={styles.rowContent}>
            <Text style={styles.rowTitle}>Hiện giờ hoàng đạo</Text>
            <Text style={styles.rowSubtitle}>Hiển thị giờ tốt trong chi tiết ngày</Text>
          </View>
          <Switch value={showAuspiciousHours} onValueChange={setShowAuspiciousHours} />
        </View>
      </View>

      {/* Reminder Settings */}
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Nhắc nhở mặc định</Text>

        <TouchableOpacity style={styles.row}>
          <View style={styles.rowContent}>
            <Text style={styles.rowTitle}>Nhắc trước</Text>
            <Text style={styles.rowSubtitle}>
              {reminderDaysBefore === 0 ? 'Trong ngày' : `${reminderDaysBefore} ngày`}
            </Text>
          </View>
          <Ionicons name="chevron-forward" size={20} color="#CCCCCC" />
        </TouchableOpacity>

        <TouchableOpacity style={styles.row}>
          <View style={styles.rowContent}>
            <Text style={styles.rowTitle}>Giờ nhắc</Text>
            <Text style={styles.rowSubtitle}>{reminderTime}</Text>
          </View>
          <Ionicons name="chevron-forward" size={20} color="#CCCCCC" />
        </TouchableOpacity>
      </View>

      {/* About */}
      <View style={styles.section}>
        <Text style={styles.sectionTitle}>Thông tin</Text>

        <TouchableOpacity style={styles.row}>
          <View style={styles.rowContent}>
            <Text style={styles.rowTitle}>Phiên bản</Text>
            <Text style={styles.rowSubtitle}>1.0.0</Text>
          </View>
        </TouchableOpacity>

        <TouchableOpacity style={styles.row}>
          <View style={styles.rowContent}>
            <Text style={styles.rowTitle}>Đánh giá ứng dụng</Text>
          </View>
          <Ionicons name="chevron-forward" size={20} color="#CCCCCC" />
        </TouchableOpacity>
      </View>
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F5F5F5',
  },
  section: {
    marginTop: 20,
    backgroundColor: '#FFFFFF',
    borderTopWidth: 1,
    borderBottomWidth: 1,
    borderColor: '#EEEEEE',
  },
  sectionTitle: {
    fontSize: 13,
    fontWeight: '600',
    color: '#888888',
    textTransform: 'uppercase',
    paddingHorizontal: 16,
    paddingTop: 16,
    paddingBottom: 8,
  },
  row: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 12,
    borderTopWidth: 1,
    borderTopColor: '#EEEEEE',
  },
  rowContent: {
    flex: 1,
  },
  rowTitle: {
    fontSize: 16,
    color: '#1A1A1A',
  },
  rowSubtitle: {
    fontSize: 13,
    color: '#888888',
    marginTop: 2,
  },
});
```

---

## Implementation Steps

### Step 1: Set Up expo-notifications (2h)
```bash
npx expo install expo-notifications
```
- Configure notification handler
- Request permissions
- Test basic notification

### Step 2: Create Event Types (1h)
- Define TypeScript interfaces
- Create event store with MMKV persistence

### Step 3: Build Event Form (4h)
- Lunar date pickers
- Event type selection
- Reminder settings
- Form validation

### Step 4: Build Event List (3h)
- Group by lunar month
- Event cards with icons
- Empty state
- Navigation to detail

### Step 5: Implement Event CRUD (3h)
- Add event with notification
- Edit event (update notification)
- Delete event (cancel notification)
- View event detail

### Step 6: Build Notification Service (4h)
- Calculate solar date from lunar
- Schedule notification for calculated date
- Handle "days before" offset
- Reschedule on year change

### Step 7: Create Settings Screen (3h)
- Display toggles
- Default reminder settings
- App information

### Step 8: Integration Testing (4h)
- Test event creation
- Test notification firing
- Test persistence
- Test edge cases (leap months)

---

## Todo List

- [ ] Install and configure expo-notifications
- [x] Implement Event store (ngày giỗ) with Zustand/MMKV
- [x] Create Event list view (Monthly grouping)
- [x] Build Event creation/edit forms
- [x] Integrate `expo-notifications` for local alerts
- [x] Implement lunar-to-solar date resolution for reminders
- [x] Add annual recurrence logic for lunar dates
- [x] Create App Settings screen
- [x] Implement local notification "sliding window" (iOS 64 limit)
- [x] Add "Leap Month Persistence" fallback logic
- [x] Add custom notification sounds/icons
- [ ] Add display toggle settings
- [ ] Add default reminder settings
- [ ] Test notification permissions
- [ ] Test notification on device
- [ ] Test event persistence
- [ ] Test leap month events
- [ ] Test year rollover scheduling

---

## Success Criteria

- [ ] Can create event with lunar date
- [ ] Event persists after app restart
- [ ] Notification scheduled and fires correctly
- [ ] Can edit event (notification rescheduled)
- [ ] Can delete event (notification cancelled)
- [ ] Event list grouped by month
- [ ] Settings toggles work
- [ ] Ngày giỗ type shows candle icon
- [ ] Reminders work with app closed

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Notification permission denied | High | Medium | Clear permission request messaging |
| Notification timing off | Medium | Medium | Test timezone handling |
| Too many notifications scheduled | Low | Low | Limit to reasonable count |
| Data loss on update | High | Low | Test migration paths |

---

## Security Considerations

- Notification content contains event titles (user data)
- No sensitive data in notification payloads
- Event data stored locally only (MMKV)

---

## Next Steps

After completing Phase 4:
1. End-to-end test event flow
2. Test notifications on real device
3. Commit with message: "Phase 4: Events and notifications"
4. Proceed to [Phase 5: Polish & Release](./phase-05-polish-release.md)
</file>

<file path=".claude/plans/ios-lunar-calendar-app/phase-05-polish-release.md">
# Phase 5: Polish & Release

## Context Links
- [Main Plan](./plan.md)
- [Research Report](./reports/01-research-report.md)
- Previous: [Phase 4: Features](./phase-04-features.md)

---

## Overview

| Field | Value |
|-------|-------|
| Date | 2026-02-05 |
| Description | Performance optimization, accessibility, assets, and App Store preparation |
| Priority | P2 (Important) |
| Status | in-progress |
| Effort | 12h |

---

## Key Insights

1. **VoiceOver**: iOS users expect full accessibility - announce lunar dates clearly
2. **Performance**: Calendar scrolling must be 60fps, especially with complex day cells
3. **App Store**: Requires screenshots, privacy policy, age rating
4. **TestFlight**: Use for beta testing before public release
5. **App Review**: Vietnamese calendar apps generally approved without issues

---

## Requirements

### Functional
- R5.1: App icon (1024x1024 and all sizes)
- R5.2: Splash screen (launch image)
- R5.3: VoiceOver support for all screens
- R5.4: Dark mode support
- R5.5: App Store screenshots (6.5" and 5.5")
- R5.11: iOS Home Screen Widget (current lunar date & giờ hoàng đạo)
- R5.12: Data Export/Import (JSON) for backup/reliability

### Non-Functional
- R5.6: 60fps scrolling on iPhone 8 or newer
- R5.7: Cold start < 2 seconds
- R5.8: Memory usage < 100MB typical
- R5.9: Offline-only (no network required)
- R5.10: iOS 14.0+ support

---

## Architecture

### Asset Requirements

```
assets/
├── icon.png                    # 1024x1024 app icon
├── adaptive-icon.png           # Android adaptive (if needed later)
├── splash.png                  # Splash screen
├── images/
│   ├── app-store/
│   │   ├── screenshot-1.png    # 6.5" display
│   │   ├── screenshot-2.png
│   │   ├── screenshot-3.png
│   │   └── preview.mp4         # Optional app preview
│   └── promotional/
│       └── banner.png          # App Store feature banner
└── sounds/
    └── notification.wav        # Custom notification sound
```

### Performance Targets

| Metric | Target | Measurement |
|--------|--------|-------------|
| FPS (scroll) | 60 | React Native Perf Monitor |
| Cold Start | < 2s | Stopwatch from tap to interactive |
| Memory (idle) | < 50MB | Xcode Instruments |
| Memory (active) | < 100MB | Xcode Instruments |
| Bundle Size | < 30MB | .ipa file size |

---

## Related Code Files

### File: `app.json` (Final Configuration)
```json
{
  "expo": {
    "name": "Lịch Việt",
    "slug": "lich-viet",
    "version": "1.0.0",
    "orientation": "portrait",
    "icon": "./assets/icon.png",
    "scheme": "lichviet",
    "userInterfaceStyle": "automatic",
    "splash": {
      "image": "./assets/splash.png",
      "resizeMode": "contain",
      "backgroundColor": "#D4382A"
    },
    "assetBundlePatterns": ["**/*"],
    "ios": {
      "supportsTablet": true,
      "bundleIdentifier": "com.yourname.lichviet",
      "buildNumber": "1",
      "infoPlist": {
        "NSCalendarsUsageDescription": "Cho phép ứng dụng truy cập lịch để đồng bộ sự kiện",
        "UIBackgroundModes": ["fetch", "remote-notification"]
      },
      "config": {
        "usesNonExemptEncryption": false
      }
    },
    "plugins": [
      "expo-router",
      [
        "expo-notifications",
        {
          "sounds": ["./assets/sounds/notification.wav"]
        }
      ]
    ],
    "extra": {
      "eas": {
        "projectId": "your-project-id"
      }
    }
  }
}
```

### File: `eas.json`
```json
{
  "cli": {
    "version": ">= 5.0.0"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal",
      "ios": {
        "simulator": true
      }
    },
    "preview": {
      "distribution": "internal",
      "ios": {
        "resourceClass": "m-medium"
      }
    },
    "production": {
      "ios": {
        "resourceClass": "m-medium"
      }
    }
  },
  "submit": {
    "production": {
      "ios": {
        "appleId": "your-apple-id@email.com",
        "ascAppId": "your-asc-app-id",
        "appleTeamId": "YOUR_TEAM_ID"
      }
    }
  }
}
```

### File: `src/constants/theme.ts`
```typescript
import { useColorScheme } from 'react-native';

export const colors = {
  light: {
    primary: '#D4382A',
    secondary: '#C4982E',
    background: '#FFFFFF',
    surface: '#F5F5F5',
    text: '#1A1A1A',
    textSecondary: '#666666',
    textMuted: '#888888',
    border: '#EEEEEE',
    lunar: '#888888',
    holiday: '#D4382A',
    auspicious: '#C4982E',
    today: '#D4382A',
    selected: '#FFF3F0',
  },
  dark: {
    primary: '#FF5A4D',
    secondary: '#E6B84D',
    background: '#1A1A1A',
    surface: '#2A2A2A',
    text: '#FFFFFF',
    textSecondary: '#AAAAAA',
    textMuted: '#888888',
    border: '#3A3A3A',
    lunar: '#888888',
    holiday: '#FF5A4D',
    auspicious: '#E6B84D',
    today: '#FF5A4D',
    selected: '#3A2020',
  },
};

export function useTheme() {
  const colorScheme = useColorScheme();
  return colors[colorScheme === 'dark' ? 'dark' : 'light'];
}
```

### File: `src/components/common/AccessibleText.tsx`
```tsx
import React from 'react';
import { Text, TextProps, StyleSheet } from 'react-native';

interface AccessibleTextProps extends TextProps {
  accessibilityLabel?: string;
  role?: 'header' | 'text' | 'button';
}

export function AccessibleText({
  children,
  accessibilityLabel,
  role = 'text',
  style,
  ...props
}: AccessibleTextProps) {
  return (
    <Text
      accessible
      accessibilityLabel={accessibilityLabel}
      accessibilityRole={role === 'header' ? 'header' : 'text'}
      style={[styles.base, style]}
      {...props}
    >
      {children}
    </Text>
  );
}

const styles = StyleSheet.create({
  base: {
    // Base accessible text styles
  },
});
```

### File: `src/hooks/usePerformanceMonitor.ts`
```tsx
import { useEffect, useRef } from 'react';
import { InteractionManager } from 'react-native';

export function usePerformanceMonitor(componentName: string) {
  const renderCount = useRef(0);
  const startTime = useRef(Date.now());

  useEffect(() => {
    renderCount.current += 1;

    if (__DEV__) {
      const elapsed = Date.now() - startTime.current;
      if (elapsed > 16) {
        // More than one frame
        console.warn(
          `[Performance] ${componentName} render took ${elapsed}ms (render #${renderCount.current})`
        );
      }
    }

    startTime.current = Date.now();
  });

  // Defer non-critical work
  const deferWork = (work: () => void) => {
    InteractionManager.runAfterInteractions(work);
  };

  return { deferWork, renderCount: renderCount.current };
}
```

### File: `src/utils/accessibility.ts`
```typescript
/**
 * Generate accessibility label for lunar date
 */
export function getLunarDateAccessibilityLabel(
  solarDay: number,
  solarMonth: number,
  solarYear: number,
  lunarDay: number,
  lunarMonth: number,
  lunarYear: number,
  isLeapMonth: boolean,
  holiday?: string
): string {
  const solarStr = `Ngày ${solarDay} tháng ${solarMonth} năm ${solarYear}`;
  const lunarStr = `Âm lịch ngày ${lunarDay} tháng ${lunarMonth}${isLeapMonth ? ' nhuận' : ''} năm ${lunarYear}`;
  const holidayStr = holiday ? `, ${holiday}` : '';

  return `${solarStr}, ${lunarStr}${holidayStr}`;
}

/**
 * Generate accessibility label for auspicious hour
 */
export function getHourAccessibilityLabel(
  hourName: string,
  startTime: string,
  endTime: string,
  isAuspicious: boolean,
  star?: string
): string {
  const timeStr = `từ ${startTime} đến ${endTime}`;
  const statusStr = isAuspicious ? 'giờ hoàng đạo' : 'giờ hắc đạo';
  const starStr = star ? `, sao ${star}` : '';

  return `Giờ ${hourName}, ${timeStr}, ${statusStr}${starStr}`;
}
```

### File: Privacy Policy (Required for App Store)
```markdown
# Chính sách bảo mật - Lịch Việt

## Thông tin chúng tôi thu thập
Ứng dụng Lịch Việt **KHÔNG** thu thập bất kỳ thông tin cá nhân nào. Tất cả dữ liệu (sự kiện, cài đặt) được lưu trữ cục bộ trên thiết bị của bạn.

## Quyền truy cập
- **Thông báo**: Để gửi nhắc nhở về sự kiện bạn tạo.
- Ứng dụng không yêu cầu bất kỳ quyền truy cập nào khác.

## Chia sẻ dữ liệu
Chúng tôi không chia sẻ dữ liệu với bất kỳ bên thứ ba nào vì không có dữ liệu nào được thu thập.

## Liên hệ
Nếu có câu hỏi về chính sách bảo mật, vui lòng liên hệ: your-email@example.com

Cập nhật lần cuối: 2026-02-05
```

---

## Implementation Steps

### Step 1: Create App Icon (2h)
Design 1024x1024 app icon:
- Red/gold theme matching Vietnamese culture
- Calendar/moon imagery
- Clear at small sizes

```bash
# Use icon generator or design tool
# Export all required sizes
npx expo-optimize
```

### Step 2: Create Splash Screen (1h)
- Simple, fast-loading splash
- Match app icon theme
- Consider launch animation (optional)

### Step 3: Implement Dark Mode (2h)
- Create theme hook
- Update all components to use theme colors
- Test on iOS dark mode

### Step 4: Add Accessibility (2h)
- VoiceOver labels for all interactive elements
- Semantic headers
- Dynamic type support
- Test with VoiceOver

### Step 5: Performance Optimization (2h)
- Profile with React DevTools
- Memo expensive components
- Optimize re-renders
- Test on older devices

```bash
# Profile performance
npx react-devtools

# In app:
# Enable Performance Monitor (shake -> "Toggle Performance Monitor")
```

### Step 6: Prepare App Store Assets (1h)
- Take screenshots on simulator
- Write Vietnamese description
- Prepare keywords
- Create privacy policy

### Step 10: Implement iOS Home Screen Widget (4h)
- Create Expo Config Plugin for Widget extension
- Build Swift UI widget for today's lunar date
- Implement data sharing between App and Widget
- Test on physical device

### Step 11: Implement Data Export/Import (2h)
- Create JSON export functionality (Share sheet)
- Implement JSON file picker for import
- Add "Backup & Restore" section in Settings

### Step 7: Build for TestFlight (1h)
```bash
# Login to EAS
eas login

# Build for iOS
eas build --platform ios --profile preview

# Submit to TestFlight
eas submit --platform ios
```

### Step 8: Beta Testing (Ongoing)
- Distribute to testers via TestFlight
- Collect feedback
- Fix critical issues

### Step 9: App Store Submission (1h)
```bash
# Production build
eas build --platform ios --profile production

# Submit for review
eas submit --platform ios --profile production
```

---

## Todo List

### Assets
- [ ] Design app icon (1024x1024)
- [ ] Export all icon sizes
- [ ] Create splash screen
- [ ] Record/create app preview video (optional)
- [ ] Take App Store screenshots (6.5")
- [ ] Take App Store screenshots (5.5")

### Dark Mode
- [ ] Create theme constants
- [ ] Create useTheme hook
- [ ] Update CalendarView for dark mode
- [ ] Update DayCell for dark mode
- [ ] Update DayDetailModal for dark mode
- [ ] Update EventForm for dark mode
- [ ] Update EventList for dark mode
- [ ] Update Settings for dark mode
- [ ] Test dark mode transition

### Accessibility
- [ ] Add accessibilityLabel to DayCell
- [ ] Add accessibilityLabel to EventCard
- [ ] Add accessibilityRole to buttons
- [ ] Add accessibilityHint where helpful
- [ ] Test with VoiceOver
- [ ] Support Dynamic Type

### Performance
- [ ] Profile calendar scrolling
- [ ] Memo DayCell component
- [ ] Optimize marked dates calculation
- [ ] Profile event list
- [ ] Test on iPhone 8/SE
- [ ] Measure cold start time
- [ ] Measure memory usage

### App Store
- [ ] Write Vietnamese app description
- [ ] Write keywords
- [ ] Create privacy policy
- [ ] Set age rating (4+)
- [ ] Configure App Store Connect
- [ ] Upload screenshots
- [ ] Submit for review

### Release
- [ ] Create eas.json configuration
- [ ] Build development client
- [ ] Test on real device
- [ ] Build preview for TestFlight
- [ ] Distribute to beta testers
- [ ] Fix beta feedback
- [ ] Build production
- [ ] Submit to App Store

---

## Success Criteria

- [ ] App icon looks good at all sizes
- [ ] Splash screen displays correctly
- [ ] Dark mode works throughout app
- [ ] VoiceOver reads all content correctly
- [ ] 60fps scrolling on calendar
- [ ] Cold start < 2 seconds
- [ ] TestFlight build works
- [ ] App Store screenshots ready
- [ ] Privacy policy published
- [ ] App submitted for review

---

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| App Store rejection | High | Low | Follow guidelines, test thoroughly |
| Performance issues on old devices | Medium | Medium | Test on iPhone 8 |
| Accessibility complaints | Medium | Low | Thorough VoiceOver testing |
| Icon/asset quality | Low | Low | Professional design review |

---

## Security Considerations

- Privacy policy accurately reflects no data collection
- No analytics or tracking implemented
- Encryption flag set correctly (false for no encryption)
- No sensitive data in logs

---

## App Store Listing

### App Name
Lịch Việt - Âm Lịch

### Subtitle
Lịch âm dương, giờ hoàng đạo

### Keywords
lịch âm, lịch việt, lunar calendar, giờ hoàng đạo, ngày giỗ, tết, vietnamese calendar

### Description (Vietnamese)
```
Lịch Việt - Ứng dụng lịch âm dương Việt Nam

TÍNH NĂNG CHÍNH:
• Xem lịch dương và lịch âm song song
• Tra cứu giờ hoàng đạo mỗi ngày
• Quản lý ngày giỗ ông bà
• Nhắc nhở sự kiện theo lịch âm
• Hiển thị các ngày lễ Việt Nam

HOÀN TOÀN MIỄN PHÍ - KHÔNG QUẢNG CÁO

Ứng dụng hoạt động offline, không cần kết nối mạng.
```

### Category
- Primary: Utilities
- Secondary: Lifestyle

### Age Rating
4+ (No objectionable content)

---

## Post-Release

After App Store approval:
1. Monitor App Store Connect for crash reports
2. Respond to user reviews
3. Plan version 1.1 with user feedback
4. Consider Android release

---

## Complete Project Summary

### Total Estimated Effort: 80 hours

| Phase | Hours | Status |
|-------|-------|--------|
| Phase 1: Project Setup | 8h | pending |
| Phase 2: Lunar Calendar Core | 20h | pending |
| Phase 3: Calendar UI | 16h | pending |
| Phase 4: Features | 24h | pending |
| Phase 5: Polish & Release | 12h | pending |

### Key Deliverables
1. iOS app with lunar/solar calendar
2. Vietnamese holidays display
3. Giờ hoàng đạo calculation
4. Ngày giỗ event management
5. Local notification reminders
6. App Store listing

### Tech Stack Summary
- React Native + Expo
- TypeScript
- Expo Router (navigation)
- Zustand + MMKV (state/storage)
- react-native-calendars (UI)
- expo-notifications (reminders)
</file>

<file path=".claude/plans/ios-lunar-calendar-app/plan.md">
---
title: "Vietnamese Lunar Calendar iOS App"
description: "React Native app with lunar/solar calendar, holidays, auspicious hours, and reminders"
status: in-progress
priority: P2
effort: 80h
branch: main
tags: [react-native, ios, lunar-calendar, vietnamese]
created: 2026-02-05
---

# Vietnamese Lunar Calendar iOS App - Implementation Plan

## Executive Summary

Build an offline-first iOS calendar app using React Native (Expo) that displays Vietnamese lunar and solar calendars side by side, shows traditional holidays and ancestor memorial days (ngày giỗ), provides auspicious hours (giờ hoàng đạo), and sends reminders based on lunar dates.

## Project Overview

| Aspect | Details |
|--------|---------|
| Platform | iOS (React Native + Expo) |
| Architecture | Offline-first, no backend |
| Duration | ~80 hours (~10 days full-time) |
| Priority | P2 (Medium) |

## Key Features

1. **Dual Calendar View** - Solar/Lunar dates displayed together
2. **Vietnamese Holidays** - Tết, Giỗ Tổ Hùng Vương, Trung Thu, etc.
3. **Ancestor Memorial Days** - User-defined ngày giỗ
4. **Auspicious Hours** - Giờ hoàng đạo for each day
5. **Event Reminders** - Local notifications based on lunar dates
6. **Home Screen Widget** - Quick view of today's lunar date
7. **Data Portability** - Export/Import JSON for backup

## Tech Stack

| Layer | Technology | Rationale |
|-------|------------|-----------|
| Framework | React Native + Expo | Cross-platform, managed workflow |
| Language | TypeScript | Type safety |
| Navigation | Expo Router | File-based, automatic deep linking |
| State | Zustand | Lightweight, persist middleware |
| Storage | react-native-mmkv | 30x faster than AsyncStorage |
| Calendar UI | react-native-calendars | Mature, customizable |
| Notifications | expo-notifications | Native iOS integration |

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │  Calendar   │  │   Events    │  │  Settings   │     │
│  │    View     │  │    List     │  │    View     │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┼────────────────────────────────┐
│                   Business Layer                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │   Lunar     │  │   Events    │  │Notifications│     │
│  │  Service    │  │   Store     │  │   Service   │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┼────────────────────────────────┐
│                    Data Layer                            │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  MMKV Storage                    │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────────────┐  │   │
│  │  │Settings │  │ Events  │  │ Holidays Cache  │  │   │
│  │  └─────────┘  └─────────┘  └─────────────────┘  │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## Folder Structure

```
src/
├── app/                          # Expo Router pages
│   ├── (tabs)/
│   │   ├── _layout.tsx          # Tab bar layout
│   │   ├── index.tsx            # Calendar (home)
│   │   ├── events.tsx           # Events list
│   │   └── settings.tsx         # Settings
│   ├── event/
│   │   ├── [id].tsx             # Event detail
│   │   └── new.tsx              # Create event
│   ├── day/[date].tsx           # Day detail view
│   └── _layout.tsx              # Root layout
├── components/
│   ├── calendar/
│   │   ├── CalendarView.tsx
│   │   ├── DayCell.tsx          # Custom day with lunar date
│   │   ├── LunarDateDisplay.tsx
│   │   └── AuspiciousHours.tsx
│   ├── events/
│   │   ├── EventCard.tsx
│   │   ├── EventList.tsx
│   │   └── EventForm.tsx
│   └── common/
│       ├── Header.tsx
│       ├── Button.tsx
│       └── Modal.tsx
├── hooks/
│   ├── useLunarDate.ts
│   ├── useAuspiciousHours.ts
│   └── useEvents.ts
├── services/
│   ├── lunar/
│   │   ├── index.ts             # Main lunar service
│   │   ├── converter.ts         # Solar <-> Lunar conversion
│   │   ├── canChi.ts            # Heavenly stems/branches
│   │   └── auspiciousHours.ts   # Giờ hoàng đạo calculation
│   └── notifications/
│       ├── index.ts
│       └── scheduler.ts
├── stores/
│   ├── eventStore.ts            # Zustand store for events
│   ├── settingsStore.ts         # App settings
│   └── storage.ts               # MMKV configuration
├── types/
│   ├── lunar.ts
│   ├── event.ts
│   └── common.ts
├── constants/
│   ├── holidays.ts              # Vietnamese holidays data
│   ├── canChi.ts                # Can Chi lookup tables
│   └── theme.ts
└── utils/
    ├── date.ts
    └── format.ts
```

## Implementation Phases

### Phase 1: Project Setup (8h)
- Initialize Expo project with TypeScript
- Configure ESLint, Prettier
- Set up navigation structure
- Configure MMKV storage
- Create base component library

### Phase 2: Lunar Calendar Core (20h)
- Port/implement lunar conversion algorithm
- Implement Can Chi calculation
- Build giờ hoàng đạo calculation
- Create Vietnamese holidays data
- Write comprehensive tests

### Phase 3: Calendar UI (16h)
- Integrate react-native-calendars
- Build custom DayCell with lunar dates
- Implement day detail view
- Add auspicious hours display
- Style for iOS

### Phase 4: Features (24h)
- Build event CRUD (ngày giỗ)
- Implement local notifications
- Add reminder scheduling
- Create settings screen
- Handle recurring lunar events

### Phase 5: Polish & Release (12h)
- Performance optimization
- Accessibility (VoiceOver)
- App icon and splash screen
- TestFlight deployment
- Documentation

## Success Criteria

- [ ] Accurate lunar date conversion (anchored to GMT+7)
- [ ] All Vietnamese holidays displayed correctly
- [ ] Giờ hoàng đạo matches traditional calculations
- [ ] Events persist across app restarts
- [ ] Notifications fire at correct times (under 64 limit)
- [ ] Data can be exported and imported correctly
- [ ] Home screen widget shows current date
- [ ] Smooth 60fps scrolling
- [ ] Works offline completely
- [ ] iOS 14+ support

## Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Lunar algorithm errors | High | Medium | Validate against multiple sources |
| Notification timing issues | Medium | Medium | Test across time zones |
| Performance with many events | Low | Low | Optimize list rendering |
| iOS permission rejection | Medium | Low | Follow Apple guidelines |

## Phase Links

- | 1 | Phase 1: Project Setup | Completed | 8h | [phase-01](./phase-01-project-setup.md) |
- | 2 | Phase 2: Lunar Calendar Core | Completed | 20h | [phase-02](./phase-02-lunar-calendar-core.md) |
- | 3 | Phase 3: Calendar UI | Completed | 16h | [phase-03](./phase-03-calendar-ui.md) |
- | 4 | Phase 4: Features | Completed | 24h | [phase-04](./phase-04-features.md) |
- | 5 | Phase 5: Polish & Release | In Progress | 12h | [phase-05](./phase-05-polish-release.md) |

## Reports

- [Research Report](./reports/01-research-report.md)
</file>

<file path=".claude/settings.local.json">
{
  "permissions": {
    "allow": [
      "mcp__context7__resolve-library-id",
      "WebSearch",
      "mcp__context7__query-docs",
      "WebFetch(domain:github.com)",
      "Bash(pod install)",
      "Bash(xcodebuild:*)",
      "Bash(swift --version:*)",
      "Bash(npx expo install:*)",
      "Bash(npx expo prebuild:*)",
      "Bash(npm install:*)"
    ]
  }
}
</file>

<file path="docs/code-standards.md">
# Code Standards

## TypeScript
- Strict mode enabled
- Path aliases: `@/*` → `src/*`
- Explicit return types for public functions
- Interfaces over types for objects

## Components
- Functional components with hooks
- React.memo() for expensive renders (DayCell)
- Container/presentational separation
- Props interfaces named `{Component}Props`

## Styling
```typescript
// Pattern: StyleSheet + dynamic theme
const styles = StyleSheet.create({ base: {...} });
const theme = useTheme();
<View style={[styles.base, { backgroundColor: theme.background }]} />
```

## State Management
- Zustand with persist middleware
- MMKV as storage backend
- Async mutations return Promises
- Auto-sync notifications on event changes

## File Organization
```
src/
├── app/           # Routes only, minimal logic
├── components/    # Feature-based subdirectories
├── services/      # Business logic, no UI
├── stores/        # State management
├── hooks/         # Custom hooks
├── constants/     # Static data
├── types/         # TypeScript interfaces
└── utils/         # Pure utility functions
```

## Naming
- Files: kebab-case or camelCase
- Components: PascalCase
- Hooks: use* prefix
- Stores: *Store suffix
</file>

<file path="docs/codebase-summary.md">
# Codebase Summary

## Architecture
```
UI Layer (Expo Router + Components)
    ↓
State Layer (Zustand Stores)
    ↓
Service Layer (Lunar, Notifications, Data)
    ↓
Storage Layer (MMKV)
```

## Key Modules

### Services (`src/services/`)
| File | Purpose |
|------|---------|
| lunar/converter.ts | Solar ↔ Lunar via Julian Day |
| lunar/canChi.ts | Can-Chi stem-branch calculations |
| lunar/auspiciousHours.ts | Lucky hours lookup |
| lunar/newMoon.ts | Astronomical new moon calculations |
| notifications/index.ts | Expo Notifications wrapper |
| dataService.ts | Import/Export functionality |

### Stores (`src/stores/`)
| Store | Purpose |
|-------|---------|
| eventStore.ts | Events CRUD + notification sync |
| settingsStore.ts | UI preferences (lunar display, reminders) |
| storage.ts | MMKV + Zustand StateStorage adapter |

### Components (`src/components/`)
- **common/**: Button, Header, Modal, AccessibleText
- **calendar/**: CalendarView, DayCell, DayDetailModal, AuspiciousHoursGrid
- **events/**: EventCard, EventForm, EventList

## Data Flow
1. User selects date → CalendarView calls getDayInfo()
2. Lunar service converts via Julian Day → returns DayInfo
3. Events fetched from Zustand store → filtered by lunar date
4. UI renders with theme colors from useTheme()
</file>

<file path="docs/project-overview-pdr.md">
# Lịch Việt - Project Overview & PDR

## Vision
Vietnamese lunar calendar app for diaspora and cultural practitioners.

## Core Features
- **Lunar Calendar**: Bidirectional solar ↔ lunar date conversion
- **Can-Chi System**: 60-year cycle (Heavenly Stems + Earthly Branches)
- **Auspicious Hours**: Traditional lucky hour calculations
- **Event Management**: Lunar date-based events with reminders
- **Vietnamese Holidays**: 13 major holidays + monthly observances
- **Notifications**: Auto-scheduled based on lunar dates

## Target Users
- Vietnamese diaspora maintaining cultural traditions
- Festival and ceremony planners
- Cultural practitioners tracking auspicious dates

## Technical Requirements
- Offline-first architecture (MMKV storage)
- iOS and Android support via Expo
- Dark mode with Vietnamese cultural colors
- Accessibility with Vietnamese screen reader labels

## Future Considerations
- Widget support for home screen
- Apple Watch / WearOS companion
- iCloud/Google sync for cross-device events
</file>

<file path="docs/system-architecture.md">
# System Architecture

## Layer Diagram
```
┌─────────────────────────────────────────┐
│           UI Layer (Expo Router)         │
│  ┌─────────┐ ┌─────────┐ ┌──────────┐   │
│  │Calendar │ │ Events  │ │ Settings │   │
│  └────┬────┘ └────┬────┘ └────┬─────┘   │
└───────┼──────────┼───────────┼──────────┘
        ↓          ↓           ↓
┌─────────────────────────────────────────┐
│         State Layer (Zustand)            │
│  ┌────────────┐  ┌──────────────┐       │
│  │ eventStore │  │ settingsStore│       │
│  └─────┬──────┘  └──────────────┘       │
└────────┼────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│         Service Layer                    │
│  ┌────────┐ ┌──────────────┐ ┌───────┐  │
│  │ Lunar  │ │ Notifications│ │ Data  │  │
│  └────────┘ └──────────────┘ └───────┘  │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│         Storage Layer (MMKV)             │
│  ┌─────────────────────────────────┐    │
│  │      lich-viet-storage          │    │
│  └─────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

## Lunar Conversion Algorithm
1. Solar date → Julian Day Number (JD)
2. JD → Find new moon boundaries
3. Calculate lunar month/day within boundaries
4. Detect leap months via sun longitude
5. Return LunarDate with Can-Chi info

## Notification Flow
1. Event created/updated in eventStore
2. Store calls scheduleEventNotification()
3. Lunar date → Solar date conversion
4. Apply reminder offset (days before + time)
5. Expo Notifications schedules trigger
6. Notification ID stored with event

## Data Persistence
- MMKV: Fast key-value storage
- Zustand persist: Auto-save state changes
- Version migration: storage.getNumber('version')
- Export: JSON file via Expo Sharing
</file>

<file path="src/app/(tabs)/_layout.tsx">
import { Ionicons } from '@expo/vector-icons';
import { Tabs } from 'expo-router';
import React from 'react';
import { useColorScheme } from 'react-native';

export default function TabLayout() {
  const colorScheme = useColorScheme();
  const activeColor = '#D4382A'; // Vietnamese red

  return (
    <Tabs
      screenOptions={{
        tabBarActiveTintColor: activeColor,
        headerShown: true,
        tabBarStyle: {
          backgroundColor: colorScheme === 'dark' ? '#1A1A1A' : '#FFFFFF',
        },
      }}
    >
      <Tabs.Screen
        name="index"
        options={{
          title: 'Lịch',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="calendar" size={size} color={color} />
          ),
        }}
      />
      <Tabs.Screen
        name="events"
        options={{
          title: 'Sự kiện',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="list" size={size} color={color} />
          ),
        }}
      />
      <Tabs.Screen
        name="settings"
        options={{
          title: 'Cài đặt',
          tabBarIcon: ({ color, size }) => (
            <Ionicons name="settings" size={size} color={color} />
          ),
        }}
      />
    </Tabs>
  );
}
</file>

<file path="src/app/(tabs)/events.tsx">
import { EventList } from '@/components/events/EventList';
import { Ionicons } from '@expo/vector-icons';
import { useRouter } from 'expo-router';
import { StyleSheet, TouchableOpacity, View } from 'react-native';

export default function EventsScreen() {
  const router = useRouter();

  return (
    <View style={styles.container}>
      <EventList />

      <TouchableOpacity
        style={styles.fab}
        onPress={() => router.push('/event/new')}
      >
        <Ionicons name="add" size={30} color="#FFFFFF" />
      </TouchableOpacity>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F8F8F8',
  },
  fab: {
    position: 'absolute',
    bottom: 20,
    right: 20,
    width: 60,
    height: 60,
    borderRadius: 30,
    backgroundColor: '#D4382A',
    alignItems: 'center',
    justifyContent: 'center',
    elevation: 4,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
  },
});
</file>

<file path="src/app/(tabs)/index.tsx">
import { CalendarView } from '@/components/calendar/CalendarView';
import { StyleSheet, View } from 'react-native';

export default function CalendarScreen() {
  return (
    <View style={styles.container}>
      <CalendarView />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#FFFFFF',
  },
});
</file>

<file path="src/app/(tabs)/settings.tsx">
import { useTheme } from '@/constants/theme';
import { exportData, importData } from '@/services/dataService';
import { useSettingsStore } from '@/stores/settingsStore';
import { Ionicons } from '@expo/vector-icons';
import React from 'react';
import { ScrollView, StyleSheet, Switch, Text, TouchableOpacity, View } from 'react-native';

export default function SettingsScreen() {
    const theme = useTheme();
    const {
        showLunarDates,
        showAuspiciousHours,
        reminderDaysBefore,
        reminderTime,
        setShowLunarDates,
        setShowAuspiciousHours,
    } = useSettingsStore();

    return (
        <ScrollView style={[styles.container, { backgroundColor: theme.surfaceAlt }]}>
            <View style={[styles.section, { backgroundColor: theme.background, borderColor: theme.border }]}>
                <Text style={[styles.sectionTitle, { color: theme.textMuted }]}>Hiển thị</Text>

                <View style={[styles.row, { borderBottomColor: theme.border }]}>
                    <Text style={[styles.label, { color: theme.text }]}>Hiện ngày âm trên lịch</Text>
                    <Switch
                        value={showLunarDates}
                        onValueChange={setShowLunarDates}
                        trackColor={{ false: theme.border, true: theme.primary }}
                    />
                </View>

                <View style={[styles.row, { borderBottomColor: theme.border }]}>
                    <Text style={[styles.label, { color: theme.text }]}>Hiện giờ hoàng đạo</Text>
                    <Switch
                        value={showAuspiciousHours}
                        onValueChange={setShowAuspiciousHours}
                        trackColor={{ false: theme.border, true: theme.primary }}
                    />
                </View>
            </View>

            <View style={[styles.section, { backgroundColor: theme.background, borderColor: theme.border }]}>
                <Text style={[styles.sectionTitle, { color: theme.textMuted }]}>Nhắc nhở mặc định</Text>

                <View style={[styles.row, { borderBottomColor: theme.border }]}>
                    <Text style={[styles.label, { color: theme.text }]}>Nhắc trước (ngày)</Text>
                    <Text style={[styles.valueText, { color: theme.textSecondary }]}>{reminderDaysBefore}</Text>
                </View>

                <View style={[styles.row, { borderBottomColor: theme.border }]}>
                    <Text style={[styles.label, { color: theme.text }]}>Giờ nhắc</Text>
                    <Text style={[styles.valueText, { color: theme.textSecondary }]}>{reminderTime}</Text>
                </View>
            </View>

            <View style={[styles.section, { backgroundColor: theme.background, borderColor: theme.border }]}>
                <Text style={[styles.sectionTitle, { color: theme.textMuted }]}>Dữ liệu</Text>
                <TouchableOpacity
                    style={[styles.row, { borderBottomColor: theme.border }]}
                    onPress={exportData}
                >
                    <Text style={[styles.label, { color: theme.text }]}>Sao lưu dữ liệu (Xuất file)</Text>
                    <Ionicons name="share-outline" size={20} color={theme.primary} />
                </TouchableOpacity>

                <TouchableOpacity
                    style={[styles.row, { borderBottomColor: 'transparent' }]}
                    onPress={importData}
                >
                    <Text style={[styles.label, { color: theme.text }]}>Khôi phục dữ liệu (Nhập file)</Text>
                    <Ionicons name="download-outline" size={20} color={theme.primary} />
                </TouchableOpacity>
            </View>

            <View style={[styles.section, { backgroundColor: theme.background, borderColor: theme.border }]}>
                <Text style={[styles.sectionTitle, { color: theme.textMuted }]}>Ứng dụng</Text>
                <View style={[styles.row, { borderBottomColor: theme.border }]}>
                    <Text style={[styles.label, { color: theme.text }]}>Phiên bản</Text>
                    <Text style={[styles.valueText, { color: theme.textSecondary }]}>1.0.0</Text>
                </View>

                <TouchableOpacity style={[styles.row, { borderBottomColor: 'transparent' }]}>
                    <Text style={[styles.label, { color: theme.text }]}>Phản hồi & Góp ý</Text>
                    <Ionicons name="chevron-forward" size={20} color={theme.border} />
                </TouchableOpacity>
            </View>
        </ScrollView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
    },
    section: {
        marginTop: 24,
        borderTopWidth: 1,
        borderBottomWidth: 1,
    },
    sectionTitle: {
        fontSize: 13,
        marginLeft: 16,
        marginBottom: 8,
        marginTop: 16,
        textTransform: 'uppercase',
    },
    row: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingVertical: 12,
        paddingHorizontal: 16,
        borderBottomWidth: 1,
    },
    label: {
        fontSize: 16,
    },
    valueText: {
        fontSize: 16,
    },
});
</file>

<file path="src/app/day/[date].tsx">
import { useLocalSearchParams } from 'expo-router';
import { StyleSheet, Text, View } from 'react-native';

export default function DayDetailScreen() {
    const { date } = useLocalSearchParams();

    return (
        <View style={styles.container}>
            <Text style={styles.title}>Chi tiết ngày</Text>
            <Text>Ngày: {date}</Text>
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        alignItems: 'center',
        justifyContent: 'center',
    },
    title: {
        fontSize: 20,
        fontWeight: 'bold',
    },
});
</file>

<file path="src/app/event/[id].tsx">
import { EventForm } from '@/components/events/EventForm';
import { useEventsStore } from '@/stores/eventStore';
import { Ionicons } from '@expo/vector-icons';
import { useLocalSearchParams, useRouter } from 'expo-router';
import React from 'react';
import { Alert, StyleSheet, TouchableOpacity, View } from 'react-native';

export default function EventDetailScreen() {
    const { id } = useLocalSearchParams<{ id: string }>();
    const router = useRouter();
    const { events, updateEvent, deleteEvent } = useEventsStore();

    const event = events.find((e) => e.id === id);

    if (!event) {
        return null;
    }

    const handleUpdate = async (data: any) => {
        await updateEvent(id, data);
        router.back();
    };

    const handleDelete = () => {
        Alert.alert(
            'Xóa sự kiện',
            'Bạn có chắc chắn muốn xóa sự kiện này?',
            [
                { text: 'Hủy', style: 'cancel' },
                {
                    text: 'Xóa',
                    style: 'destructive',
                    onPress: async () => {
                        await deleteEvent(id);
                        router.back();
                    },
                },
            ]
        );
    };

    return (
        <View style={styles.container}>
            {/* Delete button in header would be nice, but we'll put it in the footer of form or as a button */}
            <EventForm
                initialData={event}
                onSubmit={handleUpdate}
                onCancel={() => router.back()}
            />

            <TouchableOpacity style={styles.deleteButton} onPress={handleDelete}>
                <Ionicons name="trash-outline" size={24} color="#D4382A" />
            </TouchableOpacity>
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: '#FFFFFF',
    },
    deleteButton: {
        position: 'absolute',
        bottom: 34,
        right: 20,
        width: 44,
        height: 44,
        borderRadius: 22,
        backgroundColor: '#FFF3F0',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 10,
    },
});
</file>

<file path="src/app/event/new.tsx">
import { EventForm } from '@/components/events/EventForm';
import { useEventsStore } from '@/stores/eventStore';
import { useRouter } from 'expo-router';
import React from 'react';

export default function NewEventScreen() {
    const router = useRouter();
    const addEvent = useEventsStore((state) => state.addEvent);

    const handleSubmit = async (data: any) => {
        await addEvent(data);
        router.back();
    };

    return (
        <EventForm onSubmit={handleSubmit} onCancel={() => router.back()} />
    );
}
</file>

<file path="src/app/_layout.tsx">
import { DarkTheme, DefaultTheme, ThemeProvider } from '@react-navigation/native';
import { useFonts } from 'expo-font';
import { Stack } from 'expo-router';
import * as SplashScreen from 'expo-splash-screen';
import { useEffect } from 'react';
import { useColorScheme } from 'react-native';
import 'react-native-reanimated';

import { initializeStorage } from '@/stores/storage';

export {
  // Catch any errors thrown by the Layout component.
  ErrorBoundary
} from 'expo-router';

// Prevent the splash screen from auto-hiding before asset loading is complete.
SplashScreen.preventAutoHideAsync();

export default function RootLayout() {
  const [loaded, error] = useFonts({
    SpaceMono: require('../assets/fonts/SpaceMono-Regular.ttf'),
  });

  useEffect(() => {
    initializeStorage();
  }, []);

  useEffect(() => {
    if (error) throw error;
  }, [error]);

  useEffect(() => {
    if (loaded) {
      SplashScreen.hideAsync();
    }
  }, [loaded]);

  if (!loaded) {
    return null;
  }

  return <RootLayoutNav />;
}

function RootLayoutNav() {
  const colorScheme = useColorScheme();

  return (
    <ThemeProvider value={colorScheme === 'dark' ? DarkTheme : DefaultTheme}>
      <Stack>
        <Stack.Screen name="(tabs)" options={{ headerShown: false }} />
        <Stack.Screen name="event/[id]" options={{ presentation: 'modal', title: 'Chi tiết sự kiện' }} />
        <Stack.Screen name="event/new" options={{ presentation: 'modal', title: 'Thêm sự kiện mới' }} />
        <Stack.Screen name="day/[date]" options={{ presentation: 'card', title: 'Chi tiết ngày' }} />
      </Stack>
    </ThemeProvider>
  );
}
</file>

<file path="src/app/+html.tsx">
import { ScrollViewStyleReset } from 'expo-router/html';

// This file is web-only and used to configure the root HTML for every
// web page during static rendering.
// The contents of this function only run in Node.js environments and
// do not have access to the DOM or browser APIs.
export default function Root({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta httpEquiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

        {/* 
          Disable body scrolling on web. This makes ScrollView components work closer to how they do on native. 
          However, body scrolling is often nice to have for mobile web. If you want to enable it, remove this line.
        */}
        <ScrollViewStyleReset />

        {/* Using raw CSS styles as an escape-hatch to ensure the background color never flickers in dark-mode. */}
        <style dangerouslySetInnerHTML={{ __html: responsiveBackground }} />
        {/* Add any additional <head> elements that you want globally available on web... */}
      </head>
      <body>{children}</body>
    </html>
  );
}

const responsiveBackground = `
body {
  background-color: #fff;
}
@media (prefers-color-scheme: dark) {
  body {
    background-color: #000;
  }
}`;
</file>

<file path="src/app/+not-found.tsx">
import { Link, Stack } from 'expo-router';
import { StyleSheet } from 'react-native';

import { Text, View } from '@/components/Themed';

export default function NotFoundScreen() {
  return (
    <>
      <Stack.Screen options={{ title: 'Oops!' }} />
      <View style={styles.container}>
        <Text style={styles.title}>This screen doesn't exist.</Text>

        <Link href="/" style={styles.link}>
          <Text style={styles.linkText}>Go to home screen!</Text>
        </Link>
      </View>
    </>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    padding: 20,
  },
  title: {
    fontSize: 20,
    fontWeight: 'bold',
  },
  link: {
    marginTop: 15,
    paddingVertical: 15,
  },
  linkText: {
    fontSize: 14,
    color: '#2e78b7',
  },
});
</file>

<file path="src/components/__tests__/StyledText-test.js">
import * as React from 'react';
import renderer from 'react-test-renderer';

import { MonoText } from '../StyledText';

it(`renders correctly`, () => {
  const tree = renderer.create(<MonoText>Snapshot test!</MonoText>).toJSON();

  expect(tree).toMatchSnapshot();
});
</file>

<file path="src/components/calendar/AuspiciousHoursGrid.tsx">
import { useTheme } from '@/constants/theme';
import { AuspiciousHour } from '@/services/lunar/types';
import { getHourAccessibilityLabel } from '@/utils/accessibility';
import React from 'react';
import { StyleSheet, Text, View } from 'react-native';

interface AuspiciousHoursGridProps {
    hours: AuspiciousHour[];
}

export function AuspiciousHoursGrid({ hours }: AuspiciousHoursGridProps) {
    const theme = useTheme();

    return (
        <View style={styles.container}>
            {hours.map((hour) => {
                const accessibilityLabel = getHourAccessibilityLabel(
                    hour.name,
                    hour.startTime,
                    hour.endTime,
                    hour.isAuspicious,
                    hour.star
                );

                return (
                    <View
                        key={hour.name}
                        style={[
                            styles.hourItem,
                            { backgroundColor: theme.surface },
                            hour.isAuspicious && {
                                backgroundColor: theme.isDark ? '#3A3010' : '#FFF9E6',
                                borderColor: theme.auspicious,
                                borderWidth: 1,
                            },
                        ]}
                        accessible
                        accessibilityLabel={accessibilityLabel}
                    >
                        <Text
                            style={[
                                styles.hourName,
                                { color: theme.textSecondary },
                                hour.isAuspicious && { color: theme.auspicious },
                            ]}
                        >
                            {hour.name}
                        </Text>
                        <Text style={[styles.hourTime, { color: theme.textMuted }]}>
                            {hour.startTime}-{hour.endTime}
                        </Text>
                        {hour.isAuspicious && hour.star && (
                            <Text style={[styles.starName, { color: theme.auspicious }]}>
                                {hour.star}
                            </Text>
                        )}
                    </View>
                );
            })}
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: 8,
    },
    hourItem: {
        width: '31%',
        padding: 10,
        borderRadius: 8,
        alignItems: 'center',
    },
    hourName: {
        fontSize: 14,
        fontWeight: '600',
    },
    hourTime: {
        fontSize: 11,
        marginTop: 2,
    },
    starName: {
        fontSize: 10,
        marginTop: 4,
    },
});
</file>

<file path="src/components/calendar/CalendarView.tsx">
import { useTheme } from '@/constants/theme';
import { getDayInfo } from '@/services/lunar';
import { useEventsStore } from '@/stores/eventStore';
import { Ionicons } from '@expo/vector-icons';
import React, { useMemo, useState } from 'react';
import { StyleSheet, View } from 'react-native';
import { Calendar, DateData } from 'react-native-calendars';
import { DayCell } from './DayCell';
import { DayDetailModal } from './DayDetailModal';

export function CalendarView() {
    const [selectedDate, setSelectedDate] = useState(
        new Date().toISOString().split('T')[0]
    );
    const [isModalVisible, setIsModalVisible] = useState(false);
    const events = useEventsStore((state) => state.events);
    const theme = useTheme();

    const dayInfo = useMemo(() => {
        const date = new Date(selectedDate);
        return getDayInfo(date.getDate(), date.getMonth() + 1, date.getFullYear());
    }, [selectedDate]);

    const markedDates = useMemo(() => {
        return {
            [selectedDate]: {
                selected: true,
                disableTouchEvent: true,
            },
        };
    }, [selectedDate]);

    const renderDay = ({ date, state }: any) => {
        if (!date) return null;

        const info = getDayInfo(date.day, date.month, date.year);
        const hasEvent = events.some(
            (e) =>
                e.lunarDay === info.lunar.day &&
                e.lunarMonth === info.lunar.month &&
                (!e.isLeapMonth || info.lunar.leap)
        );

        return (
            <DayCell
                solarDay={date.day}
                solarMonth={date.month}
                solarYear={date.year}
                lunarDay={info.lunar.day}
                lunarMonth={info.lunar.month}
                lunarYear={info.lunar.year}
                isLeapMonth={info.lunar.leap}
                isToday={state === 'today'}
                isSelected={selectedDate === date.dateString}
                isDisabled={state === 'disabled'}
                isHoliday={!!info.holiday}
                holidayName={info.holiday?.name}
                hasEvent={hasEvent}
                onPress={() => {
                    setSelectedDate(date.dateString);
                    setIsModalVisible(true);
                }}
            />
        );
    };

    return (
        <View style={[styles.container, { backgroundColor: theme.background }]}>
            <Calendar
                current={selectedDate}
                markedDates={markedDates}
                dayComponent={renderDay}
                onDayPress={(day: DateData) => {
                    setSelectedDate(day.dateString);
                }}
                firstDay={1}
                enableSwipeMonths={true}
                theme={{
                    calendarBackground: theme.background,
                    textSectionTitleColor: theme.textSecondary,
                    monthTextColor: theme.text,
                    dayTextColor: theme.text,
                    textDisabledColor: theme.textMuted,
                    dotColor: theme.primary,
                    selectedDotColor: '#ffffff',
                    todayTextColor: theme.today,
                    arrowColor: theme.primary,
                    textMonthFontWeight: '600',
                    textMonthFontSize: 18,
                    // @ts-ignore
                    'stylesheet.calendar.main': {
                        container: {
                            paddingLeft: 0,
                            paddingRight: 0,
                            backgroundColor: theme.background,
                        },
                    },
                }}
                renderArrow={(direction: string) => (
                    <Ionicons
                        name={direction === 'left' ? 'chevron-back' : 'chevron-forward'}
                        size={24}
                        color={theme.primary}
                    />
                )}
            />

            {dayInfo && (
                <DayDetailModal
                    visible={isModalVisible}
                    onClose={() => setIsModalVisible(false)}
                    dayInfo={dayInfo}
                />
            )}
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
    },
});
</file>

<file path="src/components/calendar/DayCell.tsx">
import { useTheme } from '@/constants/theme';
import { getLunarDateAccessibilityLabel } from '@/utils/accessibility';
import React, { memo } from 'react';
import { StyleSheet, Text, TouchableOpacity, View } from 'react-native';

interface DayCellProps {
    solarDay: number;
    solarMonth: number;
    solarYear: number;
    lunarDay: number;
    lunarMonth: number;
    lunarYear: number;
    isLeapMonth: boolean;
    isToday: boolean;
    isSelected: boolean;
    isDisabled: boolean;
    isHoliday: boolean;
    holidayName?: string;
    hasEvent: boolean;
    onPress: () => void;
}

export const DayCell = memo(function DayCell({
    solarDay,
    solarMonth,
    solarYear,
    lunarDay,
    lunarMonth,
    lunarYear,
    isLeapMonth,
    isToday,
    isSelected,
    isDisabled,
    isHoliday,
    holidayName,
    hasEvent,
    onPress,
}: DayCellProps) {
    const theme = useTheme();

    // Format lunar date - show month on day 1
    const lunarText = lunarDay === 1 ? `${lunarDay}/${lunarMonth}` : `${lunarDay}`;

    // Accessibility label
    const accessibilityLabel = getLunarDateAccessibilityLabel(
        solarDay, solarMonth, solarYear,
        lunarDay, lunarMonth, lunarYear,
        isLeapMonth, holidayName
    );

    return (
        <TouchableOpacity
            style={[
                styles.container,
                isSelected && { backgroundColor: theme.selected },
                isToday && { borderWidth: 1, borderColor: theme.today },
            ]}
            onPress={onPress}
            disabled={isDisabled}
            accessibilityLabel={accessibilityLabel}
            accessibilityHint={hasEvent ? 'Có sự kiện đã lưu' : 'Nhấn để xem chi tiết'}
        >
            {/* Solar date */}
            <Text
                style={[
                    styles.solarText,
                    { color: theme.text },
                    isDisabled && { color: theme.textMuted },
                    isToday && { color: theme.today, fontWeight: '700' },
                    isHoliday && { color: theme.holiday },
                ]}
            >
                {solarDay}
            </Text>

            {/* Lunar date */}
            <Text
                style={[
                    styles.lunarText,
                    { color: theme.lunar },
                    isDisabled && { color: theme.textMuted },
                    lunarDay === 1 && { color: theme.primary, fontWeight: '600' },
                    isHoliday && { color: theme.holiday },
                ]}
            >
                {lunarText}
            </Text>

            {/* Event indicator dot */}
            {hasEvent && <View style={[styles.eventDot, { backgroundColor: theme.primary }]} />}

            {/* Holiday indicator */}
            {isHoliday && <View style={[styles.holidayBar, { backgroundColor: theme.holiday }]} />}
        </TouchableOpacity>
    );
});

const styles = StyleSheet.create({
    container: {
        width: 44,
        height: 56,
        alignItems: 'center',
        justifyContent: 'center',
        borderRadius: 8,
    },
    solarText: {
        fontSize: 16,
        fontWeight: '500',
    },
    lunarText: {
        fontSize: 10,
        marginTop: 2,
    },
    eventDot: {
        position: 'absolute',
        bottom: 4,
        width: 4,
        height: 4,
        borderRadius: 2,
    },
    holidayBar: {
        position: 'absolute',
        bottom: 0,
        left: 8,
        right: 8,
        height: 2,
        borderRadius: 1,
    },
});
</file>

<file path="src/components/calendar/DayDetailModal.tsx">
import { useTheme } from '@/constants/theme';
import { dateToJd, getAuspiciousHours } from '@/services/lunar';
import { DayInfo } from '@/services/lunar/types';
import { Ionicons } from '@expo/vector-icons';
import React, { useMemo } from 'react';
import {
    Modal,
    SafeAreaView,
    ScrollView,
    StyleSheet,
    Text,
    TouchableOpacity,
    View,
} from 'react-native';
import { AuspiciousHoursGrid } from './AuspiciousHoursGrid';

interface DayDetailModalProps {
    visible: boolean;
    onClose: () => void;
    dayInfo: DayInfo & { holiday?: any };
}

export function DayDetailModal({ visible, onClose, dayInfo }: DayDetailModalProps) {
    const theme = useTheme();

    const auspiciousHours = useMemo(() => {
        const jd = dateToJd(dayInfo.solar.day, dayInfo.solar.month, dayInfo.solar.year);
        return getAuspiciousHours(jd);
    }, [dayInfo.solar]);

    const {
        solar,
        lunar,
        yearCanChi,
        monthCanChi,
        dayCanChi,
        zodiacAnimal,
        holiday,
    } = dayInfo;

    // Format solar date
    const solarDateStr = `Thứ ${getDayOfWeek(solar.day, solar.month, solar.year)}, ${solar.day}/${solar.month}/${solar.year}`;

    // Format lunar date
    const lunarDateStr = `Ngày ${lunar.day} tháng ${lunar.month}${lunar.leap ? ' nhuận' : ''} năm ${yearCanChi.fullName}`;

    return (
        <Modal
            visible={visible}
            animationType="slide"
            presentationStyle="pageSheet"
            onRequestClose={onClose}
        >
            <SafeAreaView style={[styles.container, { backgroundColor: theme.background }]}>
                {/* Header */}
                <View style={[styles.header, { borderBottomColor: theme.border }]}>
                    <TouchableOpacity onPress={onClose} style={styles.closeButton}>
                        <Ionicons name="close" size={24} color={theme.textSecondary} />
                    </TouchableOpacity>
                    <Text style={[styles.headerTitle, { color: theme.text }]}>Chi tiết ngày</Text>
                    <View style={styles.placeholder} />
                </View>

                <ScrollView style={styles.content}>
                    {/* Date Display */}
                    <View style={[styles.dateSection, { borderBottomColor: theme.border }]}>
                        <Text style={[styles.solarDate, { color: theme.text }]}>{solarDateStr}</Text>
                        <Text style={[styles.lunarDate, { color: theme.primary }]}>{lunarDateStr}</Text>

                        {holiday && (
                            <View style={[styles.holidayBadge, { backgroundColor: theme.isDark ? '#3A3010' : '#FFF9E6' }]}>
                                <Ionicons name="star" size={14} color={theme.auspicious} />
                                <Text style={[styles.holidayText, { color: theme.auspicious }]}>{holiday.name}</Text>
                            </View>
                        )}
                    </View>

                    {/* Can Chi Info */}
                    <View style={[styles.canChiSection, { borderBottomColor: theme.border }]}>
                        <Text style={[styles.sectionTitle, { color: theme.text }]}>Can Chi</Text>
                        <View style={styles.canChiGrid}>
                            <View style={styles.canChiItem}>
                                <Text style={[styles.canChiLabel, { color: theme.textMuted }]}>Năm</Text>
                                <Text style={[styles.canChiValue, { color: theme.text }]}>{yearCanChi.fullName}</Text>
                                <Text style={[styles.canChiSub, { color: theme.textMuted }]}>({zodiacAnimal})</Text>
                            </View>
                            <View style={styles.canChiItem}>
                                <Text style={[styles.canChiLabel, { color: theme.textMuted }]}>Tháng</Text>
                                <Text style={[styles.canChiValue, { color: theme.text }]}>{monthCanChi.fullName}</Text>
                            </View>
                            <View style={styles.canChiItem}>
                                <Text style={[styles.canChiLabel, { color: theme.textMuted }]}>Ngày</Text>
                                <Text style={[styles.canChiValue, { color: theme.text }]}>{dayCanChi.fullName}</Text>
                            </View>
                        </View>
                    </View>

                    {/* Auspicious Hours */}
                    <View style={styles.hoursSection}>
                        <Text style={[styles.sectionTitle, { color: theme.text }]}>Giờ Hoàng Đạo</Text>
                        <AuspiciousHoursGrid hours={auspiciousHours} />
                    </View>
                </ScrollView>
            </SafeAreaView>
        </Modal>
    );
}

function getDayOfWeek(d: number, m: number, y: number): string {
    const dow = new Date(y, m - 1, d).getDay();
    const days = ['Chủ Nhật', 'Hai', 'Ba', 'Tư', 'Năm', 'Sáu', 'Bảy'];
    return days[dow];
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: 16,
        paddingVertical: 12,
        borderBottomWidth: 1,
    },
    closeButton: {
        padding: 4,
    },
    headerTitle: {
        fontSize: 17,
        fontWeight: '600',
    },
    placeholder: {
        width: 32,
    },
    content: {
        flex: 1,
        padding: 16,
    },
    dateSection: {
        alignItems: 'center',
        paddingVertical: 20,
        borderBottomWidth: 1,
    },
    solarDate: {
        fontSize: 20,
        fontWeight: '600',
        marginBottom: 4,
    },
    lunarDate: {
        fontSize: 16,
        marginBottom: 12,
    },
    holidayBadge: {
        flexDirection: 'row',
        alignItems: 'center',
        paddingHorizontal: 12,
        paddingVertical: 6,
        borderRadius: 16,
    },
    holidayText: {
        fontSize: 14,
        fontWeight: '500',
        marginLeft: 6,
    },
    canChiSection: {
        paddingVertical: 16,
        borderBottomWidth: 1,
    },
    sectionTitle: {
        fontSize: 16,
        fontWeight: '600',
        marginBottom: 12,
    },
    canChiGrid: {
        flexDirection: 'row',
        justifyContent: 'space-around',
    },
    canChiItem: {
        alignItems: 'center',
    },
    canChiLabel: {
        fontSize: 12,
        marginBottom: 4,
    },
    canChiValue: {
        fontSize: 16,
        fontWeight: '600',
    },
    canChiSub: {
        fontSize: 12,
        marginTop: 2,
    },
    hoursSection: {
        paddingVertical: 16,
    },
});
</file>

<file path="src/components/common/AccessibleText.tsx">
import { useTheme } from '@/constants/theme';
import React from 'react';
import { StyleSheet, Text, TextProps } from 'react-native';

interface AccessibleTextProps extends TextProps {
    accessibilityLabel?: string;
    textRole?: 'header' | 'text' | 'button' | 'label';
    variant?: 'body' | 'caption' | 'title' | 'subtitle';
}

export function AccessibleText({
    children,
    accessibilityLabel,
    textRole = 'text',
    variant = 'body',
    style,
    ...props
}: AccessibleTextProps) {
    const theme = useTheme();

    return (
        <Text
            accessible
            accessibilityLabel={accessibilityLabel}
            accessibilityRole={textRole === 'text' ? 'text' : (textRole as any)}
            style={[
                styles.base,
                styles[variant],
                { color: theme.text },
                style,
            ]}
            {...props}
        >
            {children}
        </Text>
    );
}

const styles = StyleSheet.create({
    base: {
        fontFamily: 'System',
    },
    body: {
        fontSize: 16,
        lineHeight: 22,
    },
    caption: {
        fontSize: 12,
        lineHeight: 16,
    },
    title: {
        fontSize: 20,
        fontWeight: '700',
        lineHeight: 28,
    },
    subtitle: {
        fontSize: 14,
        fontWeight: '600',
        lineHeight: 20,
    },
});
</file>

<file path="src/components/common/Button.tsx">
import React from 'react';
import {
    ActivityIndicator,
    StyleSheet,
    Text,
    TextStyle,
    TouchableOpacity,
    ViewStyle,
} from 'react-native';

interface ButtonProps {
    title: string;
    onPress: () => void;
    loading?: boolean;
    disabled?: boolean;
    variant?: 'primary' | 'secondary' | 'outline';
    style?: ViewStyle;
    textStyle?: TextStyle;
}

export const Button = ({
    title,
    onPress,
    loading = false,
    disabled = false,
    variant = 'primary',
    style,
    textStyle,
}: ButtonProps) => {
    const isPrimary = variant === 'primary';
    const isOutline = variant === 'outline';

    return (
        <TouchableOpacity
            onPress={onPress}
            disabled={disabled || loading}
            style={[
                styles.button,
                isPrimary && styles.primaryButton,
                isOutline && styles.outlineButton,
                disabled && styles.disabledButton,
                style,
            ]}
        >
            {loading ? (
                <ActivityIndicator color={isPrimary ? '#FFFFFF' : '#D4382A'} />
            ) : (
                <Text
                    style={[
                        styles.text,
                        isPrimary && styles.primaryText,
                        isOutline && styles.outlineText,
                        disabled && styles.disabledText,
                        textStyle,
                    ]}
                >
                    {title}
                </Text>
            )}
        </TouchableOpacity>
    );
};

const styles = StyleSheet.create({
    button: {
        paddingVertical: 12,
        paddingHorizontal: 24,
        borderRadius: 8,
        alignItems: 'center',
        justifyContent: 'center',
        minWidth: 120,
    },
    primaryButton: {
        backgroundColor: '#D4382A',
    },
    outlineButton: {
        backgroundColor: 'transparent',
        borderWidth: 1,
        borderColor: '#D4382A',
    },
    disabledButton: {
        backgroundColor: '#F5F5F5',
        borderColor: '#DDDDDD',
    },
    text: {
        fontSize: 16,
        fontWeight: '600',
    },
    primaryText: {
        color: '#FFFFFF',
    },
    outlineText: {
        color: '#D4382A',
    },
    disabledText: {
        color: '#999999',
    },
});
</file>

<file path="src/components/common/Header.tsx">
import { Ionicons } from '@expo/vector-icons';
import { useRouter } from 'expo-router';
import React from 'react';
import { StyleSheet, Text, TouchableOpacity, View } from 'react-native';

interface HeaderProps {
    title: string;
    showBack?: boolean;
    rightElement?: React.ReactNode;
}

export const Header = ({ title, showBack = false, rightElement }: HeaderProps) => {
    const router = useRouter();

    return (
        <View style={styles.container}>
            <View style={styles.left}>
                {showBack && (
                    <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
                        <Ionicons name="chevron-back" size={24} color="#1A1A1A" />
                    </TouchableOpacity>
                )}
            </View>
            <Text style={styles.title} numberOfLines={1}>
                {title}
            </Text>
            <View style={styles.right}>{rightElement}</View>
        </View>
    );
};

const styles = StyleSheet.create({
    container: {
        height: 56,
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: 16,
        backgroundColor: '#FFFFFF',
        borderBottomWidth: 1,
        borderBottomColor: '#EEEEEE',
    },
    left: {
        width: 40,
    },
    right: {
        width: 40,
        alignItems: 'flex-end',
    },
    backButton: {
        padding: 4,
        marginLeft: -4,
    },
    title: {
        flex: 1,
        textAlign: 'center',
        fontSize: 18,
        fontWeight: '600',
        color: '#1A1A1A',
    },
});
</file>

<file path="src/components/common/Modal.tsx">
import { Ionicons } from '@expo/vector-icons';
import React from 'react';
import {
    Modal as RNModal,
    SafeAreaView,
    StyleSheet,
    Text,
    TouchableOpacity,
    View,
} from 'react-native';

interface ModalProps {
    visible: boolean;
    onClose: () => void;
    title?: string;
    children: React.ReactNode;
}

export const Modal = ({ visible, onClose, title, children }: ModalProps) => {
    return (
        <RNModal
            visible={visible}
            animationType="slide"
            presentationStyle="pageSheet"
            onRequestClose={onClose}
        >
            <SafeAreaView style={styles.safeArea}>
                <View style={styles.header}>
                    <TouchableOpacity onPress={onClose} style={styles.closeButton}>
                        <Ionicons name="close" size={24} color="#666666" />
                    </TouchableOpacity>
                    {title && <Text style={styles.title}>{title}</Text>}
                    <View style={styles.placeholder} />
                </View>
                <View style={styles.content}>{children}</View>
            </SafeAreaView>
        </RNModal>
    );
};

const styles = StyleSheet.create({
    safeArea: {
        flex: 1,
        backgroundColor: '#FFFFFF',
    },
    header: {
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'space-between',
        paddingHorizontal: 16,
        paddingVertical: 12,
        borderBottomWidth: 1,
        borderBottomColor: '#EEEEEE',
    },
    closeButton: {
        padding: 4,
    },
    title: {
        fontSize: 17,
        fontWeight: '600',
        color: '#1A1A1A',
    },
    placeholder: {
        width: 32,
    },
    content: {
        flex: 1,
    },
});
</file>

<file path="src/components/events/EventCard.tsx">
import { useTheme } from '@/constants/theme';
import { LunarEvent } from '@/types/event';
import { Ionicons } from '@expo/vector-icons';
import React from 'react';
import { StyleSheet, Text, TouchableOpacity, View } from 'react-native';

interface EventCardProps {
    event: LunarEvent;
    onPress: () => void;
}

export function EventCard({ event, onPress }: EventCardProps) {
    const theme = useTheme();
    const isGio = event.type === 'gio';

    return (
        <TouchableOpacity
            style={[styles.container, { backgroundColor: theme.background }]}
            onPress={onPress}
        >
            <View
                style={[
                    styles.typeIndicator,
                    { backgroundColor: theme.surface },
                    isGio && { backgroundColor: theme.selected },
                ]}
            >
                <Text style={styles.icon}>{isGio ? '🕯️' : '📅'}</Text>
            </View>
            <View style={styles.content}>
                <Text style={[styles.title, { color: theme.text }]} numberOfLines={1}>
                    {event.title}
                </Text>
                <Text style={[styles.date, { color: theme.textSecondary }]}>
                    Ngày {event.lunarDay}/{event.lunarMonth} âm lịch
                    {event.isLeapMonth ? ' (nhuận)' : ''}
                </Text>
            </View>
            <Ionicons name="chevron-forward" size={20} color={theme.border} />
        </TouchableOpacity>
    );
}

const styles = StyleSheet.create({
    container: {
        flexDirection: 'row',
        alignItems: 'center',
        padding: 16,
        borderRadius: 12,
        marginBottom: 12,
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 1 },
        shadowOpacity: 0.05,
        shadowRadius: 2,
        elevation: 2,
    },
    typeIndicator: {
        width: 40,
        height: 40,
        borderRadius: 20,
        alignItems: 'center',
        justifyContent: 'center',
        marginRight: 12,
    },
    icon: {
        fontSize: 20,
    },
    content: {
        flex: 1,
    },
    title: {
        fontSize: 16,
        fontWeight: '600',
        marginBottom: 2,
    },
    date: {
        fontSize: 13,
    },
});
</file>

<file path="src/components/events/EventForm.tsx">
import { useTheme } from '@/constants/theme';
import { useSettingsStore } from '@/stores/settingsStore';
import { EventFormData, EventType } from '@/types/event';
import { Picker } from '@react-native-picker/picker';
import React, { useState } from 'react';
import {
    Alert,
    ScrollView,
    StyleSheet,
    Switch,
    Text,
    TextInput,
    TouchableOpacity,
    View,
} from 'react-native';

interface EventFormProps {
    initialData?: Partial<EventFormData>;
    onSubmit: (data: EventFormData) => void;
    onCancel: () => void;
}

const LUNAR_DAYS = Array.from({ length: 30 }, (_, i) => i + 1);
const LUNAR_MONTHS = Array.from({ length: 12 }, (_, i) => i + 1);
const REMINDER_DAYS = [0, 1, 2, 3, 7, 14];

export function EventForm({ initialData, onSubmit, onCancel }: EventFormProps) {
    const theme = useTheme();
    const defaultReminderDays = useSettingsStore((s) => s.reminderDaysBefore);
    const defaultReminderTime = useSettingsStore((s) => s.reminderTime);

    const [title, setTitle] = useState(initialData?.title ?? '');
    const [description, setDescription] = useState(initialData?.description ?? '');
    const [lunarDay, setLunarDay] = useState(initialData?.lunarDay ?? 1);
    const [lunarMonth, setLunarMonth] = useState(initialData?.lunarMonth ?? 1);
    const [isLeapMonth, setIsLeapMonth] = useState(initialData?.isLeapMonth ?? false);
    const [type, setType] = useState<EventType>(initialData?.type ?? 'gio');
    const [reminderEnabled, setReminderEnabled] = useState(
        initialData?.reminderEnabled ?? true
    );
    const [reminderDaysBefore, setReminderDaysBefore] = useState(
        initialData?.reminderDaysBefore ?? defaultReminderDays
    );
    const [reminderTime, setReminderTime] = useState(
        initialData?.reminderTime ?? defaultReminderTime
    );

    const handleSubmit = () => {
        if (!title.trim()) {
            Alert.alert('Lỗi', 'Vui lòng nhập tên sự kiện');
            return;
        }

        onSubmit({
            title: title.trim(),
            description: description.trim() || undefined,
            lunarDay,
            lunarMonth,
            isLeapMonth,
            type,
            reminderEnabled,
            reminderDaysBefore,
            reminderTime,
        });
    };

    const inputStyle = [
        styles.input,
        { borderColor: theme.border, color: theme.text },
    ];

    return (
        <ScrollView style={[styles.container, { backgroundColor: theme.background }]}>
            {/* Title */}
            <View style={styles.field}>
                <Text style={[styles.label, { color: theme.text }]}>Tên sự kiện *</Text>
                <TextInput
                    style={inputStyle}
                    value={title}
                    onChangeText={setTitle}
                    placeholder="VD: Giỗ Ông Nội"
                    placeholderTextColor={theme.textMuted}
                />
            </View>

            {/* Description */}
            <View style={styles.field}>
                <Text style={[styles.label, { color: theme.text }]}>Ghi chú</Text>
                <TextInput
                    style={[inputStyle, styles.multiline]}
                    value={description}
                    onChangeText={setDescription}
                    placeholder="Thêm ghi chú..."
                    placeholderTextColor={theme.textMuted}
                    multiline
                    numberOfLines={3}
                />
            </View>

            {/* Event Type */}
            <View style={styles.field}>
                <Text style={[styles.label, { color: theme.text }]}>Loại sự kiện</Text>
                <View style={styles.typeButtons}>
                    <TouchableOpacity
                        style={[
                            styles.typeButton,
                            { borderColor: theme.border },
                            type === 'gio' && { borderColor: theme.primary, backgroundColor: theme.selected },
                        ]}
                        onPress={() => setType('gio')}
                    >
                        <Text
                            style={[
                                styles.typeText,
                                { color: theme.textSecondary },
                                type === 'gio' && { color: theme.primary, fontWeight: '600' },
                            ]}
                        >
                            🕯️ Ngày Giỗ
                        </Text>
                    </TouchableOpacity>
                    <TouchableOpacity
                        style={[
                            styles.typeButton,
                            { borderColor: theme.border },
                            type === 'personal' && { borderColor: theme.primary, backgroundColor: theme.selected },
                        ]}
                        onPress={() => setType('personal')}
                    >
                        <Text
                            style={[
                                styles.typeText,
                                { color: theme.textSecondary },
                                type === 'personal' && { color: theme.primary, fontWeight: '600' },
                            ]}
                        >
                            📅 Cá nhân
                        </Text>
                    </TouchableOpacity>
                </View>
            </View>

            {/* Lunar Date */}
            <View style={styles.field}>
                <Text style={[styles.label, { color: theme.text }]}>Ngày âm lịch</Text>
                <View style={styles.dateRow}>
                    <View style={styles.pickerContainer}>
                        <Text style={[styles.pickerLabel, { color: theme.textMuted }]}>Ngày</Text>
                        <View style={[styles.pickerWrapper, { backgroundColor: theme.surface }]}>
                            <Picker
                                selectedValue={lunarDay}
                                onValueChange={setLunarDay}
                                dropdownIconColor={theme.textSecondary}
                            >
                                {LUNAR_DAYS.map((d) => (
                                    <Picker.Item key={d} label={`${d}`} value={d} color={theme.text} />
                                ))}
                            </Picker>
                        </View>
                    </View>
                    <View style={styles.pickerContainer}>
                        <Text style={[styles.pickerLabel, { color: theme.textMuted }]}>Tháng</Text>
                        <View style={[styles.pickerWrapper, { backgroundColor: theme.surface }]}>
                            <Picker
                                selectedValue={lunarMonth}
                                onValueChange={setLunarMonth}
                                dropdownIconColor={theme.textSecondary}
                            >
                                {LUNAR_MONTHS.map((m) => (
                                    <Picker.Item key={m} label={`${m}`} value={m} color={theme.text} />
                                ))}
                            </Picker>
                        </View>
                    </View>
                </View>
                <View style={styles.switchRow}>
                    <Text style={[styles.switchLabel, { color: theme.textSecondary }]}>Tháng nhuận</Text>
                    <Switch
                        value={isLeapMonth}
                        onValueChange={setIsLeapMonth}
                        trackColor={{ false: theme.border, true: theme.primary }}
                    />
                </View>
            </View>

            {/* Reminder */}
            <View style={styles.field}>
                <View style={styles.switchRow}>
                    <Text style={[styles.label, { color: theme.text }]}>Nhắc nhở</Text>
                    <Switch
                        value={reminderEnabled}
                        onValueChange={setReminderEnabled}
                        trackColor={{ false: theme.border, true: theme.primary }}
                    />
                </View>

                {reminderEnabled && (
                    <View style={styles.reminderOptions}>
                        <View style={styles.pickerContainer}>
                            <Text style={[styles.pickerLabel, { color: theme.textMuted }]}>Nhắc trước</Text>
                            <View style={[styles.pickerWrapper, { backgroundColor: theme.surface }]}>
                                <Picker
                                    selectedValue={reminderDaysBefore}
                                    onValueChange={setReminderDaysBefore}
                                    dropdownIconColor={theme.textSecondary}
                                >
                                    {REMINDER_DAYS.map((d) => (
                                        <Picker.Item
                                            key={d}
                                            label={d === 0 ? 'Trong ngày' : `${d} ngày`}
                                            value={d}
                                            color={theme.text}
                                        />
                                    ))}
                                </Picker>
                            </View>
                        </View>
                        <TextInput
                            style={[inputStyle, styles.timeInput]}
                            value={reminderTime}
                            onChangeText={setReminderTime}
                            placeholder="08:00"
                            placeholderTextColor={theme.textMuted}
                            keyboardType="numbers-and-punctuation"
                        />
                    </View>
                )}
            </View>

            {/* Buttons */}
            <View style={styles.buttons}>
                <TouchableOpacity
                    style={[styles.cancelButton, { borderColor: theme.border }]}
                    onPress={onCancel}
                >
                    <Text style={[styles.cancelText, { color: theme.textSecondary }]}>Hủy</Text>
                </TouchableOpacity>
                <TouchableOpacity
                    style={[styles.submitButton, { backgroundColor: theme.primary }]}
                    onPress={handleSubmit}
                >
                    <Text style={styles.submitText}>Lưu</Text>
                </TouchableOpacity>
            </View>
        </ScrollView>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        padding: 16,
    },
    field: {
        marginBottom: 20,
    },
    label: {
        fontSize: 14,
        fontWeight: '600',
        marginBottom: 8,
    },
    input: {
        borderWidth: 1,
        borderRadius: 8,
        padding: 12,
        fontSize: 16,
    },
    multiline: {
        height: 80,
        textAlignVertical: 'top',
    },
    typeButtons: {
        flexDirection: 'row',
        gap: 12,
    },
    typeButton: {
        flex: 1,
        padding: 12,
        borderRadius: 8,
        borderWidth: 1,
        alignItems: 'center',
    },
    typeText: {
        fontSize: 14,
    },
    dateRow: {
        flexDirection: 'row',
        gap: 12,
    },
    pickerContainer: {
        flex: 1,
    },
    pickerLabel: {
        fontSize: 12,
        marginBottom: 4,
    },
    pickerWrapper: {
        borderRadius: 8,
        overflow: 'hidden',
    },
    switchRow: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginTop: 12,
    },
    switchLabel: {
        fontSize: 14,
    },
    reminderOptions: {
        marginTop: 12,
        gap: 12,
    },
    timeInput: {
        width: 100,
    },
    buttons: {
        flexDirection: 'row',
        gap: 12,
        marginTop: 20,
        marginBottom: 40,
    },
    cancelButton: {
        flex: 1,
        padding: 16,
        borderRadius: 8,
        borderWidth: 1,
        alignItems: 'center',
    },
    cancelText: {
        fontSize: 16,
    },
    submitButton: {
        flex: 1,
        padding: 16,
        borderRadius: 8,
        alignItems: 'center',
    },
    submitText: {
        fontSize: 16,
        color: '#FFFFFF',
        fontWeight: '600',
    },
});
</file>

<file path="src/components/events/EventList.tsx">
import { useTheme } from '@/constants/theme';
import { useEventsStore } from '@/stores/eventStore';
import { LunarEvent } from '@/types/event';
import { useRouter } from 'expo-router';
import React, { useMemo } from 'react';
import { FlatList, StyleSheet, Text, View } from 'react-native';
import { EventCard } from './EventCard';

interface EventListProps {
    filterMonth?: number;
}

export function EventList({ filterMonth }: EventListProps) {
    const theme = useTheme();
    const router = useRouter();
    const events = useEventsStore((state) => state.events);

    // Group events by lunar month
    const groupedEvents = useMemo(() => {
        let filtered = events;
        if (filterMonth !== undefined) {
            filtered = events.filter((e) => e.lunarMonth === filterMonth);
        }

        const groups: Record<number, LunarEvent[]> = {};
        filtered.forEach((event) => {
            if (!groups[event.lunarMonth]) {
                groups[event.lunarMonth] = [];
            }
            groups[event.lunarMonth].push(event);
        });

        // Sort each group by day
        Object.values(groups).forEach((group) => {
            group.sort((a, b) => a.lunarDay - b.lunarDay);
        });

        return Object.entries(groups)
            .sort(([a], [b]) => Number(a) - Number(b))
            .map(([month, items]) => ({
                month: Number(month),
                data: items,
            }));
    }, [events, filterMonth]);

    const handleEventPress = (event: LunarEvent) => {
        router.push(`/event/${event.id}`);
    };

    if (events.length === 0) {
        return (
            <View style={styles.emptyContainer}>
                <Text style={[styles.emptyText, { color: theme.textMuted }]}>
                    Chưa có sự kiện nào
                </Text>
            </View>
        );
    }

    return (
        <FlatList
            data={groupedEvents}
            keyExtractor={(item) => item.month.toString()}
            renderItem={({ item }) => (
                <View style={styles.groupContainer}>
                    <Text style={[styles.groupHeader, { color: theme.primary }]}>
                        Tháng {item.month}
                    </Text>
                    {item.data.map((event) => (
                        <EventCard
                            key={event.id}
                            event={event}
                            onPress={() => handleEventPress(event)}
                        />
                    ))}
                </View>
            )}
            contentContainerStyle={styles.listContent}
        />
    );
}

const styles = StyleSheet.create({
    emptyContainer: {
        padding: 40,
        alignItems: 'center',
    },
    emptyText: {
        fontSize: 16,
    },
    listContent: {
        padding: 16,
    },
    groupContainer: {
        marginBottom: 20,
    },
    groupHeader: {
        fontSize: 14,
        fontWeight: '600',
        marginBottom: 12,
        marginLeft: 4,
        textTransform: 'uppercase',
    },
});
</file>

<file path="src/components/EditScreenInfo.tsx">
import React from 'react';
import { StyleSheet } from 'react-native';

import { ExternalLink } from './ExternalLink';
import { MonoText } from './StyledText';
import { Text, View } from './Themed';

import Colors from '@/constants/Colors';

export default function EditScreenInfo({ path }: { path: string }) {
  return (
    <View>
      <View style={styles.getStartedContainer}>
        <Text
          style={styles.getStartedText}
          lightColor="rgba(0,0,0,0.8)"
          darkColor="rgba(255,255,255,0.8)">
          Open up the code for this screen:
        </Text>

        <View
          style={[styles.codeHighlightContainer, styles.homeScreenFilename]}
          darkColor="rgba(255,255,255,0.05)"
          lightColor="rgba(0,0,0,0.05)">
          <MonoText>{path}</MonoText>
        </View>

        <Text
          style={styles.getStartedText}
          lightColor="rgba(0,0,0,0.8)"
          darkColor="rgba(255,255,255,0.8)">
          Change any of the text, save the file, and your app will automatically update.
        </Text>
      </View>

      <View style={styles.helpContainer}>
        <ExternalLink
          style={styles.helpLink}
          href="https://docs.expo.io/get-started/create-a-new-app/#opening-the-app-on-your-phonetablet">
          <Text style={styles.helpLinkText} lightColor={Colors.light.tint}>
            Tap here if your app doesn't automatically update after making changes
          </Text>
        </ExternalLink>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  getStartedContainer: {
    alignItems: 'center',
    marginHorizontal: 50,
  },
  homeScreenFilename: {
    marginVertical: 7,
  },
  codeHighlightContainer: {
    borderRadius: 3,
    paddingHorizontal: 4,
  },
  getStartedText: {
    fontSize: 17,
    lineHeight: 24,
    textAlign: 'center',
  },
  helpContainer: {
    marginTop: 15,
    marginHorizontal: 20,
    alignItems: 'center',
  },
  helpLink: {
    paddingVertical: 15,
  },
  helpLinkText: {
    textAlign: 'center',
  },
});
</file>

<file path="src/components/ExternalLink.tsx">
import { Link } from 'expo-router';
import * as WebBrowser from 'expo-web-browser';
import React from 'react';
import { Platform } from 'react-native';

export function ExternalLink(
  props: Omit<React.ComponentProps<typeof Link>, 'href'> & { href: string }
) {
  return (
    <Link
      target="_blank"
      {...props}
      // @ts-expect-error: External URLs are not typed.
      href={props.href}
      onPress={(e) => {
        if (Platform.OS !== 'web') {
          // Prevent the default behavior of linking to the default browser on native.
          e.preventDefault();
          // Open the link in an in-app browser.
          WebBrowser.openBrowserAsync(props.href as string);
        }
      }}
    />
  );
}
</file>

<file path="src/components/StyledText.tsx">
import { Text, TextProps } from './Themed';

export function MonoText(props: TextProps) {
  return <Text {...props} style={[props.style, { fontFamily: 'SpaceMono' }]} />;
}
</file>

<file path="src/components/Themed.tsx">
/**
 * Learn more about Light and Dark modes:
 * https://docs.expo.io/guides/color-schemes/
 */

import { Text as DefaultText, View as DefaultView } from 'react-native';

import Colors from '@/constants/Colors';
import { useColorScheme } from './useColorScheme';

type ThemeProps = {
  lightColor?: string;
  darkColor?: string;
};

export type TextProps = ThemeProps & DefaultText['props'];
export type ViewProps = ThemeProps & DefaultView['props'];

export function useThemeColor(
  props: { light?: string; dark?: string },
  colorName: keyof typeof Colors.light & keyof typeof Colors.dark
) {
  const theme = useColorScheme() ?? 'light';
  const colorFromProps = props[theme];

  if (colorFromProps) {
    return colorFromProps;
  } else {
    return Colors[theme][colorName];
  }
}

export function Text(props: TextProps) {
  const { style, lightColor, darkColor, ...otherProps } = props;
  const color = useThemeColor({ light: lightColor, dark: darkColor }, 'text');

  return <DefaultText style={[{ color }, style]} {...otherProps} />;
}

export function View(props: ViewProps) {
  const { style, lightColor, darkColor, ...otherProps } = props;
  const backgroundColor = useThemeColor({ light: lightColor, dark: darkColor }, 'background');

  return <DefaultView style={[{ backgroundColor }, style]} {...otherProps} />;
}
</file>

<file path="src/components/useClientOnlyValue.ts">
// This function is web-only as native doesn't currently support server (or build-time) rendering.
export function useClientOnlyValue<S, C>(server: S, client: C): S | C {
  return client;
}
</file>

<file path="src/components/useClientOnlyValue.web.ts">
import React from 'react';

// `useEffect` is not invoked during server rendering, meaning
// we can use this to determine if we're on the server or not.
export function useClientOnlyValue<S, C>(server: S, client: C): S | C {
  const [value, setValue] = React.useState<S | C>(server);
  React.useEffect(() => {
    setValue(client);
  }, [client]);

  return value;
}
</file>

<file path="src/components/useColorScheme.ts">
export { useColorScheme } from 'react-native';
</file>

<file path="src/components/useColorScheme.web.ts">
// NOTE: The default React Native styling doesn't support server rendering.
// Server rendered styles should not change between the first render of the HTML
// and the first render on the client. Typically, web developers will use CSS media queries
// to render different styles on the client and server, these aren't directly supported in React Native
// but can be achieved using a styling library like Nativewind.
export function useColorScheme() {
  return 'light';
}
</file>

<file path="src/constants/Colors.ts">
const tintColorLight = '#2f95dc';
const tintColorDark = '#fff';

export default {
  light: {
    text: '#000',
    background: '#fff',
    tint: tintColorLight,
    tabIconDefault: '#ccc',
    tabIconSelected: tintColorLight,
  },
  dark: {
    text: '#fff',
    background: '#000',
    tint: tintColorDark,
    tabIconDefault: '#ccc',
    tabIconSelected: tintColorDark,
  },
};
</file>

<file path="src/constants/holidays.ts">
import { Holiday } from '@/services/lunar/types';

export const VIETNAMESE_HOLIDAYS: Holiday[] = [
    // National Holidays (Lunar)
    {
        name: 'Tết Nguyên Đán',
        nameLatin: 'Tet Nguyen Dan',
        lunarMonth: 1,
        lunarDay: 1,
        description: 'Vietnamese Lunar New Year - most important holiday',
        isNational: true,
    },
    {
        name: 'Mùng 2 Tết',
        nameLatin: 'Tet Day 2',
        lunarMonth: 1,
        lunarDay: 2,
        description: 'Second day of Tet - visiting maternal family',
        isNational: true,
    },
    {
        name: 'Mùng 3 Tết',
        nameLatin: 'Tet Day 3',
        lunarMonth: 1,
        lunarDay: 3,
        description: 'Third day of Tet - visiting teachers',
        isNational: true,
    },
    {
        name: 'Tết Nguyên Tiêu',
        nameLatin: 'Tet Nguyen Tieu',
        lunarMonth: 1,
        lunarDay: 15,
        description: 'First full moon of the year - temple visits',
        isNational: false,
    },
    {
        name: 'Tết Thanh Minh',
        nameLatin: 'Tet Thanh Minh',
        lunarMonth: 3,
        lunarDay: 3,
        description: 'Tomb Sweeping Day - visit ancestral graves',
        isNational: false,
    },
    {
        name: 'Giỗ Tổ Hùng Vương',
        nameLatin: 'Hung Kings Commemoration',
        lunarMonth: 3,
        lunarDay: 10,
        description: 'Commemoration of legendary founders of Vietnam',
        isNational: true,
    },
    {
        name: 'Tết Đoan Ngọ',
        nameLatin: 'Tet Doan Ngo',
        lunarMonth: 5,
        lunarDay: 5,
        description: 'Mid-year festival - killing insects ritual',
        isNational: false,
    },
    {
        name: 'Lễ Vu Lan',
        nameLatin: 'Vu Lan Festival',
        lunarMonth: 7,
        lunarDay: 15,
        description: 'Ghost Festival - honoring ancestors and wandering spirits',
        isNational: false,
    },
    {
        name: 'Tết Trung Thu',
        nameLatin: 'Mid-Autumn Festival',
        lunarMonth: 8,
        lunarDay: 15,
        description: "Children's festival with mooncakes and lanterns",
        isNational: false,
    },
    {
        name: 'Tết Trùng Cửu',
        nameLatin: 'Double Ninth Festival',
        lunarMonth: 9,
        lunarDay: 9,
        description: 'Day to climb heights and remember ancestors',
        isNational: false,
    },
    {
        name: 'Tết Hạ Nguyên',
        nameLatin: 'Tet Ha Nguyen',
        lunarMonth: 10,
        lunarDay: 15,
        description: 'Third full moon ceremony',
        isNational: false,
    },
    {
        name: 'Ông Công Ông Táo',
        nameLatin: 'Kitchen Gods Day',
        lunarMonth: 12,
        lunarDay: 23,
        description: 'Kitchen Gods return to heaven to report',
        isNational: false,
    },
    {
        name: 'Tất Niên',
        nameLatin: 'New Year Eve',
        lunarMonth: 12,
        lunarDay: 30, // or 29 if month has 29 days
        description: 'Last day of lunar year - family reunion dinner',
        isNational: false,
    },
];

// Monthly recurring observances
export const MONTHLY_OBSERVANCES = [
    { lunarDay: 1, name: 'Mùng Một', description: 'First day of lunar month' },
    { lunarDay: 15, name: 'Rằm', description: 'Full moon day - temple visits' },
];

/**
 * Get holidays for a specific lunar month
 */
export function getHolidaysForMonth(lunarMonth: number): Holiday[] {
    return VIETNAMESE_HOLIDAYS.filter((h) => h.lunarMonth === lunarMonth);
}

/**
 * Check if a lunar date is a holiday
 */
export function getHolidayForDate(lunarDay: number, lunarMonth: number): Holiday | undefined {
    return VIETNAMESE_HOLIDAYS.find(
        (h) => h.lunarDay === lunarDay && h.lunarMonth === lunarMonth
    );
}
</file>

<file path="src/constants/theme.ts">
import { useColorScheme } from 'react-native';

export const palette = {
    white: '#FFFFFF',
    black: '#000000',
    red: '#D4382A',
    darkRed: '#A32920',
    gold: '#C4982E',
    lightGold: '#FFF9E6',
    gray1: '#1A1A1A',
    gray2: '#2A2A2A',
    gray3: '#666666',
    gray4: '#888888',
    gray5: '#CCCCCC',
    gray6: '#DDDDDD',
    gray7: '#EEEEEE',
    gray8: '#F5F5F5',
    gray9: '#F8F8F8',
    redLight: '#FFF3F0',
    redDark: '#3A2020',
};

export const colors = {
    light: {
        primary: palette.red,
        secondary: palette.gold,
        background: palette.white,
        surface: palette.gray8,
        surfaceAlt: palette.gray9,
        text: palette.gray1,
        textSecondary: palette.gray3,
        textMuted: palette.gray4,
        border: palette.gray7,
        lunar: palette.gray4,
        holiday: palette.red,
        auspicious: palette.gold,
        today: palette.red,
        selected: palette.redLight,
        error: '#FF3B30',
    },
    dark: {
        primary: '#FF5A4D',
        secondary: '#E6B84D',
        background: palette.gray1,
        surface: palette.gray2,
        surfaceAlt: '#121212',
        text: palette.white,
        textSecondary: '#AAAAAA',
        textMuted: palette.gray4,
        border: '#3A3A3A',
        lunar: palette.gray4,
        holiday: '#FF5A4D',
        auspicious: '#E6B84D',
        today: '#FF5A4D',
        selected: palette.redDark,
        error: '#FF453A',
    },
};

export function useTheme() {
    const colorScheme = useColorScheme();
    const theme = colorScheme === 'dark' ? colors.dark : colors.light;
    return {
        ...theme,
        isDark: colorScheme === 'dark',
    };
}
</file>

<file path="src/hooks/useAuspiciousHours.ts">
import { dateToJd, getAuspiciousHours, getOnlyAuspiciousHours } from '@/services/lunar';
import { useMemo } from 'react';

export function useAuspiciousHours(date: Date | string, onlyAuspicious = false) {
    return useMemo(() => {
        const d = typeof date === 'string' ? new Date(date) : date;
        const jd = dateToJd(d.getDate(), d.getMonth() + 1, d.getFullYear());

        return onlyAuspicious ? getOnlyAuspiciousHours(jd) : getAuspiciousHours(jd);
    }, [date, onlyAuspicious]);
}
</file>

<file path="src/hooks/useLunarDate.ts">
import { getDayInfo } from '@/services/lunar';
import { useMemo } from 'react';

export function useLunarDate(date: Date | string) {
    return useMemo(() => {
        const d = typeof date === 'string' ? new Date(date) : date;
        return getDayInfo(d.getDate(), d.getMonth() + 1, d.getFullYear());
    }, [date]);
}
</file>

<file path="src/services/lunar/auspiciousHours.ts">
import { CHI, getDayChi } from './canChi';
import { AuspiciousHour } from './types';

// Giờ hoàng đạo lookup by day's Chi index
// Each array contains indices of auspicious hour Chi (0-11)
// Based on traditional Vietnamese almanac
const AUSPICIOUS_HOURS_BY_DAY_CHI: Record<number, number[]> = {
    0: [0, 1, 4, 5, 8, 9],    // Ngày Tý: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
    1: [2, 3, 6, 7, 10, 11],  // Ngày Sửu: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
    2: [0, 1, 4, 5, 8, 9],    // Ngày Dần: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
    3: [2, 3, 6, 7, 10, 11],  // Ngày Mão: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
    4: [0, 1, 4, 5, 8, 9],    // Ngày Thìn: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
    5: [2, 3, 6, 7, 10, 11],  // Ngày Tỵ: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
    6: [0, 1, 4, 5, 8, 9],    // Ngày Ngọ: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
    7: [2, 3, 6, 7, 10, 11],  // Ngày Mùi: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
    8: [0, 1, 4, 5, 8, 9],    // Ngày Thân: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
    9: [2, 3, 6, 7, 10, 11],  // Ngày Dậu: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
    10: [0, 1, 4, 5, 8, 9],    // Ngày Tuất: Tý, Sửu, Thìn, Tỵ, Thân, Dậu
    11: [2, 3, 6, 7, 10, 11],  // Ngày Hợi: Dần, Mão, Ngọ, Mùi, Tuất, Hợi
};

// Six auspicious stars (Lục Hoàng Đạo)
const AUSPICIOUS_STARS = [
    'Thanh Long',   // Azure Dragon - most auspicious
    'Minh Đường',   // Bright Hall
    'Kim Quỹ',      // Golden Cabinet
    'Thiên Đức',    // Heavenly Virtue
    'Ngọc Đường',   // Jade Hall
    'Tư Mệnh',      // Commanding Fate
];

// Hour time ranges
const HOUR_TIMES: [string, string][] = [
    ['23:00', '01:00'], // Tý
    ['01:00', '03:00'], // Sửu
    ['03:00', '05:00'], // Dần
    ['05:00', '07:00'], // Mão
    ['07:00', '09:00'], // Thìn
    ['09:00', '11:00'], // Tỵ
    ['11:00', '13:00'], // Ngọ
    ['13:00', '15:00'], // Mùi
    ['15:00', '17:00'], // Thân
    ['17:00', '19:00'], // Dậu
    ['19:00', '21:00'], // Tuất
    ['21:00', '23:00'], // Hợi
];

/**
 * Get all 12 hours with auspicious status for a given Julian Day
 */
export function getAuspiciousHours(jd: number): AuspiciousHour[] {
    const dayChi = getDayChi(jd);
    const auspiciousIndices = AUSPICIOUS_HOURS_BY_DAY_CHI[dayChi];

    return CHI.map((name, index) => {
        const isAuspicious = auspiciousIndices.includes(index);
        const starIndex = auspiciousIndices.indexOf(index);

        return {
            name,
            startTime: HOUR_TIMES[index][0],
            endTime: HOUR_TIMES[index][1],
            isAuspicious,
            star: isAuspicious ? AUSPICIOUS_STARS[starIndex] : undefined,
        };
    });
}

/**
 * Get only auspicious hours for a day
 */
export function getOnlyAuspiciousHours(jd: number): AuspiciousHour[] {
    return getAuspiciousHours(jd).filter((h) => h.isAuspicious);
}

/**
 * Check if a specific hour is auspicious
 */
export function isHourAuspicious(hour: number, jd: number): boolean {
    const chiIndex = Math.floor(((hour + 1) % 24) / 2);
    const dayChi = getDayChi(jd);
    return AUSPICIOUS_HOURS_BY_DAY_CHI[dayChi].includes(chiIndex);
}
</file>

<file path="src/services/lunar/canChi.ts">
import { CanChi } from './types';

// Thiên Can (Heavenly Stems)
const CAN = ['Giáp', 'Ất', 'Bính', 'Đinh', 'Mậu', 'Kỷ', 'Canh', 'Tân', 'Nhâm', 'Quý'];

// Địa Chi (Earthly Branches)
const CHI = ['Tý', 'Sửu', 'Dần', 'Mão', 'Thìn', 'Tỵ', 'Ngọ', 'Mùi', 'Thân', 'Dậu', 'Tuất', 'Hợi'];

// Vietnamese zodiac animals (same order as CHI)
const ZODIAC_ANIMALS = [
    'Chuột', 'Trâu', 'Hổ', 'Mèo', 'Rồng', 'Rắn',
    'Ngựa', 'Dê', 'Khỉ', 'Gà', 'Chó', 'Lợn'
];

/**
 * Calculate Can Chi for lunar year
 */
export function getYearCanChi(lunarYear: number): CanChi {
    const canIndex = (lunarYear + 6) % 10;
    const chiIndex = (lunarYear + 8) % 12;

    return {
        can: CAN[canIndex],
        chi: CHI[chiIndex],
        fullName: `${CAN[canIndex]} ${CHI[chiIndex]}`,
        index: (canIndex * 12 + chiIndex) % 60,
    };
}

/**
 * Calculate Can Chi for lunar month
 * Depends on lunar year's Can
 */
export function getMonthCanChi(lunarMonth: number, lunarYear: number): CanChi {
    const yearCan = (lunarYear + 6) % 10;
    // First month starts from Dần (index 2)
    const chiIndex = (lunarMonth + 1) % 12;
    // Can of month depends on year's Can
    const canIndex = (yearCan * 2 + lunarMonth) % 10;

    return {
        can: CAN[canIndex],
        chi: CHI[chiIndex],
        fullName: `${CAN[canIndex]} ${CHI[chiIndex]}`,
        index: (canIndex * 12 + chiIndex) % 60,
    };
}

/**
 * Calculate Can Chi for a day using Julian Day Number
 */
export function getDayCanChi(jd: number): CanChi {
    const canIndex = (jd + 9) % 10;
    const chiIndex = (jd + 1) % 12;

    return {
        can: CAN[canIndex],
        chi: CHI[chiIndex],
        fullName: `${CAN[canIndex]} ${CHI[chiIndex]}`,
        index: (canIndex * 12 + chiIndex) % 60,
    };
}

/**
 * Calculate Can Chi for an hour
 * Hour Chi is fixed (Tý = 23:00-01:00)
 * Hour Can depends on day's Can
 */
export function getHourCanChi(hour: number, dayJd: number): CanChi {
    // Convert hour to Chi index (Tý starts at 23:00)
    const chiIndex = Math.floor(((hour + 1) % 24) / 2);

    // Hour Can depends on day's Can
    const dayCan = (dayJd + 9) % 10;
    const canIndex = (dayCan * 2 + chiIndex) % 10;

    return {
        can: CAN[canIndex],
        chi: CHI[chiIndex],
        fullName: `${CAN[canIndex]} ${CHI[chiIndex]}`,
        index: (canIndex * 12 + chiIndex) % 60,
    };
}

/**
 * Get Vietnamese zodiac animal for a lunar year
 */
export function getZodiacAnimal(lunarYear: number): string {
    const chiIndex = (lunarYear + 8) % 12;
    return ZODIAC_ANIMALS[chiIndex];
}

/**
 * Get the Chi (Earthly Branch) index for a given Julian Day
 * Used for auspicious hour calculation
 */
export function getDayChi(jd: number): number {
    return (jd + 1) % 12;
}

export { CAN, CHI, ZODIAC_ANIMALS };
</file>

<file path="src/services/lunar/converter.ts">
import { getNewMoonDay, getSunLongitude } from './newMoon';
import { LunarDate, SolarDate } from './types';

const TIMEZONE = 7; // Vietnam GMT+7

/**
 * Convert Julian Day Number to Solar Date
 */
export function jdToDate(jd: number): SolarDate {
    const Z = Math.floor(jd + 0.5);
    const F = jd + 0.5 - Z;
    let A: number;

    if (Z < 2299161) {
        A = Z;
    } else {
        const alpha = Math.floor((Z - 1867216.25) / 36524.25);
        A = Z + 1 + alpha - Math.floor(alpha / 4);
    }

    const B = A + 1524;
    const C = Math.floor((B - 122.1) / 365.25);
    const D = Math.floor(365.25 * C);
    const E = Math.floor((B - D) / 30.6001);

    const day = B - D - Math.floor(30.6001 * E) + F;
    const month = E < 14 ? E - 1 : E - 13;
    const year = month > 2 ? C - 4716 : C - 4715;

    return { day: Math.floor(day), month, year };
}

/**
 * Convert Solar Date to Julian Day Number
 */
export function dateToJd(day: number, month: number, year: number): number {
    let a = Math.floor((14 - month) / 12);
    let y = year + 4800 - a;
    let m = month + 12 * a - 3;

    let jd = day + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4);

    if (year > 1582 || (year === 1582 && (month > 10 || (month === 10 && day >= 15)))) {
        jd = jd - Math.floor(y / 100) + Math.floor(y / 400) - 32045;
    } else {
        jd = jd - 32083;
    }

    return jd;
}

/**
 * Get lunar month info for a given lunar month
 * Returns [newMoonJD, leapMonth] where leapMonth is 0 if not leap
 */
function getLunarMonth11(year: number): number {
    const off = dateToJd(31, 12, year) - 2415021;
    const k = Math.floor(off / 29.530588853);
    let nm = getNewMoonDay(k, TIMEZONE);
    const sunLong = getSunLongitude(nm, TIMEZONE);

    if (sunLong >= 9) {
        nm = getNewMoonDay(k - 1, TIMEZONE);
    }

    return nm;
}

/**
 * Determine leap month in lunar year
 * Returns 0 if no leap month, or the leap month number (1-12)
 */
function getLeapMonthOffset(a11: number): number {
    const k = Math.floor((a11 - 2415021.076998695) / 29.530588853 + 0.5);
    let last = 0;
    let i = 1;
    let arc = getSunLongitude(getNewMoonDay(k + i, TIMEZONE), TIMEZONE);

    do {
        last = arc;
        i++;
        arc = getSunLongitude(getNewMoonDay(k + i, TIMEZONE), TIMEZONE);
    } while (arc !== last && i < 14);

    return i - 1;
}

/**
 * Convert Solar Date to Lunar Date
 */
export function solarToLunar(dd: number, mm: number, yy: number): LunarDate {
    const dayNumber = dateToJd(dd, mm, yy);
    const k = Math.floor((dayNumber - 2415021.076998695) / 29.530588853);

    let monthStart = getNewMoonDay(k + 1, TIMEZONE);
    if (monthStart > dayNumber) {
        monthStart = getNewMoonDay(k, TIMEZONE);
    }

    let a11 = getLunarMonth11(yy);
    let b11 = a11;

    let lunarYear: number;
    if (a11 >= monthStart) {
        lunarYear = yy;
        a11 = getLunarMonth11(yy - 1);
    } else {
        lunarYear = yy + 1;
        b11 = getLunarMonth11(yy + 1);
    }

    const lunarDay = dayNumber - monthStart + 1;
    const diff = Math.floor((monthStart - a11) / 29);

    let lunarLeap = false;
    let lunarMonth = diff + 11;

    if (b11 - a11 > 365) {
        const leapMonthDiff = getLeapMonthOffset(a11);
        if (diff >= leapMonthDiff) {
            lunarMonth = diff + 10;
            if (diff === leapMonthDiff) {
                lunarLeap = true;
            }
        }
    }

    if (lunarMonth > 12) {
        lunarMonth = lunarMonth - 12;
    }
    if (lunarMonth >= 11 && diff < 4) {
        lunarYear -= 1;
    }

    return {
        day: lunarDay,
        month: lunarMonth,
        year: lunarYear,
        leap: lunarLeap,
        jd: dayNumber,
    };
}

/**
 * Convert Lunar Date to Solar Date
 */
export function lunarToSolar(
    lunarDay: number,
    lunarMonth: number,
    lunarYear: number,
    lunarLeap: boolean = false
): SolarDate {
    let a11: number, b11: number;

    if (lunarMonth < 11) {
        a11 = getLunarMonth11(lunarYear - 1);
        b11 = getLunarMonth11(lunarYear);
    } else {
        a11 = getLunarMonth11(lunarYear);
        b11 = getLunarMonth11(lunarYear + 1);
    }

    const k = Math.floor(0.5 + (a11 - 2415021.076998695) / 29.530588853);
    let off = lunarMonth - 11;
    if (off < 0) {
        off += 12;
    }

    if (b11 - a11 > 365) {
        const leapOff = getLeapMonthOffset(a11);
        let leapMonth = leapOff - 2;
        if (leapMonth < 0) {
            leapMonth += 12;
        }
        if (lunarLeap && lunarMonth !== leapMonth) {
            return { day: 0, month: 0, year: 0 }; // Invalid leap month
        }
        if (lunarLeap || off >= leapOff) {
            off += 1;
        }
    }

    const monthStart = getNewMoonDay(k + off, TIMEZONE);
    return jdToDate(monthStart + lunarDay - 1);
}
</file>

<file path="src/services/lunar/index.ts">
// Main public API for lunar calendar service
export { getHolidayForDate, getHolidaysForMonth, MONTHLY_OBSERVANCES, VIETNAMESE_HOLIDAYS } from '../../constants/holidays';
export { getAuspiciousHours, getOnlyAuspiciousHours, isHourAuspicious } from './auspiciousHours';
export { CAN, CHI, getDayCanChi, getHourCanChi, getMonthCanChi, getYearCanChi, getZodiacAnimal } from './canChi';
export { dateToJd, jdToDate, lunarToSolar, solarToLunar } from './converter';
export type { AuspiciousHour, CanChi, DayInfo, Holiday, LunarDate, SolarDate } from './types';

import { getHolidayForDate } from '../../constants/holidays';
import { getDayCanChi, getMonthCanChi, getYearCanChi, getZodiacAnimal } from './canChi';
import { dateToJd, solarToLunar } from './converter';
import { DayInfo, Holiday } from './types';

/**
 * Get complete day information for a solar date
 * This is the main convenience function
 */
export function getDayInfo(day: number, month: number, year: number): DayInfo & { holiday?: Holiday } {
    const lunar = solarToLunar(day, month, year);
    const jd = dateToJd(day, month, year);

    return {
        solar: { day, month, year },
        lunar,
        yearCanChi: getYearCanChi(lunar.year),
        monthCanChi: getMonthCanChi(lunar.month, lunar.year),
        dayCanChi: getDayCanChi(jd),
        zodiacAnimal: getZodiacAnimal(lunar.year),
        holiday: getHolidayForDate(lunar.day, lunar.month),
    };
}
</file>

<file path="src/services/lunar/newMoon.ts">
const PI = Math.PI;

/**
 * Calculate Julian day number of the k-th new moon after J2000
 * Algorithm from "Astronomical Algorithms" by Jean Meeus
 */
export function getNewMoonDay(k: number, timeZone: number): number {
    const T = k / 1236.85;
    const T2 = T * T;
    const T3 = T2 * T;

    const dr = PI / 180;

    let Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T2 - 0.000000155 * T3;
    Jd1 = Jd1 + 0.00033 * Math.sin((166.56 + 132.87 * T - 0.009173 * T2) * dr);

    const M = 359.2242 + 29.10535608 * k - 0.0000333 * T2 - 0.00000347 * T3;
    const Mpr = 306.0253 + 385.81691806 * k + 0.0107306 * T2 + 0.00001236 * T3;
    const F = 21.2964 + 390.67050646 * k - 0.0016528 * T2 - 0.00000239 * T3;

    let C1 = (0.1734 - 0.000393 * T) * Math.sin(M * dr) + 0.0021 * Math.sin(2 * dr * M);
    C1 = C1 - 0.4068 * Math.sin(Mpr * dr) + 0.0161 * Math.sin(dr * 2 * Mpr);
    C1 = C1 - 0.0004 * Math.sin(dr * 3 * Mpr);
    C1 = C1 + 0.0104 * Math.sin(dr * 2 * F) - 0.0051 * Math.sin(dr * (M + Mpr));
    C1 = C1 - 0.0074 * Math.sin(dr * (M - Mpr)) + 0.0004 * Math.sin(dr * (2 * F + M));
    C1 = C1 - 0.0004 * Math.sin(dr * (2 * F - M)) - 0.0006 * Math.sin(dr * (2 * F + Mpr));
    C1 = C1 + 0.0104 * Math.sin(dr * (2 * F - Mpr)) + 0.0005 * Math.sin(dr * (2 * Mpr + M));

    let deltat: number;
    if (T < -11) {
        deltat = 0.001 + 0.000839 * T + 0.0002261 * T2 - 0.00000845 * T3 - 0.000000081 * T * T3;
    } else {
        deltat = -0.000278 + 0.000265 * T + 0.000262 * T2;
    }

    const JdNew = Jd1 + C1 - deltat;
    return Math.floor(JdNew + 0.5 + timeZone / 24);
}

/**
 * Calculate sun longitude at a given Julian day
 * Returns position in zodiac (0-11)
 */
export function getSunLongitude(jd: number, timeZone: number): number {
    const T = (jd - 2451545.5 - timeZone / 24) / 36525;
    const T2 = T * T;
    const dr = PI / 180;

    const M = 357.5291 + 35999.0503 * T - 0.0001559 * T2 - 0.00000048 * T * T2;
    const L0 = 280.46645 + 36000.76983 * T + 0.0003032 * T2;

    let DL = (1.9146 - 0.004817 * T - 0.000014 * T2) * Math.sin(dr * M);
    DL = DL + (0.019993 - 0.000101 * T) * Math.sin(dr * 2 * M) + 0.00029 * Math.sin(dr * 3 * M);

    let L = L0 + DL;
    L = L * dr;
    L = L - PI * 2 * Math.floor(L / (PI * 2));

    return Math.floor((L / PI) * 6);
}
</file>

<file path="src/services/lunar/types.ts">
export interface LunarDate {
    day: number;        // 1-30
    month: number;      // 1-12
    year: number;       // e.g., 2026
    leap: boolean;      // is this a leap month?
    jd: number;         // Julian day number
}

export interface SolarDate {
    day: number;
    month: number;
    year: number;
}

export interface CanChi {
    can: string;        // Heavenly Stem (Giáp, Ất, Bính...)
    chi: string;        // Earthly Branch (Tý, Sửu, Dần...)
    fullName: string;   // Combined name (Giáp Tý)
    index: number;      // Position in 60-year cycle (0-59)
}

export interface DayInfo {
    solar: SolarDate;
    lunar: LunarDate;
    yearCanChi: CanChi;
    monthCanChi: CanChi;
    dayCanChi: CanChi;
    zodiacAnimal: string;  // Con giáp (Tý, Sửu, Dần...)
    solarTerm?: string;    // Tiết khí if applicable
}

export interface AuspiciousHour {
    name: string;       // Tý, Sửu, etc.
    startTime: string;  // "23:00"
    endTime: string;    // "01:00"
    isAuspicious: boolean;
    star?: string;      // Thanh Long, Kim Quỹ, etc.
}

export interface Holiday {
    name: string;
    nameLatin: string;
    lunarMonth: number;
    lunarDay: number;
    description?: string;
    isNational: boolean;
}
</file>

<file path="src/services/notifications/index.ts">
import { lunarToSolar } from '@/services/lunar';
import { LunarEvent } from '@/types/event';
import * as Notifications from 'expo-notifications';

// Configure notification handler
Notifications.setNotificationHandler({
    handleNotification: async () => ({
        shouldShowAlert: true,
        shouldPlaySound: true,
        shouldSetBadge: true,
        shouldShowBanner: true,
        shouldShowList: true,
    }),
});

/**
 * Request notification permissions
 */
export async function requestNotificationPermissions(): Promise<boolean> {
    const { status: existingStatus } = await Notifications.getPermissionsAsync();

    let finalStatus = existingStatus;
    if (existingStatus !== 'granted') {
        const { status } = await Notifications.requestPermissionsAsync();
        finalStatus = status;
    }

    return finalStatus === 'granted';
}

/**
 * Schedule a notification for a lunar event
 */
export async function scheduleEventNotification(
    event: LunarEvent
): Promise<string | undefined> {
    const hasPermission = await requestNotificationPermissions();
    if (!hasPermission) return undefined;

    // Calculate next occurrence solar date
    const currentYear = new Date().getFullYear();
    const targetYear = event.lunarYear ?? currentYear;

    let solar = lunarToSolar(
        event.lunarDay,
        event.lunarMonth,
        targetYear,
        event.isLeapMonth
    );

    // If date has passed this year, schedule for next year
    const solarDate = new Date(solar.year, solar.month - 1, solar.day);
    if (solarDate < new Date()) {
        solar = lunarToSolar(
            event.lunarDay,
            event.lunarMonth,
            targetYear + 1,
            event.isLeapMonth
        );
    }

    // Calculate trigger date (days before)
    const triggerDate = new Date(solar.year, solar.month - 1, solar.day);
    triggerDate.setDate(triggerDate.getDate() - event.reminderDaysBefore);

    // Set reminder time
    const [hours, minutes] = event.reminderTime.split(':').map(Number);
    triggerDate.setHours(hours, minutes, 0, 0);

    // Don't schedule if trigger date is in the past
    if (triggerDate <= new Date()) {
        return undefined;
    }

    // Schedule the notification
    const notificationId = await Notifications.scheduleNotificationAsync({
        content: {
            title: event.type === 'gio' ? `🕯️ Ngày Giỗ: ${event.title}` : event.title,
            body: getNotificationBody(event),
            data: { eventId: event.id },
            sound: true,
            badge: 1,
        },
        trigger: {
            type: Notifications.SchedulableTriggerInputTypes.DATE,
            date: triggerDate,
        },
    });

    return notificationId;
}

/**
 * Cancel a scheduled notification
 */
export async function cancelNotification(notificationId: string): Promise<void> {
    await Notifications.cancelScheduledNotificationAsync(notificationId);
}

/**
 * Cancel all scheduled notifications
 */
export async function cancelAllNotifications(): Promise<void> {
    await Notifications.cancelAllScheduledNotificationsAsync();
}

/**
 * Get notification body text
 */
function getNotificationBody(event: LunarEvent): string {
    const daysText =
        event.reminderDaysBefore === 0
            ? 'hôm nay'
            : event.reminderDaysBefore === 1
                ? 'ngày mai'
                : `còn ${event.reminderDaysBefore} ngày`;

    const dateText = `${event.lunarDay}/${event.lunarMonth} âm lịch`;

    if (event.type === 'gio') {
        return `Ngày giỗ ${daysText} (${dateText})`;
    }

    return `Sự kiện ${daysText} (${dateText})`;
}
</file>

<file path="src/services/dataService.ts">
import { useEventsStore } from '@/stores/eventStore';
import { useSettingsStore } from '@/stores/settingsStore';
import * as DocumentPicker from 'expo-document-picker';
import { File, Paths } from 'expo-file-system';
import * as Sharing from 'expo-sharing';
import { Alert } from 'react-native';

export async function exportData() {
    try {
        const events = useEventsStore.getState().events;
        const settings = useSettingsStore.getState();

        // We only want to export some settings, not the functions
        const settingsToExport = {
            showLunarDates: settings.showLunarDates,
            showAuspiciousHours: settings.showAuspiciousHours,
            reminderDaysBefore: settings.reminderDaysBefore,
            reminderTime: settings.reminderTime,
        };

        const data = {
            version: '1.0.0',
            exportedAt: new Date().toISOString(),
            events,
            settings: settingsToExport,
        };

        const fileName = `lich_viet_backup_${new Date().toISOString().split('T')[0]}.json`;
        // New API for Expo FileSystem 19+
        const file = new File(Paths.cache, fileName);

        await file.write(JSON.stringify(data, null, 2));

        if (await Sharing.isAvailableAsync()) {
            await Sharing.shareAsync(file.uri, {
                mimeType: 'application/json',
                dialogTitle: 'Xuất dữ liệu Lịch Việt',
                UTI: 'public.json',
            });
        } else {
            Alert.alert('Lỗi', 'Tính năng chia sẻ không khả dụng trên thiết bị này');
        }
    } catch (error) {
        console.error('Export error:', error);
        Alert.alert('Lỗi', 'Không thể xuất dữ liệu');
    }
}

export async function importData() {
    try {
        const result = await DocumentPicker.getDocumentAsync({
            type: 'application/json',
            copyToCacheDirectory: true,
        });

        if (result.canceled) return;

        // New API for Expo FileSystem 19+
        const file = new File(result.assets[0].uri);
        const fileContent = await file.text();
        const data = JSON.parse(fileContent);

        // Basic validation
        if (!data.events || !Array.isArray(data.events)) {
            throw new Error('Định dạng file không hợp lệ');
        }

        Alert.alert(
            'Xác nhận',
            `Bạn có muốn nhập ${data.events.length} sự kiện và cài đặt từ file này? Dữ liệu hiện tại sẽ bị thay thế.`,
            [
                { text: 'Hủy', style: 'cancel' },
                {
                    text: 'Nhập',
                    style: 'destructive',
                    onPress: async () => {
                        // Update stores
                        await useEventsStore.getState().importEvents(data.events);

                        if (data.settings) {
                            const settingsStore = useSettingsStore.getState();
                            if (data.settings.showLunarDates !== undefined) settingsStore.setShowLunarDates(data.settings.showLunarDates);
                            if (data.settings.showAuspiciousHours !== undefined) settingsStore.setShowAuspiciousHours(data.settings.showAuspiciousHours);
                            if (data.settings.reminderDaysBefore !== undefined) settingsStore.setReminderDaysBefore(data.settings.reminderDaysBefore);
                            if (data.settings.reminderTime !== undefined) settingsStore.setReminderTime(data.settings.reminderTime);
                        }

                        Alert.alert('Thành công', 'Đã nhập dữ liệu thành công');
                    },
                },
            ]
        );
    } catch (error) {
        console.error('Import error:', error);
        Alert.alert('Lỗi', 'Không thể nhập dữ liệu. Vui lòng kiểm tra định dạng file.');
    }
}
</file>

<file path="src/stores/eventStore.ts">
import { cancelNotification, scheduleEventNotification } from '@/services/notifications';
import { EventFormData, LunarEvent } from '@/types/event';
import { create } from 'zustand';
import { createJSONStorage, persist } from 'zustand/middleware';
import { mmkvStorage } from './storage';

interface EventState {
    events: LunarEvent[];

    addEvent: (data: EventFormData) => Promise<LunarEvent>;
    updateEvent: (id: string, data: Partial<EventFormData>) => Promise<void>;
    deleteEvent: (id: string) => Promise<void>;
    getEventsForLunarDate: (lunarDay: number, lunarMonth: number) => LunarEvent[];
    getEventsForMonth: (lunarMonth: number) => LunarEvent[];
    importEvents: (events: LunarEvent[]) => Promise<void>;
}

export const useEventsStore = create<EventState>()(
    persist(
        (set, get) => ({
            events: [],

            addEvent: async (data: EventFormData) => {
                const id = `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const now = new Date().toISOString();

                const event: LunarEvent = {
                    ...data,
                    id,
                    createdAt: now,
                    updatedAt: now,
                };

                // Schedule notification if enabled
                if (data.reminderEnabled) {
                    const notificationId = await scheduleEventNotification(event);
                    event.notificationId = notificationId;
                }

                set((state) => ({
                    events: [...state.events, event],
                }));

                return event;
            },

            updateEvent: async (id: string, data: Partial<EventFormData>) => {
                const events = get().events;
                const existingEvent = events.find((e) => e.id === id);

                if (!existingEvent) return;

                // Cancel existing notification
                if (existingEvent.notificationId) {
                    await cancelNotification(existingEvent.notificationId);
                }

                const updatedEvent: LunarEvent = {
                    ...existingEvent,
                    ...data,
                    updatedAt: new Date().toISOString(),
                };

                // Reschedule notification if enabled
                if (updatedEvent.reminderEnabled) {
                    const notificationId = await scheduleEventNotification(updatedEvent);
                    updatedEvent.notificationId = notificationId;
                } else {
                    updatedEvent.notificationId = undefined;
                }

                set((state) => ({
                    events: state.events.map((e) => (e.id === id ? updatedEvent : e)),
                }));
            },

            deleteEvent: async (id: string) => {
                const event = get().events.find((e) => e.id === id);

                // Cancel notification
                if (event?.notificationId) {
                    await cancelNotification(event.notificationId);
                }

                set((state) => ({
                    events: state.events.filter((e) => e.id !== id),
                }));
            },

            getEventsForLunarDate: (lunarDay: number, lunarMonth: number) => {
                return get().events.filter(
                    (e) => e.lunarDay === lunarDay && e.lunarMonth === lunarMonth
                );
            },

            getEventsForMonth: (lunarMonth: number) => {
                return get().events.filter((e) => e.lunarMonth === lunarMonth);
            },

            importEvents: async (importedEvents: LunarEvent[]) => {
                const currentEvents = get().events;

                // Cancel all current notifications
                for (const event of currentEvents) {
                    if (event.notificationId) {
                        await cancelNotification(event.notificationId);
                    }
                }

                // Process imported events: reschedule notifications
                const processedEvents = [];
                for (const event of importedEvents) {
                    const newEvent = { ...event };
                    if (newEvent.reminderEnabled) {
                        try {
                            const notificationId = await scheduleEventNotification(newEvent);
                            newEvent.notificationId = notificationId;
                        } catch (error) {
                            console.error('Failed to reschedule notification during import:', error);
                        }
                    } else {
                        newEvent.notificationId = undefined;
                    }
                    processedEvents.push(newEvent);
                }

                set({ events: processedEvents });
            },
        }),
        {
            name: 'events-storage',
            storage: createJSONStorage(() => mmkvStorage),
        }
    )
);
</file>

<file path="src/stores/settingsStore.ts">
import { create } from 'zustand';
import { createJSONStorage, persist } from 'zustand/middleware';
import { mmkvStorage } from './storage';

interface SettingsState {
    showLunarDates: boolean;
    showAuspiciousHours: boolean;
    reminderDaysBefore: number;
    reminderTime: string; // "HH:mm"

    setShowLunarDates: (show: boolean) => void;
    setShowAuspiciousHours: (show: boolean) => void;
    setReminderDaysBefore: (days: number) => void;
    setReminderTime: (time: string) => void;
}

export const useSettingsStore = create<SettingsState>()(
    persist(
        (set) => ({
            showLunarDates: true,
            showAuspiciousHours: true,
            reminderDaysBefore: 1,
            reminderTime: '08:00',

            setShowLunarDates: (show) => set({ showLunarDates: show }),
            setShowAuspiciousHours: (show) => set({ showAuspiciousHours: show }),
            setReminderDaysBefore: (days) => set({ reminderDaysBefore: days }),
            setReminderTime: (time) => set({ reminderTime: time }),
        }),
        {
            name: 'settings-storage',
            storage: createJSONStorage(() => mmkvStorage),
        }
    )
);
</file>

<file path="src/stores/storage.ts">
import { MMKV } from 'react-native-mmkv';
import { StateStorage } from 'zustand/middleware';

export const storage = new MMKV({
    id: 'lich-viet-storage',
    // In production, we should use a secure key from Keychain/Keystore
    // encryptionKey: 'optional-encryption-key',
});

export const mmkvStorage: StateStorage = {
    getItem: (name: string): string | null => {
        const value = storage.getString(name);
        return value ?? null;
    },
    setItem: (name: string, value: string): void => {
        storage.set(name, value);
    },
    removeItem: (name: string): void => {
        storage.delete(name);
    },
};

export function initializeStorage(): void {
    // Migration logic if needed
    const version = storage.getNumber('version') ?? 0;
    if (version < 1) {
        // Initial setup
        storage.set('version', 1);
    }
}
</file>

<file path="src/types/event.ts">
export type EventType = 'gio' | 'holiday' | 'personal';

export interface LunarEvent {
    id: string;
    title: string;
    description?: string;
    lunarDay: number;
    lunarMonth: number;
    lunarYear?: number;         // undefined = recurring annually
    isLeapMonth: boolean;
    type: EventType;
    reminderEnabled: boolean;
    reminderDaysBefore: number;
    reminderTime: string;       // "HH:mm" format
    color?: string;
    notificationId?: string;    // expo-notifications identifier
    createdAt: string;
    updatedAt: string;
}

export interface EventFormData {
    title: string;
    description?: string;
    lunarDay: number;
    lunarMonth: number;
    lunarYear?: number;
    isLeapMonth: boolean;
    type: EventType;
    reminderEnabled: boolean;
    reminderDaysBefore: number;
    reminderTime: string;
    color?: string;
}
</file>

<file path="src/utils/accessibility.ts">
/**
 * Generate accessibility label for solar/lunar dates
 */
export function getLunarDateAccessibilityLabel(
    solarDay: number,
    solarMonth: number,
    solarYear: number,
    lunarDay: number,
    lunarMonth: number,
    lunarYear: number,
    isLeapMonth: boolean,
    holiday?: string
): string {
    const solarStr = `Ngày ${solarDay} tháng ${solarMonth} năm ${solarYear}`;
    const lunarStr = `Âm lịch ngày ${lunarDay} tháng ${lunarMonth}${isLeapMonth ? ' nhuận' : ''} năm ${lunarYear}`;
    const holidayStr = holiday ? `, hôm nay là ${holiday}` : '';

    return `${solarStr}, ${lunarStr}${holidayStr}`;
}

/**
 * Generate accessibility label for an auspicious hour
 */
export function getHourAccessibilityLabel(
    hourName: string,
    startTime: string,
    endTime: string,
    isAuspicious: boolean,
    star?: string
): string {
    const timeStr = `từ ${startTime} đến ${endTime}`;
    const statusStr = isAuspicious ? 'là giờ hoàng đạo' : 'là giờ hắc đạo';
    const starStr = star ? `, sao ${star}` : '';

    return `Giờ ${hourName}, ${timeStr}, ${statusStr}${starStr}`;
}
</file>

<file path=".eslintrc.js">
module.exports = {
    extends: 'expo',
};
</file>

<file path=".prettierrc">
{
  "bracketSpacing": true,
  "singleQuote": true,
  "trailingComma": "es5",
  "tabWidth": 2,
  "semi": true,
  "printWidth": 100
}
</file>

<file path="eas.json">
{
  "cli": {
    "version": ">= 16.32.0",
    "appVersionSource": "remote"
  },
  "build": {
    "development": {
      "developmentClient": true,
      "distribution": "internal"
    },
    "preview": {
      "distribution": "internal"
    },
    "production": {
      "autoIncrement": true
    }
  },
  "submit": {
    "production": {}
  }
}
</file>

<file path="README.md">
# Lịch Việt - Vietnamese Lunar Calendar

A React Native app for tracking Vietnamese lunar dates, events, and auspicious hours.

## Features

- 📅 **Lunar Calendar**: Accurate solar ↔ lunar date conversion
- 🐲 **Can-Chi System**: Traditional 60-year cycle display
- ⏰ **Auspicious Hours**: Lucky hours based on day's chi
- 🎉 **Vietnamese Holidays**: 13 major holidays + observances
- 🔔 **Smart Notifications**: Reminders for lunar date events
- 🌙 **Dark Mode**: Vietnamese cultural color theme

## Quick Start

```bash
# Install dependencies
npm install

# Start development server
npx expo start

# Run on iOS/Android
npx expo run:ios
npx expo run:android
```

## Tech Stack

| Category | Technology |
|----------|------------|
| Framework | Expo SDK 52, React Native 0.76.9 |
| Navigation | Expo Router 4.0 |
| State | Zustand 5.0 + MMKV 3.3 |
| Calendar | react-native-calendars |
| Notifications | expo-notifications |
| Language | TypeScript 5.8 (strict) |

## Project Structure

```
src/
├── app/              # Expo Router pages
├── components/       # UI components
├── services/lunar/   # Calendar algorithms
├── stores/           # Zustand state
├── hooks/            # Custom hooks
├── constants/        # Theme, holidays
└── types/            # TypeScript interfaces
```

## Documentation

- [Project Overview & PDR](docs/project-overview-pdr.md)
- [Codebase Summary](docs/codebase-summary.md)
- [Code Standards](docs/code-standards.md)
- [System Architecture](docs/system-architecture.md)

## License

MIT
</file>

<file path=".gitignore">
# Learn more https://docs.github.com/en/get-started/getting-started-with-git/ignoring-files

# dependencies
node_modules/

# Expo
.expo/
dist/
web-build/
expo-env.d.ts

# Native
.kotlin/
*.orig.*
*.jks
*.p8
*.p12
*.key
*.mobileprovision

# Metro
.metro-health-check*

# debug
npm-debug.*
yarn-debug.*
yarn-error.*

# macOS
.DS_Store
*.pem

# local env files
.env*.local

# typescript
*.tsbuildinfo

# generated native folders
/ios
/android
</file>

<file path="app.json">
{
  "expo": {
    "name": "Lịch Việt",
    "slug": "lich-viet",
    "version": "1.0.0",
    "orientation": "portrait",
    "icon": "./src/assets/images/icon.png",
    "scheme": "lichviet",
    "userInterfaceStyle": "automatic",
    "newArchEnabled": true,
    "splash": {
      "image": "./src/assets/images/splash-icon.png",
      "resizeMode": "contain",
      "backgroundColor": "#ffffff"
    },
    "ios": {
      "supportsTablet": true,
      "bundleIdentifier": "com.monorepo.lichviet",
      "infoPlist": {
        "UIBackgroundModes": [
          "fetch",
          "remote-notification",
          "fetch",
          "remote-notification"
        ],
        "ITSAppUsesNonExemptEncryption": false
      }
    },
    "android": {
      "adaptiveIcon": {
        "foregroundImage": "./src/assets/images/adaptive-icon.png",
        "backgroundColor": "#ffffff"
      },
      "package": "com.monorepo.lichviet",
      "edgeToEdgeEnabled": true,
      "predictiveBackGestureEnabled": false
    },
    "web": {
      "bundler": "metro",
      "output": "static",
      "favicon": "./src/assets/images/favicon.png"
    },
    "plugins": [
      "expo-router",
      [
        "expo-notifications",
        {
          "sounds": [
            "./src/assets/sounds/notification.wav"
          ]
        }
      ]
    ],
    "experiments": {
      "typedRoutes": true
    },
    "extra": {
      "router": {},
      "eas": {
        "projectId": "41791850-781f-4f94-a596-0a3f05e58d79"
      }
    }
  }
}
</file>

<file path="package.json">
{
  "name": "calendar-app",
  "main": "expo-router/entry",
  "version": "1.0.0",
  "scripts": {
    "start": "expo start",
    "android": "expo run:android",
    "ios": "expo run:ios",
    "web": "expo start --web",
    "lint": "eslint . --ext .js,.jsx,.ts,.tsx",
    "format": "prettier --write ."
  },
  "dependencies": {
    "@expo/vector-icons": "~14.0.4",
    "@react-native-picker/picker": "2.9.0",
    "@react-navigation/native": "^7.1.6",
    "expo": "^52.0.0",
    "expo-constants": "~17.0.8",
    "expo-dev-client": "~5.0.20",
    "expo-document-picker": "~13.0.3",
    "expo-file-system": "~18.0.12",
    "expo-font": "~13.0.4",
    "expo-linking": "~7.0.5",
    "expo-notifications": "~0.29.14",
    "expo-router": "~4.0.22",
    "expo-sharing": "~13.0.1",
    "expo-splash-screen": "~0.29.24",
    "expo-status-bar": "~2.0.1",
    "expo-web-browser": "~14.0.2",
    "react": "18.3.1",
    "react-dom": "18.3.1",
    "react-native": "0.76.9",
    "react-native-calendars": "^1.1314.0",
    "react-native-mmkv": "^3.3.3",
    "react-native-reanimated": "~3.16.1",
    "react-native-safe-area-context": "4.12.0",
    "react-native-screens": "~4.4.0",
    "react-native-web": "~0.19.13",
    "zustand": "^5.0.11"
  },
  "devDependencies": {
    "@types/react": "~18.3.12",
    "@typescript-eslint/eslint-plugin": "^8.54.0",
    "@typescript-eslint/parser": "^8.54.0",
    "eslint-config-prettier": "^10.1.8",
    "eslint-plugin-react-hooks": "^7.0.1",
    "prettier": "^3.8.1",
    "react-test-renderer": "18.3.1",
    "typescript": "~5.8.3"
  },
  "private": true
}
</file>

<file path="tsconfig.json">
{
  "extends": "expo/tsconfig.base",
  "compilerOptions": {
    "strict": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": [
    "**/*.ts",
    "**/*.tsx",
    ".expo/types/**/*.ts",
    "expo-env.d.ts"
  ]
}
</file>

</files>
